---
title: "USC Predict COVID Project: \n Predictive Epidemic Model for COVID-19 in Los Angeles County"
author: "University of Southern California Department of Preventive Medicine"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

Updated with data available as of `r Sys.Date()`

``` {r setup, include=FALSE}

### Install necessary packages and get started

library(reshape2)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggrepel)
library(bindata)
library(odin)
library(fitR)
library(knitr)
library(EasyABC)
library(gridExtra)
library(odin)
library(lubridate)
library(EasyABC)
library(gridExtra)
library(kableExtra)
library(plyr)
library(dplyr)
library(data.table)
library(scales)
library(EasyABC)
library(patchwork)

library(tidyr)
library(readr)
library(purrr)
library(tibble)
library(stringr)
library(forcats)
library(network)
library(tidygraph)
library(ggraph)
library(visNetwork)
library(networkD3)
library(ggmosaic)
library(formattable)
library(DT)
library(reshape)
library(here)

library(MASS)
library(plotly)

lang_output <- function(x, lang) {
  cat(c(sprintf("```%s", lang), x, "```"), sep = "\n")
}
r_output <- function(x) lang_output(x, "r")

knitr::opts_chunk$set(
  fig.width = 9,
  fig.height = 7,
  echo=FALSE,
  warning=FALSE,
  cache=TRUE,
  message=FALSE)


code.dir=here("code/")
data.dir=here("data/")
result.dir = here("results/")
```

<br>

# Aims

The USC Predict COVID project is using an epidemic model to estimate the impact of COVID-19 in Los Angeles County

* We are addressing the key questions of:
  - When will the peak of the epidemic occur and how will it impact health care capacity?
  - What happens to the dynamics of the epidemic when social distancing ends? 
  - How will the epidemic affect different at-risk groups?

* Critical healthcare variables predicted by the model are the counts of the numbers of individuals over time, including the peak occurrence, for the following:
  - The total number of infected cases including both the number detected and observed with testing and the undetected/untested cases
  - The total number of individuals hospitalized (including those in the ICU)
  - The number of patients in the ICU
  - The number of patients on ventilators
  - The number of deaths

* We estimate a number of key epidemic parameters, including:
  - $R0$,  the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
  - $r$,  the proportion of illnesses that are detected and reported out of all illnesses. In this document we will consider that a prior for $r$ can be directly informed by seroprevalence studies.
  - $Frac_{R0}$,  the factor reduction in the initial R0 due to social distancing
  - $Pr(Hospital | Illness)$,  the probability of hospitalization given illness
  - $Pr(Ventilation | ICU)$,  the probability of ICU care necessary given hospitalization
  - $p_v$,  the probability of ventilation given ICU care 
  - $Pr(Death | ICU)$,  the probability of death given ICU care

* We provide projections of illness severity trajectories in L.A. County as a whole and for race/ethnicity groups, based on prevalence of known COVID-19 risk factors.
* We provide predictions for the impact on counts and corresponding time periods under various **social distancing scenarios** in which restrictions are eased.


```{r calc-risk-probs, include=FALSE, eval=TRUE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

calc_risk_probs_code <- path(code.dir, "calc_risk_probs_042220.R")
#r_output(readLines(calc_risk_probs_code))
#source(calc_risk_probs_code)
#
#Alpha.prior.mean <- risk.probs.SPAs[9,1] # 0.17
#Kappa.prior.mean <- risk.probs.SPAs[9,2] # 0.3
#Delta.prior.mean <- risk.probs.SPAs[9,3]

```


```{r read-in-current-COVID-data, include=FALSE}

###################################################################################################
## COVID INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

#obs_cum_new_counts = t(read.csv(path(data.dir, "cum_counts_042420.csv"), sep=",",stringsAsFactors = FALSE))
#obs_cum_new_counts = t(read.csv(path(data.dir, "cum_counts_I_new_042820.csv"), sep=",",stringsAsFactors = FALSE))
obs_cum_new_counts = t(read.csv(path(data.dir, "cum_counts_051120.csv"), sep=",",stringsAsFactors = FALSE))
import.date <- as.Date("2020-05-06")

#colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","I_new","V_new","H_capacity","Q_capacity", "V_free", "Q_free")

nvars <- ncol(obs_cum_new_counts)
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:nvars] <- sapply(obs_cum_new_counts[1:nvars],as.character)
obs_cum_new_counts[1:nvars] <- sapply(obs_cum_new_counts[1:nvars],as.numeric)
no_obs <- nrow(obs_cum_new_counts)

step <- c(1:no_obs)
obs.shift <- cbind(step,obs_cum_new_counts)
data = obs.shift

## DATA FORMAT FOR PLOTTING (BELOW)
data.in.tmp.orig <- obs_cum_new_counts %>% dplyr::select(-c(H_capacity,Q_capacity,V_free,Q_free))

```

```{r SNF-data-frac-calc, include=FALSE}

### READ IN SNF DATA AND CALCULATE FRACTIONS COMPOSED OF THIS GROUP

NH_counts = t(read.csv(path(data.dir, "SNF_051120.csv"), sep=",",stringsAsFactors = FALSE))


NH_counts <- as.data.frame(NH_counts)
NH_counts <- NH_counts[-1,]
colnames(NH_counts) <-c("I_staff_cum","I_resident_cum","D_resident_cum")
nvars <- ncol(NH_counts)
NH_counts[1:nvars] <- sapply(NH_counts[1:nvars],as.character)
NH_counts[1:nvars] <- sapply(NH_counts[1:nvars],as.numeric)
no_obs_NH <- nrow(NH_counts)

step <- c(1:no_obs_NH)
obs.shift <- cbind(step,NH_counts)
data_NH = obs.shift

### Function to exponentially interpolate counts coming from SNF and remove that fraction from LA cases
NH_frac <- function(NH.rm.start.date,no_obs,NH.var.to.modify,input.NH.dates, full.data.in,var.to.modify){
  date.var.equals.1 <- as.Date(NH.rm.start.date)
  assume.first.NH.date <- as.numeric(date.var.equals.1 - as.Date("2020-03-01")) 
  
  #num.NH.dates <- length(NH.var.to.modify)

  NH.interpolate.t <- c(assume.first.NH.date,input.NH.dates)
  NH.interpolate.y <- c(1, NH.var.to.modify)
  
  interpolate_NH <- spline(x=NH.interpolate.t, y=log(NH.interpolate.y), n = input.NH.dates[length(input.NH.dates)]-assume.first.NH.date+1, method="natural")
  interpolate_NH$y <- exp(interpolate_NH$y)
  
  #plot(interpolate_NH$x, (interpolate_NH$y), type ="o")
  
  NH_dates <- c(1:no_obs)
  NH.counts <- rep(0,no_obs)
  NH.counts[interpolate_NH$x] <- round(interpolate_NH$y)
  
  modify.var <- full.data.in[,var.to.modify]
  #modify.var <- as.numeric(select(full.data.in, var.to.modify))
  frac_NH <- NH.counts/modify.var
  frac_NH[is.nan(frac_NH)]<-0
  
  last.NH.date <- input.NH.dates[length(input.NH.dates)]
  if(last.NH.date < no_obs){
    frac_NH[c( (last.NH.date+1) : no_obs)] = rep(frac_NH[last.NH.date], times = length(frac_NH[c( (last.NH.date+1) : no_obs)])  )
  }
  return(frac_NH)
}

###########################################################################
## INTERPOLATE AND MODIFY I, H, V, D TO MODIFY CUMULATIVE AND NEW COUNTS UPDATED WITH NH CASES REMOVED

### NEED TO UPDATE THE NUMBER OF INPUT DATES IF WE GET MORE SNF COUNTS
# date.1<-as.numeric(as.Date("2020-04-17") - as.Date("2020-03-01"))
# date.2<-as.numeric(as.Date("2020-04-29") - as.Date("2020-03-01"))
# date.3<-as.numeric(as.Date("2020-04-30") - as.Date("2020-03-01"))

date.i<-as.numeric(as.Date("2020-04-21") - as.Date("2020-03-01")) 
#date.f<-as.numeric(import.date - as.Date("2020-03-01"))

### MODIFY I
NH.var.to.modify <- (NH_counts[[1]] + NH_counts[[2]])
input.NH.dates <- c(1:length(NH.var.to.modify)) + date.i

NH.rm.start.date=as.Date("2020-03-20")

frac_NH_I <- NH_frac(NH.rm.start.date=NH.rm.start.date, no_obs=no_obs, NH.var.to.modify=NH.var.to.modify, input.NH.dates=input.NH.dates, 
                          full.data.in = data.in.tmp.orig, var.to.modify = "Idetectcum")
plot(x=(1:length(frac_NH_I)), y=frac_NH_I)

### MODIFY H
### Assume 0.4 I lead to H
#NH.var.to.modify <- 0.4*(NH_counts[[1]] + NH_counts[[2]])
NH.var.to.modify <- 1.5*(NH_counts[[3]])
#input.NH.dates <- c( date.1,date.2,date.3)
NH.rm.start.date= NH.rm.start.date+10 #"2020-03-25"

frac_NH_H <- NH_frac(NH.rm.start.date=NH.rm.start.date, no_obs=no_obs, NH.var.to.modify=NH.var.to.modify, input.NH.dates=input.NH.dates, 
                          full.data.in = data.in.tmp.orig, var.to.modify = "Htotcum")
plot(x=(1:length(frac_NH_H)), y=frac_NH_H)

### MODIFY V
### Assume 0.45 H lead to Q and 0.4 Q lead to V
#NH.var.to.modify <- (.45*.4)*(0.4)*(NH_counts[[1]] + NH_counts[[2]])
NH.var.to.modify <- 0.7*(NH_counts[[3]])
#input.NH.dates <- c( date.1,date.2,date.3)
NH.rm.start.date= NH.rm.start.date+2   #"2020-03-27"
frac_NH_V <- NH_frac(NH.rm.start.date=NH.rm.start.date, no_obs=no_obs, NH.var.to.modify=NH.var.to.modify, input.NH.dates=input.NH.dates, 
                          full.data.in = data.in.tmp.orig, var.to.modify = "Vcum")
plot(x=(1:length(frac_NH_V)), y=frac_NH_V)

### MODIFY D
NH.var.to.modify <- NH_counts$D_resident_cum
#input.NH.dates <- c(date.2,date.3)
NH.rm.start.date= NH.rm.start.date+10 #"2020-04-05"

frac_NH_D <- NH_frac(NH.rm.start.date=NH.rm.start.date, no_obs=no_obs, NH.var.to.modify=NH.var.to.modify, input.NH.dates=input.NH.dates, 
                          full.data.in = data.in.tmp.orig, var.to.modify = "D")
plot(x=(1:length(frac_NH_D)), y=frac_NH_D)


```


```{r SNF-remove-vals, include=FALSE}

###########################################################################
## GET CUMULATIVE AND NEW COUNTS UPDATED WITH NH CASES REMOVED

cum_new_NH_fn <- function(no_obs, cum_orig, frac_NH){
  ### REMOVE ESTIMATED FRACTION OF NH CASES
  cum_NH <- round(cum_orig * (1-frac_NH))
  
  ### COUNT NEW CASES FROM CUM CASES
  new_NH <- rep(0,no_obs)
  new_NH[1]<-cum_NH[1]
  for (i in 2:length(cum_NH)){
    new_NH[i]<-cum_NH[i]-cum_NH[i-1]
  }
  
  ### REMOVE NEGATIVES IF EXIST
  if(any(new_NH<0)){
    ### (1) MAKE SURE THERE ARE NO NEGATIVES IN THE NEW CASES
    for (i in 1:no_obs){
      if (new_NH[i]!=0){
        new_NH[i] <- max(new_NH[i],1)
      }
    }
    ### (2) RECOUNT CUMCOUNTS 
    cum.recount <- cum_NH
    for (i in 2:no_obs){
      cum.recount[i] <- cum.recount[i-1] + new_NH[i]
    }
    cum_NH <- cum.recount
  }
  
  return(data.frame(cbind(cum_NH, new_NH)))
}

### I NEW AND CUM
cum_orig <- data.in.tmp.orig$Idetectcum
frac_NH <- frac_NH_I
cases_cum_new <- cum_new_NH_fn(no_obs=no_obs, cum_orig=cum_orig, frac_NH=frac_NH)
Idetectcum <- cases_cum_new[,1]
I_detect_new <- cases_cum_new[,2]

### H NEW AND CUM
cum_orig <- data.in.tmp.orig$Htotcum
frac_NH <- frac_NH_H
cases_cum_new <- cum_new_NH_fn(no_obs=no_obs, cum_orig=cum_orig, frac_NH=frac_NH)
Htotcum <- cases_cum_new[,1]
H_new <- cases_cum_new[,2]

### V NEW AND CUM
cum_orig <- data.in.tmp.orig$Vcum
frac_NH <- frac_NH_V
cases_cum_new <- cum_new_NH_fn(no_obs=no_obs, cum_orig=cum_orig, frac_NH=frac_NH)
Vcum <- cases_cum_new[,1]
V_new <- cases_cum_new[,2]

### D NEW AND CUM
cum_orig <- data.in.tmp.orig$D
frac_NH <- frac_NH_D
cases_cum_new <- cum_new_NH_fn(no_obs=no_obs, cum_orig=cum_orig, frac_NH=frac_NH)
D <- cases_cum_new[,1]
D_new <- cases_cum_new[,2]

### JOIN ALL IN A DATA FRAME
cum_counts_NH_update <- as.data.frame(cbind(Htotcum, D, Vcum, Idetectcum, H_new, D_new, I_detect_new, V_new))


```

```{r plot-SNF-removed, include=FALSE}

### PLOT SNF REMOVED CUM COUNTS AGAINST ORIGINAL CUM COUNTS

plot.NH.removed <- function(no_obs, cum_orig, cum_NH, name.cum_orig, name.cum_NH,name.title){
  x = seq(as.Date("2020-03-01"), by = "day", length.out = no_obs)
  df1 <- data.frame(date = x,counts = cum_orig)
  df2 <- data.frame(date = x,counts = cum_NH)
  df4 <- data.frame(date = x,counts = cum_orig-cum_NH)
  
  df3 <- df1 %>%  mutate(Type = name.cum_orig) %>%
    bind_rows(df2 %>% mutate(Type = name.cum_NH)) %>% 
    bind_rows(df4 %>% mutate(Type = "SNF estimated"))
  
  p<- ggplot(df3,aes(y = counts,x = date,color = Type)) + 
    geom_line() +
    ggtitle(name.title) 
}

### I NEW AND CUM
cum_orig <- data.in.tmp.orig$Idetectcum
cum_NH <- Idetectcum
name.cum_orig <- 'Cumul. Infected'
name.cum_NH <- 'Cumul. Infected NH Removed'
name.title <- "Cumulative Infected (Observed)"
p.I <- plot.NH.removed(no_obs=no_obs, cum_orig=cum_orig, cum_NH=cum_NH, name.cum_orig=name.cum_orig, name.cum_NH=name.cum_NH,name.title=name.title)

### H NEW AND CUM
cum_orig <- data.in.tmp.orig$Htotcum
cum_NH <- Htotcum
name.cum_orig <- 'Cumul. Hospital'
name.cum_NH <- 'Cumul. Hospital NH Removed'
name.title <- "Cumulative Hospitalized"
p.H <- plot.NH.removed(no_obs=no_obs, cum_orig=cum_orig, cum_NH=cum_NH, name.cum_orig=name.cum_orig, name.cum_NH=name.cum_NH,name.title=name.title)

### V NEW AND CUM
cum_orig <- data.in.tmp.orig$Vcum
cum_NH <- Vcum
name.cum_orig <- 'Cumul. Ventilations'
name.cum_NH <- 'Cumul. Ventilations NH Removed'
name.title <- "Cumulative Ventilations"
p.V <- plot.NH.removed(no_obs=no_obs, cum_orig=cum_orig, cum_NH=cum_NH, name.cum_orig=name.cum_orig, name.cum_NH=name.cum_NH,name.title=name.title)

### D NEW AND CUM
cum_orig <- data.in.tmp.orig$D
cum_NH <- D
name.cum_orig <- 'Cumul. Deaths'
name.cum_NH <- 'Cumul. Deaths NH Removed'
name.title <- "Cumulative Deaths"
p.D <- plot.NH.removed(no_obs=no_obs, cum_orig=cum_orig, cum_NH=cum_NH, name.cum_orig=name.cum_orig, name.cum_NH=name.cum_NH,name.title=name.title)

```


```{r read-in-model-supporting-functions, include=FALSE}

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- path(code.dir, "stochastic_SEIHQDR_A.R")
r_output(readLines(path_seihqdr_model))

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

###################################################################################################
## READ IN REQUIRED FUNCTIONS

supporting_functions <- path(code.dir, "supporting_functions_Recovered.R")
r_output(readLines(supporting_functions))
source(supporting_functions)

# FUNCTIONS INCLUDED:

## FOR ABC
### sum.stats: A function specifying the data to COVID-19 data to fit the model to
### model.1sim.stats: A function implementing the model to be simulated

## FUNCTIONS FOR GENERATING PROJECTIONS
### correlated.param: SPECIFYING EPIDEMIC MODEL TO BE SIMULATED AND SCENARIOS
### model.output.to.plot: ETTING MODEL OUTPUT + SUMMARY STATISTICS FUNCTION

## TABLE GENERATING FUNCTIONS

## PLOTTING FUNCTIONS
### plot.model.data.all: PLOTTING ALL FACETED FUNCTION
### plot.model.single: PLOTTING ONE AT A TIME FUNCTION INCLUDING SCENARIO SPECIFICATIONS

```



```{r bringing-in-Recovered, include=FALSE}

### Step 1: Calculate frac. Recovered from the prior bounds of r, fraction observed illnesses

## The equations informing Step 1
#frac.obs <- obs.R / total.R
#total.R <- obs.R / frac.obs
#frac.R <- obs.R / (frac.obs * pop.size)

## Inputs
pop.size <- 1e7
frac.obs <- c(0.02,0.04) # Best estimate from model
#frac.obs <- c(0.0002,0.0125)
# Dates 1 to 3 weeks before seroprevalence study
sero.date <- as.Date("2020-04-05")
whatis.1to3weeks.before.sero <- c(sero.date-21,sero.date-7)
whatis.1to3weeks.before.sero <- as.numeric(whatis.1to3weeks.before.sero - as.Date("2020-03-01"))
obs.R <- cum_counts_NH_update$Idetectcum[whatis.1to3weeks.before.sero]
#obs.R

## Output: frac. Recovered cases at point of serological study
frac.R.1 <- obs.R / (frac.obs[1] * pop.size)
frac.R.2 <- obs.R / (frac.obs[2] * pop.size)
frac.R.min <- min(frac.R.1,frac.R.2)
frac.R.max <- max(frac.R.1,frac.R.2)
frac.R.mean <- (frac.R.min+frac.R.max)/2
# frac.R.min <- min(frac.R.1)
# frac.R.max <- max(frac.R.2)
# frac.R.mean <- (frac.R.min + frac.R.max)/2
frac.R.mean
### Step 2: Interpolating time series for number Recovered from frac. Recovered 
###         and assumption of 1st Recovered case 2 weeks after 1st Infected case

## Date of first recovered
# Start time of outbreak --> first infection (in days before March 1st 2020)
start_time_for_interpolate = 45
# Choose the amount of recovery time (14 days)
days_to_assume_recovery = 14

start.interpolate <-  -start_time_for_interpolate+days_to_assume_recovery 
end.interpolate <- as.numeric(as.Date("2020-04-05") - as.Date("2020-03-01"))
n.interpolate <- end.interpolate - start.interpolate +1

# Input from Step 1
Recovered.data.point <- frac.R.mean*pop.size  #0.0002 * 1e7 #0.04 * 1e7
#Recovered.data.point <- .04 *pop.size  #0.0002 * 1e7 #0.04 * 1e7

# Interpolation
int.t <- c(start.interpolate,end.interpolate)
int.y <- c(1,Recovered.data.point)

interpolate_Recovered <- spline(x=int.t, y=(int.y)^(.5), n=n.interpolate, method="natural")
interpolate_Recovered$y <- (interpolate_Recovered$y)^2
#plot(interpolate_Recovered$x, (interpolate_Recovered$y), type ="o")

# Save only values from timestep 0 (i.e. from March 1 2020) onwards
interpolated.R <- as.data.frame(interpolate_Recovered) %>% filter(x>0)
interpolated.R <- as.numeric(interpolated.R$y)

```

```{r setup-ABC}

###################################################################################################
## SUMMARY STATISTICS COMPUTED ON DATA
data.in.tmp <- cum_counts_NH_update %>% select(-c(V_new))
no_obs <- nrow(data.in.tmp)

summarydata <- sum.stats.SIMTEST(data.in.tmp,include.R = FALSE)
summarydata.no.R <- summarydata

# Add interpolated number Recovered onto summary data
summarydata.yes.R <- c(summarydata,interpolated.R)


###################################################################################################
## DEFINING PRIORS
iter = 500
R0 <- 4 #3.25
r <- 0.03 #0.05
start_time <- 45
R0_redux <- .25 #.2  #Br(t)=Br*R0_redux
Delta <- .55 #.75
Alpha <- .18#.2
Kappa <- .35 #.25
p_V <- .5#.7
intervention_date="2020-03-12"

ABC.out.mat <- as.data.frame(t(rep(0,8)))
ABC.out.mat[1] <- R0
ABC.out.mat[2] <- r
ABC.out.mat[3] <- start_time
ABC.out.mat[4] <- R0_redux
ABC.out.mat[5] <- Delta
ABC.out.mat[6] <- Alpha
ABC.out.mat[7] <- Kappa
ABC.out.mat[8] <- p_V

###################################################################################################
## APPLY ABC 
###################################################################################################

###################################################################################################
## PRIOR DISTRIBUTIONS
## A list joining the prior for each parameter
prior.R0 <- c("normal",R0,.05) 
#prior.r <- c("unif", .005, .035) # c("normal",r,0.01)
prior.st <- c("unif",40,50) 
prior.R0.redux <- c("unif", R0_redux - 0.1, R0_redux + 0.1)  #c("normal",R0_redux, 0.05) 
prior.Delta <- c("normal",0.55,0.03) 
prior.Alpha <- c("normal",Alpha, 0.03) 
prior.Kappa <- c("normal",Kappa, 0.03)
prior.p_V <- c("unif", p_V-0.1, p_V+0.1 ) #c("normal",p_V, 0.08)

#prior.par <- list(prior.R0, prior.r,prior.st,prior.R0.redux,prior.Delta,prior.Alpha,prior.Kappa,prior.p_V)
intervention_date="2020-03-12"

## OTHER INPUTS
tolerance=c(15,4) # defining the sequence of tolerance levels 
#weights.vec <- c( rep(1,length(ss.I)), rep(5,length(ss.H)), rep(2,length(ss.V)), rep(5, length(ss.D)), rep(2,length(ss.Hnew)),rep(2,length(ss.Dnew))  )
```


```{r ABC.yes.R, include=FALSE}

###################################################################################################
## RUN ABC ALGORITHM (SOURCED FROM ABC_mcmc PACKAGE)

# Specifiying the prior for r to be close to sero study
#prior.r <- c("unif",0.00013,0.0125) #c("unif", .02, .036)  #c("unif", .017, .052) #  #c("unif", .028, .05) 
prior.r <- c("unif",0.02, 0.04)
#prior.r <- c("unif",0.0002,0.0125)
prior.par <- list(prior.R0, prior.r,prior.st,prior.R0.redux,prior.Delta,prior.Alpha,prior.Kappa,prior.p_V)

summarydata <- summarydata.yes.R
model.R <- model.1sim.stats.yes.R

# AA = 35
# BB = length(summarydata) - AA
# dist_weights = c(rep(1,BB), rep(1000,AA))

ABC_Marjoram<-ABC_mcmc(method="Marjoram",model=model.R,prior=prior.par,
                       summary_stat_target=summarydata, n_calibration=100000,
                       tolerance_quantile=0.1,verbose=TRUE,progress=TRUE, n_rec=1000) #, dist_weights=dist_weights )

ABC_out <- ABC_Marjoram

ABC.par.out <- as.data.frame(ABC_out$param)
ABC.out.mat <- ABC_out$param
ABC.out.mat.yesR <- ABC.out.mat

## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean) %>% mutate_if(is.numeric,round,digits=4)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd) %>% mutate_if(is.numeric,round,digits=4)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))
colnames(ABC.par.stats)<-c("R0","Prop. cases detected (r)","Start time", "Frac R0 Mar11", "Pr(Death|ICU)", "Pr(Hospital|Illness)", "Pr(ICU|Hospital)", "Pr(Ventilation|ICU)")
rownames(ABC.par.stats)<-c("mean","sd")
ABC.par.stats
#ABC.par.stats %>% round(ABC.par.stats,4)

###################################################################################################
## PLOTTING DENSITIES
out_R0<- as.data.frame(cbind(ABC_out$param[,1],ABC_out$weights))
out_r<- as.data.frame(cbind(ABC_out$param[,2],ABC_out$weights))
out_R0redux<- as.data.frame(cbind(ABC_out$param[,4],ABC_out$weights))

yesR.p.R0redux <- ggplot2::ggplot(out_R0redux, aes(V1)) + geom_density() + xlab("R0 Redux Posterior Distribution") + ggtitle("R0 Redux") 
yesR.p.R0 <- ggplot(out_R0, aes(V1)) + geom_density() + xlab("R0 Posterior Distribution") + ggtitle("R0") 
yesR.p.r <- ggplot(out_r, aes(V1)) + geom_density() + xlab("r Posterior Distribution") + ggtitle("r") 

#yesR.p.R0redux + yesR.p.R0 + yesR.p.r

den3d <- kde2d(ABC.out.mat[,1], ABC.out.mat[,2])
yesR.p.3d.R0.r <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.R0.r, title="R0 and r (fraction observed cases) joint posterior density")

den3d <- kde2d(ABC.out.mat[,1], ABC.out.mat[,4])
yesR.p.3d.R0.redux <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.R0.redux, title="R0 and R0_redux (R0 factor reduction) joint posterior density")

den3d <- kde2d(ABC.out.mat[,2], ABC.out.mat[,4])
yesR.p.3d.r.redux <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.r.redux, title="r (fraction observed cases) and R0_redux (R0 factor reduction) joint posterior density")

###################################################################################################
## PLOTTING ALL VARIABLE FITS

ABC.out.mat <- ABC_out$param[1:1000,]
par.vec.length <- 1000
iter <- 20
time.steps <- 400
vars.to.plot <- vars.plus.R

traj.0 <- model.output.to.plot.SIM(ABC.out.mat=ABC.out.mat, par.vec.length=par.vec.length, iter=iter, time.steps=time.steps, vars.to.plot = vars.to.plot, init.date.data="2020-03-01", all=TRUE, scenario.selection = 4,intervention_date=intervention_date,sd.redux=NULL)

time.steps.4.plot = 150
#data.in <- data.in.tmp
data.in <- data.in.tmp
vars.to.plot <- vars.plus.R
## Plot all

yesR.plot.all.variables.current.scenario.150days <- 
plot.model.data.all(traj.CI = traj.0, data.in = data.in, init.date.data = "2020-03-01", date.offset.4plot = 15, time.steps.4plot=time.steps.4.plot, 
                    vars.to.plot=vars.plus.R)

time.steps.4.plot = 300
#data.in <- data.in.tmp
data.in <- data.in.tmp
vars.to.plot <- vars.plus.R
## Plot all

yesR.plot.all.variables.current.scenario.300days <- 
plot.model.data.all(traj.CI = traj.0, data.in = data.in, init.date.data = "2020-03-01", date.offset.4plot = 15, time.steps.4plot=time.steps.4.plot, 
                    vars.to.plot=vars.plus.R)

###################################################################################################
## PLOTTING NUMBERS IN COMPARTMENTS 

var.to.plot <- "Htot"
scenario=0
intervention_date = intervention_date
sd.redux = NULL
use.title=NULL
plot.capacity=TRUE
ymax=NULL
time.steps.4plot = 250

yesR.p.H.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

var.to.plot <- "Q"
yesR.p.Q.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.Q.0)


var.to.plot <- "V"
yesR.p.V.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.V.0)

var.to.plot <- "D"
yesR.p.D.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.D.0)

var.to.plot <- "I"
yesR.p.I.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

var.to.plot <- "Itot"
yesR.p.Itot.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

```

# (1) Model projections

## (1.1) Projections Against Data {.tabset}

**Demonstrating model fit against COVID-19 data for Los Angeles, for the following variables/compartments:**

* New = new daily incidence
* Current = current census in compartment
* Cumulative = running total over time

**COVID-19 data is shown as black dots in the figures below.**

### Short time horizon
```{r, echo=FALSE}

yesR.plot.all.variables.current.scenario.150days

```

### Longer time horizon
```{r, echo=FALSE}

yesR.plot.all.variables.current.scenario.300days

```


{-}


## (1.2) Detailed Projections by Key Compartments {.tabset}

**Projections for key compartments:**

- Current census in Hosptial
- Current census in ICU
- Current census in Ventilation
- Cumulative deaths
- Current Illnesses: Observed
- Current Illnesses: Total (observed + unobserved)

### Current in Hospital
```{r, echo=FALSE}
ggplotly(yesR.p.H.0)

```

### Current in ICU
```{r, echo=FALSE}
ggplotly(yesR.p.Q.0)

```

### Current in Ventilation
```{r, echo=FALSE}
ggplotly(yesR.p.V.0)

```

### Cumulative Deaths
```{r, echo=FALSE}
ggplotly(yesR.p.D.0)

```

### Current Observed Illnesses
```{r, echo=FALSE}
ggplotly(yesR.p.I.0)

```

### Current Total Illnesses (Observed + Unobserved)
```{r, echo=FALSE}
ggplotly(yesR.p.Itot.0)

```
{-}











# (1.3) Projections for LA County and by SPA Given Risk Factors


```{r calc-risk-probs-initial, include=FALSE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

calc_risk_probs_code <- path(code.dir, "calc_risk_probs_042220.R")
r_output(readLines(calc_risk_probs_code))
source(calc_risk_probs_code)

Alpha.prior.mean <- risk.probs.SPAs[9,1] # 0.17
Kappa.prior.mean <- risk.probs.SPAs[9,2] # 0.3
Delta.prior.mean <- risk.probs.SPAs[9,3]

```


```{r load.data, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220

##import prevalence by profile
data <- as.data.frame(profile.cnt.SPAs)
dataH <- as.data.frame(H.profile.share.relative.all.SPAs)
dataQ <- as.data.frame(Q.profile.share.relative.all.SPAs)
dataD <- as.data.frame(D.profile.share.relative.all.SPAs)

#import the probability by profile
Pr.H <- Pr.H #Pr.H.orig
Pr.Q <- Pr.Q #Pr.Q.orig
Pr.D <- Pr.D #Pr.D.orig

SPA.data <- risk.probs.SPAs

# 
# # ## Data from estimated SEIR model (traj.CI.out) ##################################################
# # traj.CI.out <- traj.0
# 

### Data from estimated SEIR model (traj.CI.out) ##################################################
### COME BACK TO REMOVE THIS AFTER INTEGRATED WITH MASTER MARKDOWN
#traj.CI.out <- read.csv(path(data.dir,"traj.CI.out.csv"))
#traj.CI.out$X <- NULL
traj.CI.out <- traj.0

```

```{r clean-process-data, include=FALSE}
# CLEAN AND PROCESS DATA

## 1) RENAME VARIABLES #############################################################################

#Change the profile numbers to factors and name the variable
Profile <- factor(seq(1,nrow(data)))
data <- cbind(data,Profile)

## dataH ##

#Change the profile numbers to factors and name the variable
dataH <- cbind(dataH,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataH$Age0.19 <- NULL
dataH$Age20.44 <- NULL
dataH$Age45.64 <- NULL  
dataH$Age65. <- NULL
dataH$ObesityBMI.30 <- NULL
dataH$ObesityBMI30.40 <- NULL
dataH$ObesityBMI.40 <- NULL
dataH$SmokingYes <- NULL
dataH$ComorbidityYes <- NULL
  
#melt data
dataH.melted <- melt(dataH, id = 'Profile')
dataH.melted$SPA.Name <- dataH.melted$variable
dataH.melted$variable <- NULL
dataH.melted$SPA.Name <- factor(dataH.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataH.melted$prevalence.H <- dataH.melted$value
dataH.melted$value <- NULL

## dataQ ##

#Change the profile numbers to factors and name the variable
dataQ <- cbind(dataQ,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataQ$Age0.19 <- NULL
dataQ$Age20.44 <- NULL
dataQ$Age45.64 <- NULL  
dataQ$Age65. <- NULL
dataQ$ObesityBMI.30 <- NULL
dataQ$ObesityBMI30.40 <- NULL
dataQ$ObesityBMI.40 <- NULL
dataQ$SmokingYes <- NULL
dataQ$ComorbidityYes <- NULL

#melt data
dataQ.melted <- melt(dataQ, id = 'Profile')
dataQ.melted$SPA.Name <- dataQ.melted$variable
dataQ.melted$variable <- NULL
dataQ.melted$SPA.Name <- factor(dataQ.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataQ.melted$prevalence.Q <- dataQ.melted$value
dataQ.melted$value <- NULL

## dataD ##

#Change the profile numbers to factors and name the variable
dataD <- cbind(dataD,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataD$Age0.19 <- NULL
dataD$Age20.44 <- NULL
dataD$Age45.64 <- NULL  
dataD$Age65. <- NULL
dataD$ObesityBMI.30 <- NULL
dataD$ObesityBMI30.40 <- NULL
dataD$ObesityBMI.40 <- NULL
dataD$SmokingYes <- NULL
dataD$ComorbidityYes <- NULL

#melt data
dataD.melted <- melt(dataD, id = 'Profile')
dataD.melted$SPA.Name <- dataD.melted$variable
dataD.melted$variable <- NULL
dataD.melted$SPA.Name <- factor(dataD.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataD.melted$prevalence.D <- dataD.melted$value
dataD.melted$value <- NULL

## PrH ## 

#Change the profile numbers to factors and name the variable
Pr.H <- cbind(Pr.H,Profile)

#Change the name of the variable "Pr" to a more detailed name
Pr.H$Pr.H <- Pr.H$Pr
Pr.H$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.H$Age0.19 <- NULL
Pr.H$Age20.44 <- NULL
Pr.H$Age45.64 <- NULL  
Pr.H$Age65. <- NULL
Pr.H$ObesityBMI.30 <- NULL
Pr.H$ObesityBMI30.40 <- NULL
Pr.H$ObesityBMI.40 <- NULL
Pr.H$SmokingYes <- NULL
Pr.H$ComorbidityYes <- NULL

## PrQ ##

#Change the profile numbers to factors and name the variable
Pr.Q <- cbind(Pr.Q,Profile)

#Change the name of the variable "Pr" to a more detailed name
Pr.Q$Pr.Q <- Pr.Q$Pr
Pr.Q$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.Q$Age0.19 <- NULL
Pr.Q$Age20.44 <- NULL
Pr.Q$Age45.64 <- NULL  
Pr.Q$Age65. <- NULL
Pr.Q$ObesityBMI.30 <- NULL
Pr.Q$ObesityBMI30.40 <- NULL
Pr.Q$ObesityBMI.40 <- NULL
Pr.Q$SmokingYes <- NULL
Pr.Q$ComorbidityYes <- NULL

## PrD ##

#Change the profile numbers to factors and name the variable
Pr.D <- cbind(Pr.D,Profile)

Pr.D$Pr.D <- Pr.D$Pr
Pr.D$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.D$Age0.19 <- NULL
Pr.D$Age20.44 <- NULL
Pr.D$Age45.64 <- NULL  
Pr.D$Age65. <- NULL
Pr.D$ObesityBMI.30 <- NULL
Pr.D$ObesityBMI30.40 <- NULL
Pr.D$ObesityBMI.40 <- NULL
Pr.D$SmokingYes <- NULL
Pr.D$ComorbidityYes <- NULL


## 2) DUMMY VARIABLES <- LEVELS ##################################################################

data$age <- "Blank"
data$age[data$Age0.19==1] <- "0-19"
data$age[data$Age20.44==1] <- "20-44"
data$age[data$Age45.64==1] <- "45-64"
data$age[data$Age65.==1] <- "65+"
data$Age0.19 <- NULL
data$Age20.44 <- NULL
data$Age45.64 <- NULL
data$Age65. <- NULL
data$age <- factor(data$age, levels =  c("0-19", "20-44", "45-64", "65+"))

data$BMI <- "Blank"
data$BMI[data$ObesityBMI.30==1] <- "BMI<30"
data$BMI[data$ObesityBMI30.40==1] <- "30<BMI<40"
data$BMI[data$ObesityBMI.40==1] <- "BMI>40"
data$ObesityBMI.30 <- NULL
data$ObesityBMI30.40 <- NULL
data$ObesityBMI.40 <- NULL

data$BMI <- factor(data$BMI, levels =  c("BMI<30", "30<BMI<40", "BMI>40"))

data$smoking <- "Blank"
data$smoking[data$SmokingYes==1] <- "Smoker"
data$smoking[data$SmokingYes==0] <- "Non Smoker"
data$smoking <- factor(data$smoking, levels = c("Smoker", "Non Smoker"))

data$SmokingYes <- NULL

data$comorbidity <- "Blank"
data$comorbidity[data$ComorbidityYes==1] <- "Comorbidity"
data$comorbidity[data$ComorbidityYes==0] <- "No Comorbidity"
data$comorbidity <- factor(data$comorbidity, levels = c("Comorbidity", "No Comorbidity"))

data$ComorbidityYes <- NULL


## 3) MERGE DATASETS ##################################################################

data <- merge(data, Pr.H, by = "Profile")
data <- merge(data, Pr.Q, by = "Profile")
data <- merge(data, Pr.D, by = "Profile")


## 4) Create Risk Profile Groupings ##################################################################
### NOTE: Grouping done by death risk level
data$riskprofile <- "Blank"
data$riskprofile[data$Pr.D<.01] <- "Risk 5"
data$riskprofile[(data$Pr.D<.07) & (data$Pr.D>.01)] <- "Risk 4"
data$riskprofile[(data$Pr.D<.14) & (data$Pr.D>.07)] <- "Risk 3"
data$riskprofile[(data$Pr.D<.24) & (data$Pr.D>.14)] <- "Risk 2"
data$riskprofile[(data$Pr.D>.24)] <- "Risk 1"
# data$riskprofile[data$Pr.D<.01] <- "Risk 5"
# data$riskprofile[(data$Pr.D<.09) & (data$Pr.D>.01)] <- "Risk 4"
# data$riskprofile[(data$Pr.D<.19) & (data$Pr.D>.09)] <- "Risk 3"
# data$riskprofile[(data$Pr.D<.3) & (data$Pr.D>.19)] <- "Risk 2"
# data$riskprofile[(data$Pr.D>.3)] <- "Risk 1"
data$riskprofile <- factor(data$riskprofile, levels = c("Risk 1", "Risk 2", "Risk 3", "Risk 4", "Risk 5" ))

## Round all numeric variable to 3 digits
data <- data %>% 
  mutate_if(is.numeric, round, digits = 3)

```

### Risk Profiles, Risk Factors, and Risk Groups

- The following table presents the model-estimated probabilities $Pr(Hospital | Illness,Profile_i)$, $Pr(ICU | Hospital,Profile_i)$, and $Pr(Death | ICU,Profile_i)$ for each risk group (or combination of risk factors), as well as the prevalence of these risk groups/factors in the general L.A. County Population $Pr(Profile_i)$.

```{r risk-profile-table, echo=FALSE}

unit.scale = function(x) (x - min(x)) / (max(x) - min(x))

as.datatable(formattable(subset(data, select = c(riskprofile,  age, BMI, smoking, comorbidity, `LA County`,  Pr.H, Pr.Q, Pr.D)), 
            align =c("l","l","l","l","l","l","l","c","c","c","l","l","l"), 
            list(
  #`Profile` = formatter("span", style = ~ style(color = "grey",font.weight = "bold")), 
  `age`= color_tile('yellow', 'darkorange'),
  `BMI`= color_tile('lightblue', 'pink'),
  `smoking`= color_tile('grey', 'transparent'),
  `comorbidity`= color_tile('darkgrey', 'transparent'),
  `riskprofile`= color_tile('red', 'green'),
  `LA County`= color_bar('cornflowerblue', fun = unit.scale),
  `Pr.H`= color_bar('violet', fun = unit.scale),
  `Pr.Q`= color_bar('violet', fun = unit.scale),
  `Pr.D`= color_bar('violet', fun = unit.scale)
)), rownames = FALSE, colnames = c('Pop prevalence Pr(Profile i in L.A.County)' = 'LA County', 'Age' = 'age', 'BMI status' = 'BMI', 'Smoking status' = 'smoking', 'Existing comorbidities' = 'comorbidity', 'Risk Group' = 'riskprofile', 'Pr(Hospital|Illness)' = 'Pr.H', 'Pr(ICU|Hospital)' = 'Pr.Q', 'Pr(Death|ICU)' = 'Pr.D' ), 
#filter = 'bottom', 
options = list(pageLength = 10, 
               autoWidth = TRUE, 
               order = list(list(6, 'desc'), list(7, 'desc'), list(8, 'desc')))
)

```

```{r plotting-stacked-bars, include=FALSE}

## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################

data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$SPA.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$SPA.Name <- factor(data.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'SPA.Name' ) )


## 1) Risk profile in general population #######################################################################################

p.risk.gen <-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in general population by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))


p.BMI.gen <- 
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in general population by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.gen<-
ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in general population by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.gen<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in general population by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.gen<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in general population by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

## 2) Risk profile in hospitalized population #######################################################################################

p.risk.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in hospitalized by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in hospitalized by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in hospitalized by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in hospitalized by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in hospitalized by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

## 3) Risk profile in ICU population #######################################################################################

p.risk.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in ICU by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in ICU by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in ICU by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in ICU by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in ICU by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))


## 4) Risk profile in deceased #######################################################################################

p.risk.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in deceased by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in deceased by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in deceased by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in deceased by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in deceased by SPA", x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

```

```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>% 
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))


## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.SPA <- c(`Antelope Valley` = 'Antelope Valley' , `San Fernando` = 'San Fernando' , `San Gabriel`= 'San Gabriel' , Metro = 'Metro', West = 'West', South = 'South', East = 'East', `South Bay` = 'South Bay' , `LA County` = 'LA County')

p.prev.risk.stage.SPAs<- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    facet_wrap(SPA.Name ~ ., labeller=labeller(SPA.Name = labels.SPA)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and SPAs", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

### Risk profiles, comorbidity, age, obesity by stage of disease for LA County ##############################################################  

LA.data <- subset(full.data, SPA.Name == 'LA County')

p.riskprofiles<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk Profiles By Stage of Disease", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI<-
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Obesity By Stage of Disease", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.age<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = age)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Age By Stage of Disease", x = "Stage", y = "Age") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Any Comorbidity By Stage of Disease", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoking<-
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Smoking Status By Stage of Disease", x = "Stage", y = "Smoking") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

```


## Projections by Risk Factors {.tabset}

- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County/SPA population, based on the population prevalence of the risk group in L.A. County/SPAs. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

### By SPA, stage of disease
```{r, echo=FALSE}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d

```

### By stage of disease, SPA
```{r, echo=FALSE}
p.prev.risk.stage.SPAs
```

### Comparing risk factors
```{r, echo=FALSE}
p.riskprofiles + p.comb + p.age + p.BMI
```

### Age by stage of disease
```{r, echo=FALSE}
p.age.gen + p.age.h + p.age.q + p.age.d

```

### Comorbidity by stage of disease
```{r, echo=FALSE}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d

```

### BMI by stage of disease
```{r, echo=FALSE}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d

```

### Smoking by stage of disease
```{r, echo=FALSE}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d

```

## {-}

```{r trajectory-process-clean, include=FALSE}

## PROCESS TRAJ.OUT TO FIND MEAN  ############################################################################
H.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Htot"))
Q.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Q"))
D.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("D"))

H.median$H <- H.median$median
H.median$median <- NULL
H.median$state.name <- NULL
Q.median$Q <- Q.median$median
Q.median$median <- NULL
D.median$D <- D.median$median
D.median$median <- NULL
HQD.median <- cbind(cbind(H.median,Q.median$Q),D.median$D)
colnames(HQD.median) <- c("date","H","Q","D")

## FIX DATES ##################################################################
HQD.median$date <- as.Date(HQD.median$date)

## ORGANIZE / CLEAN ##################################################################
HQD.median2 <- HQD.median
HQD.median2$Hospitalizations <- HQD.median2$H
HQD.median2$H <- NULL
HQD.median2$ICU <- HQD.median2$Q
HQD.median2$Q <- NULL
HQD.median2$Deaths <- HQD.median2$D
HQD.median2$D <- NULL
HQD.median2 <- melt(HQD.median2,id = 'date')
HQD.median2$Stage <- HQD.median2$variable
HQD.median2$variable <- NULL

```

```{r trajectory-groupby.risk, include=FALSE}

## 1A) GROUP BY RISK PROFILES  ############################################################################

str(HQD.median2)

#pull the total for each risk profile by stage

grouped.by.risk <- full.data %>% 
  dplyr::group_by(stage, riskprofile, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.risk$stage <- factor(grouped.by.risk$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.Q"] <- "ICU"
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.risk <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.risk,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_risk=round(count*prop,3))


```

```{r trajectory-plotby.risk, include=FALSE}

## 1B) PLOT BY RISK PROFILES  ############################################################################


#Hospitalizations

p.traj.risk.h<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Risk Profile for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.risk.q<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Risk Profile for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.risk.d<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Risk Profile for LA County",
       x = "Date",
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.risk.h + p.traj.risk.q + p.traj.risk.d

```

```{r trajectory-groupby.comb, include=FALSE}

## 2A) GROUP BY COMORBIDITY  ############################################################################

#pull the total for each risk profile by stage

grouped.by.comb <- full.data %>% 
  dplyr::group_by(stage, comorbidity, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.comb$stage <- factor(grouped.by.comb$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.Q"] <- "ICU"
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.comb <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.comb,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_comb=round(count*prop,3))


```

```{r trajectory-plotby.comb, include=FALSE}

## 2B) PLOT BY COMORBIDITY  ############################################################################

p.traj.comb.h<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Comorbidity Status for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.comb.q<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Comorbidity Status for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.comb.d<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Comorbidity Status for LA County",
       x = "Date",
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.comb.h + p.traj.comb.q + p.traj.comb.d

```

```{r trajectory-groupby.age, include=FALSE}

## 3A) GROUP BY AGE  ############################################################################

#pull the total for each risk profile by stage

grouped.by.age <- full.data %>% 
  dplyr::group_by(stage, age, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.age$stage <- factor(grouped.by.age$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.age$stage[grouped.by.age$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.age$stage[grouped.by.age$stage == "prevalence.Q"] <- "ICU"
grouped.by.age$stage[grouped.by.age$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.age <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.age,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_age=round(count*prop,3))


```

```{r trajectory-plotby.age, include=FALSE}

## 3B) PLOT BY AGE  ############################################################################

p.traj.age.h<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Age for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.age.q<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Age for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.age.d<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Age for LA County",
       x = "Date",
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.age.h + p.traj.age.q + p.traj.age.d

```

```{r trajectory-groupby.BMI, include=FALSE}

## 4A) GROUP BY BMI  ############################################################################

#pull the total for each risk profile by stage

grouped.by.BMI <- full.data %>% 
  dplyr::group_by(stage, BMI, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.BMI$stage <- factor(grouped.by.BMI$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.Q"] <- "ICU"
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.BMI <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.BMI,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_BMI=round(count*prop,3))


```

```{r trajectory-plotby.BMI, include=FALSE}

## 4B) PLOT BY COMORBIDITY  ############################################################################

p.traj.BMI.h<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Obesity Status for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.BMI.q<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Obesity Status for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.BMI.d<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Obesity Status for LA County",
       x = "Date",
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

```

```{r trajectory-groupby.smoke, include=FALSE}

## 4A) GROUP BY SMOKING  ############################################################################

#pull the total for each risk profile by stage

grouped.by.smoke <- full.data %>% 
  dplyr::group_by(stage, smoking, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.smoke$stage <- factor(grouped.by.smoke$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.Q"] <- "ICU"
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.smoke <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.smoke,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_smoke=round(count*prop,3))


```

```{r trajectory-plotby.smoking, include=FALSE}

## 4B) PLOT BY COMORBIDITY  ############################################################################

p.traj.smoke.h<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Obesity Status for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.smoke.q<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Obesity Status for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.smoke.d<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Obesity Status for LA County",
       x = "Date",
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

```

## Projections across risk factors: Fraction of all LA County Cases by risk factor {.tabset}

### By risk group
```{r, echo=FALSE, message=FALSE}
(p.traj.risk.h + p.traj.risk.q) / p.traj.risk.d
```

### By age
```{r, echo=FALSE, message=FALSE}
(p.traj.age.h + p.traj.age.q) / p.traj.age.d
```

### By comorbidity
```{r, echo=FALSE, message=FALSE}
(p.traj.comb.h + p.traj.comb.q) / p.traj.comb.d
```

### By obesity status
```{r, echo=FALSE, message=FALSE}
(p.traj.BMI.h + p.traj.BMI.q) / p.traj.BMI.d
```

### By smoking status
```{r, echo=FALSE, message=FALSE}
(p.traj.smoke.h + p.traj.smoke.q) / p.traj.smoke.d
```

## {-}





# (1.4) Projections by Race / Ethnicity

```{r calc-risk-probs-race, include=FALSE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

calc_risk_probs_RACE <- path(code.dir, "calc_risk_probs_SPA_race2.R")
r_output(readLines(calc_risk_probs_RACE))
source(calc_risk_probs_RACE)

```


```{r load.data.race, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220

##import prevalence by profile
data <- as.data.frame(profile.cnt.races)
dataH <- as.data.frame(H.profile.share.relative.all.races)
dataQ <- as.data.frame(Q.profile.share.relative.all.races)
dataD <- as.data.frame(D.profile.share.relative.all.races)

#import the probability by profile
# Pr.H <- Pr.H #Pr.H.orig
# Pr.Q <- Pr.Q #Pr.Q.orig
# Pr.D <- Pr.D #Pr.D.orig

race.data <- risk.probs.races

# 
# # ## Data from estimated SEIR model (traj.CI.out) ##################################################
# # traj.CI.out <- traj.0
# 

### Data from estimated SEIR model (traj.CI.out) ##################################################
### COME BACK TO REMOVE THIS AFTER INTEGRATED WITH MASTER MARKDOWN
# traj.CI.out <- read.csv(path(data.dir,"traj.CI.out.csv"))
# traj.CI.out$X <- NULL
traj.CI.out <- traj.0

```

```{r clean-process-data.race, include=FALSE}
# CLEAN AND PROCESS DATA

## 1) RENAME VARIABLES #############################################################################

#Change the profile numbers to factors and name the variable
Profile <- factor(seq(1,nrow(data)))
data <- cbind(data,Profile)

## dataH ##

#Change the profile numbers to factors and name the variable
dataH <- cbind(dataH,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataH$Age0.19 <- NULL
dataH$Age20.44 <- NULL
dataH$Age45.64 <- NULL  
dataH$Age65. <- NULL
dataH$ObesityBMI.30 <- NULL
dataH$ObesityBMI30.40 <- NULL
dataH$ObesityBMI.40 <- NULL
dataH$SmokingYes <- NULL
dataH$ComorbidityYes <- NULL
  
#melt data
dataH.melted <- melt(dataH, id = 'Profile')
dataH.melted$race.Name <- dataH.melted$variable
dataH.melted$variable <- NULL
dataH.melted$race.Name <- factor(dataH.melted$race.Name, levels =  c(rownames(race.data)))
dataH.melted$prevalence.H <- dataH.melted$value
dataH.melted$value <- NULL

## dataQ ##

#Change the profile numbers to factors and name the variable
dataQ <- cbind(dataQ,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataQ$Age0.19 <- NULL
dataQ$Age20.44 <- NULL
dataQ$Age45.64 <- NULL  
dataQ$Age65. <- NULL
dataQ$ObesityBMI.30 <- NULL
dataQ$ObesityBMI30.40 <- NULL
dataQ$ObesityBMI.40 <- NULL
dataQ$SmokingYes <- NULL
dataQ$ComorbidityYes <- NULL

#melt data
dataQ.melted <- melt(dataQ, id = 'Profile')
dataQ.melted$race.Name <- dataQ.melted$variable
dataQ.melted$variable <- NULL
dataQ.melted$race.Name <- factor(dataQ.melted$race.Name, levels =  c(rownames(race.data)))
dataQ.melted$prevalence.Q <- dataQ.melted$value
dataQ.melted$value <- NULL

## dataD ##

#Change the profile numbers to factors and name the variable
dataD <- cbind(dataD,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataD$Age0.19 <- NULL
dataD$Age20.44 <- NULL
dataD$Age45.64 <- NULL  
dataD$Age65. <- NULL
dataD$ObesityBMI.30 <- NULL
dataD$ObesityBMI30.40 <- NULL
dataD$ObesityBMI.40 <- NULL
dataD$SmokingYes <- NULL
dataD$ComorbidityYes <- NULL

#melt data
dataD.melted <- melt(dataD, id = 'Profile')
dataD.melted$race.Name <- dataD.melted$variable
dataD.melted$variable <- NULL
dataD.melted$race.Name <- factor(dataD.melted$race.Name, levels =  c(rownames(race.data)))
dataD.melted$prevalence.D <- dataD.melted$value
dataD.melted$value <- NULL

## PrH ## 

#Change the profile numbers to factors and name the variable
Pr.H <- cbind(Pr.H,Profile)

#Change the name of the variable "Pr" to a more detailed name
Pr.H$Pr.H <- Pr.H$Pr
Pr.H$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.H$Age0.19 <- NULL
Pr.H$Age20.44 <- NULL
Pr.H$Age45.64 <- NULL  
Pr.H$Age65. <- NULL
Pr.H$ObesityBMI.30 <- NULL
Pr.H$ObesityBMI30.40 <- NULL
Pr.H$ObesityBMI.40 <- NULL
Pr.H$SmokingYes <- NULL
Pr.H$ComorbidityYes <- NULL

## PrQ ##

#Change the profile numbers to factors and name the variable
Pr.Q <- cbind(Pr.Q,Profile)

#Change the name of the variable "Pr" to a more detailed name
Pr.Q$Pr.Q <- Pr.Q$Pr
Pr.Q$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.Q$Age0.19 <- NULL
Pr.Q$Age20.44 <- NULL
Pr.Q$Age45.64 <- NULL  
Pr.Q$Age65. <- NULL
Pr.Q$ObesityBMI.30 <- NULL
Pr.Q$ObesityBMI30.40 <- NULL
Pr.Q$ObesityBMI.40 <- NULL
Pr.Q$SmokingYes <- NULL
Pr.Q$ComorbidityYes <- NULL

## PrD ##

#Change the profile numbers to factors and name the variable
Pr.D <- cbind(Pr.D,Profile)

Pr.D$Pr.D <- Pr.D$Pr
Pr.D$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.D$Age0.19 <- NULL
Pr.D$Age20.44 <- NULL
Pr.D$Age45.64 <- NULL  
Pr.D$Age65. <- NULL
Pr.D$ObesityBMI.30 <- NULL
Pr.D$ObesityBMI30.40 <- NULL
Pr.D$ObesityBMI.40 <- NULL
Pr.D$SmokingYes <- NULL
Pr.D$ComorbidityYes <- NULL


## 2) DUMMY VARIABLES <- LEVELS ##################################################################

data$age <- "Blank"
data$age[data$Age0.19==1] <- "0-19"
data$age[data$Age20.44==1] <- "20-44"
data$age[data$Age45.64==1] <- "45-64"
data$age[data$Age65.==1] <- "65+"
data$Age0.19 <- NULL
data$Age20.44 <- NULL
data$Age45.64 <- NULL
data$Age65. <- NULL
data$age <- factor(data$age, levels =  c("0-19", "20-44", "45-64", "65+"))

data$BMI <- "Blank"
data$BMI[data$ObesityBMI.30==1] <- "BMI<30"
data$BMI[data$ObesityBMI30.40==1] <- "30<BMI<40"
data$BMI[data$ObesityBMI.40==1] <- "BMI>40"
data$ObesityBMI.30 <- NULL
data$ObesityBMI30.40 <- NULL
data$ObesityBMI.40 <- NULL

data$BMI <- factor(data$BMI, levels =  c("BMI<30", "30<BMI<40", "BMI>40"))

data$smoking <- "Blank"
data$smoking[data$SmokingYes==1] <- "Smoker"
data$smoking[data$SmokingYes==0] <- "Non Smoker"
data$smoking <- factor(data$smoking, levels = c("Smoker", "Non Smoker"))

data$SmokingYes <- NULL

data$comorbidity <- "Blank"
data$comorbidity[data$ComorbidityYes==1] <- "Comorbidity"
data$comorbidity[data$ComorbidityYes==0] <- "No Comorbidity"
data$comorbidity <- factor(data$comorbidity, levels = c("Comorbidity", "No Comorbidity"))

data$ComorbidityYes <- NULL


## 3) MERGE DATASETS ##################################################################

data <- merge(data, Pr.H, by = "Profile")
data <- merge(data, Pr.Q, by = "Profile")
data <- merge(data, Pr.D, by = "Profile")


## 4) Create Risk Profile Groupings ##################################################################
### NOTE: Grouping done by death risk level
data$riskprofile <- "Blank"
data$riskprofile[data$Pr.D<.01] <- "Risk 5"
data$riskprofile[(data$Pr.D<.07) & (data$Pr.D>.01)] <- "Risk 4"
data$riskprofile[(data$Pr.D<.14) & (data$Pr.D>.07)] <- "Risk 3"
data$riskprofile[(data$Pr.D<.24) & (data$Pr.D>.14)] <- "Risk 2"
data$riskprofile[(data$Pr.D>.24)] <- "Risk 1"
# data$riskprofile[data$Pr.D<.01] <- "Risk 5"
# data$riskprofile[(data$Pr.D<.09) & (data$Pr.D>.01)] <- "Risk 4"
# data$riskprofile[(data$Pr.D<.19) & (data$Pr.D>.09)] <- "Risk 3"
# data$riskprofile[(data$Pr.D<.3) & (data$Pr.D>.19)] <- "Risk 2"
# data$riskprofile[(data$Pr.D>.3)] <- "Risk 1"
data$riskprofile <- factor(data$riskprofile, levels = c("Risk 1", "Risk 2", "Risk 3", "Risk 4", "Risk 5" ))

## Round all numeric variable to 3 digits
data <- data %>% 
  mutate_if(is.numeric, round, digits = 3)

```


```{r plotting-stacked-bars.race, include=FALSE}

## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################

data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$race.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$race.Name <- factor(data.melted$race.Name, levels =  c(rownames(race.data)))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'race.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'race.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'race.Name' ) )


## 1) Risk profile in general population #######################################################################################

p.risk.gen <-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in general population by race", x = "Race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))


p.BMI.gen <- 
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in general population by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.gen<-
ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in general population by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.gen<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in general population by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.gen<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in general population by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

## 2) Risk profile in hospitalized population #######################################################################################

p.risk.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in hospitalized by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in hospitalized by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in hospitalized by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in hospitalized by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in hospitalized by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

## 3) Risk profile in ICU population #######################################################################################

p.risk.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in ICU by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in ICU by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in ICU by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in ICU by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in ICU by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))


## 4) Risk profile in deceased #######################################################################################

p.risk.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in deceased by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in deceased by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in deceased by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in deceased by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in deceased by race", x = "race", y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

```

```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>% 
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))


## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.race <- c(`Latino`= "Latinx" , `White`="White", `Black`= "Black", `American Indian`="American Indian", `Asian`= "Asian", `Native Hawaiian`="Native Hawaiian", `Other`="Other")

p.prev.risk.stage.races<- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    facet_wrap(race.Name ~ ., labeller=labeller(race.Name = labels.race)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and races", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

```


## Projections by race/ethnicity {.tabset}

- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within each race/ethnicity population, based on the population prevalence of the risk group in race/ethnicity groups. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

### Risk groups by stage of disease, race
```{r, echo=FALSE}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d

```

### Risk groups by race, stage of disease
```{r, echo=FALSE}
p.prev.risk.stage.races
```

### Age by stage of disease, race
```{r, echo=FALSE}
p.age.gen + p.age.h + p.age.q + p.age.d

```

### Comorbidity by stage of disease, race
```{r, echo=FALSE}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d

```

### BMI by stage of disease, race
```{r, echo=FALSE}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d

```

### Smoking by stage of disease, race
```{r, echo=FALSE}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d

```


## {-}


```{r illness-severity-by-race,include=FALSE}

########################################################################################################################################################
########################################################################################################################################################
## BAR CHART COMPARISONS
########################################################################################################################################################
########################################################################################################################################################

Pr.H.races <- H.risk.all.races
Pr.Q.races <- Q.risk.all.races
Pr.D.races <- D.risk.all.races
nlevels <- length(Pr.H.races)

Pr.pop <- race.pop

# calculate relative shares in population, H, Q, D by race
relative.shares.races <- calc.HQD.shares(Pr.pop=Pr.pop,Pr.H=Pr.H.races,Pr.Q=Pr.Q.races,Pr.D=Pr.D.races)
rownames(relative.shares.races) <- race.order

# process data for easy ggplot input
relative.shares.races.melted <- melt(relative.shares.races, id=c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))
relative.shares.races.melted$group <-relative.shares.races.melted$X1
relative.shares.races.melted$stage <-relative.shares.races.melted$X2
relative.shares.races.melted$values <-relative.shares.races.melted$value
relative.shares.races.melted$X1 <- NULL
relative.shares.races.melted$X2 <- NULL
relative.shares.races.melted$value <- NULL

relative.shares.races.melted <- relative.shares.races.melted %>% mutate(Race=factor(group,levels=c(race.order)))

######################################
## Bar chart

p.shares.races<-
  relative.shares.races.melted %>%
  mutate(stage = factor(stage, levels=c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))) %>%
  ggplot( aes(x=stage, y=values,fill=Race)) +
#  ggplot( aes(x=stage,y=values,fill=factor(group,levels=c(race.order))))+
  geom_bar(position="stack", stat = 'identity')+
  labs(title = "Projected Illness Severity by Race/Ethnicity", x = "Stage", y = "Prevalence", legend="Race/Ethnicity") +
  scale_x_discrete(labels = c("Population","Hospitalized","ICU","Dead"))



##############################################################################################################################
## Compare projected D to observed D

#Pop.prevalence = read.csv(path(data.dir, "Pop.prevalence.BMI.csv"), sep=",", header=TRUE,row.names = 1 )
race_observed_D = read.csv(path(data.dir, "race_D_051020.csv"), sep=",", header=TRUE,row.names = 1 )
start.date.race <- as.Date("2020-03-28")
no.obs.race <- ncol(race_observed_D)
step.race <- seq(1:no.obs.race)
colnames.race <- start.date.race + step.race
colnames(race_observed_D) <- colnames.race

race_observed_D_May11 <- race_observed_D$`2020-05-11`
race_observed_D_May11 <- race_observed_D_May11/sum(race_observed_D_May11)

race_observed_D_Apr16 <- race_observed_D$`2020-04-16`
race_observed_D_Apr16 <- race_observed_D_Apr16/sum(race_observed_D_Apr16)

relative.shares.races.D.obs <- as.data.frame(cbind(relative.shares.races[,1], relative.shares.races[,4], race_observed_D_Apr16, race_observed_D_May11))
colnames(relative.shares.races.D.obs) <- c("prevalence.gen.pop","proj.D","obs.D.Apr16","obs.D.May11")

# process data for easy ggplot input
relative.shares.races.D.obs.melted <- melt(as.matrix(relative.shares.races.D.obs), id=c("prevalence.gen.pop", "proj.D" ,"obs.D.Apr16","obs.D.May11" ))
relative.shares.races.D.obs.melted$race <-relative.shares.races.D.obs.melted$X1
relative.shares.races.D.obs.melted$stage <-relative.shares.races.D.obs.melted$X2
relative.shares.races.D.obs.melted$values <-relative.shares.races.D.obs.melted$value
relative.shares.races.D.obs.melted$X1 <- NULL
relative.shares.races.D.obs.melted$X2 <- NULL
relative.shares.races.D.obs.melted$value <- NULL

relative.shares.races.D.obs.melted <- relative.shares.races.D.obs.melted %>% mutate(Race=factor(race,levels=c(race.order)))

######################################
## Bar chart

p.shares.races.D.obs<-
  relative.shares.races.D.obs.melted %>%
  mutate(stage = factor(stage, levels=c("prevalence.gen.pop", "proj.D" ,"obs.D.Apr16","obs.D.May11" ))) %>%
  ggplot( aes(x=stage, y=values,fill=Race)) +
#  ggplot( aes(x=stage,y=values,fill=factor(group,levels=c(race.order))))+
  geom_bar(position="stack", stat = 'identity')+
  labs(title = "Deaths by Race/Ethnicity: Projected vs. Observed", x = "Projection (Model) or Observation (Data)", y = "Prevalence", legend="Race/Ethnicity") +
  scale_x_discrete(labels = c("% of Population","Projected%","Obs% Apr16","Obs% May 11"))


```


```{r trajectory-process-clean.race, include=FALSE}

########################################################################################################################################################
########################################################################################################################################################
## TRAJECTORIES
########################################################################################################################################################
########################################################################################################################################################

## PROCESS MODEL PROJECTS DATA TO GET MEAN/MEDIAN  ############################################################################
I.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Idetectcum"))
H.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Htot"))
Q.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Q"))
D.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("D"))

I.median$I <- I.median$median
I.median$median <- NULL
H.median$H <- H.median$median
H.median$median <- NULL
H.median$state.name <- NULL
Q.median$Q <- Q.median$median
Q.median$median <- NULL
D.median$D <- D.median$median
D.median$median <- NULL

IHQD.median <- cbind(I.median,H.median$H,Q.median$Q,D.median$D)
IHQD.median$state.name = NULL
colnames(IHQD.median) <- c("date","I","H","Q","D")

## FIX DATES ##################################################################
IHQD.median$date <- as.Date(IHQD.median$date)

## ORGANIZE / CLEAN ##################################################################
IHQD.median2 <- IHQD.median
IHQD.median2$Illnesses <- IHQD.median2$I
IHQD.median2$I <- NULL
IHQD.median2$Hospitalizations <- IHQD.median2$H
IHQD.median2$H <- NULL
IHQD.median2$ICU <- IHQD.median2$Q
IHQD.median2$Q <- NULL
IHQD.median2$Deaths <- IHQD.median2$D
IHQD.median2$D <- NULL
IHQD.median2 <- melt(IHQD.median2,id = 'date')
IHQD.median2$Stage <- IHQD.median2$variable
IHQD.median2$variable <- NULL


## MERGE WITH COUNTS  ############################################################################

str(IHQD.median2)

#Add all the factor names so we can rename the factors in the dataframe to match the daily count
TEST <- relative.shares.races.melted
TEST$stage <- factor(TEST$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D","Illnesses", "Hospitalizations", "ICU", "Deaths"  ))
IHQD.median2$Stage <- factor(IHQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Illnesses", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
TEST$stage[TEST$stage == "prevalence.gen.pop"] <- "Illnesses"
TEST$stage[TEST$stage == "prevalence.H"] <- "Hospitalizations"
TEST$stage[TEST$stage == "prevalence.Q"] <- "ICU"
TEST$stage[TEST$stage == "prevalence.D"] <- "Deaths"

#break down daily count by race shares
count.races <- left_join(
  IHQD.median2 %>% dplyr::rename(count=value), 
  TEST,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_races=round(count*prop,3))


## PLOT BY RISK PROFILES  ############################################################################

#Population

p.traj.race.I<-
  ggplot(filter(count.races, Stage == "Illnesses"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Projected Cumulative Illnesses by Race/Ethnicity (by population share)",
       x = "Date",
       y = "Cumulative Illnesses") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#Hospitalizations

p.traj.race.H<-
  ggplot(filter(count.races, Stage == "Hospitalizations"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected Hospitalizations by Race/Ethnicity for LA County",
       x = "Date",
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.race.Q<-
  ggplot(filter(count.races, Stage == "ICU"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected ICU by Race/Ethnicity for LA County",
       x = "Date",
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.race.D<-
  ggplot(filter(count.races, Stage == "Deaths"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected Deaths by Race/Ethnicity for LA County",
       x = "Date",
       y = "Number Deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

```


## Projections across race/ethnicity: Fraction of all LA County Cases by Race {.tabset}

- Due to disparities in the prevalence of health conditions, health behaviors, and age -- the risk factors for COVID-19 -- the relative risk of death is not distributed equally across each race/ethnicity.
- These figures demostrate the projections of the relative share of hospitalizations, ICU admissions, and deaths by race/ethnicity from our model, which accounts for biological COVID-19 risk factors. Values are compared with the baseline distribution of the relative share of the L.A. County population in each race/ethnicity group.

### Deaths by race: Model projections vs. observed LA data

- This figure compares the projections of the relative share of deaths by race/ethnicity from our model **with the observed relative share of deaths by race/ethnicity in L.A. County**. The population prevalence of each race/ethnicity is also provided as a baseline (left column). 
- A key insight from this figure is that as the epidemic evolves, the trend in death rate by race/ethnicity appears to be converging to the biological expected risk as calculated by our model. 
- Only time will tell if this stabilies or if the death rate by race/ethnicity grows disproportionately to that expected by biological factors alone as the epidemic progresses.

```{r, echo=FALSE, message=FALSE}

p.shares.races.D.obs

```

### Projected illness severity by race
```{r, echo=FALSE, message=FALSE}

p.shares.races

```

### Projected illness trajectories by race and risk group
```{r, echo=FALSE, message=FALSE}

p.traj.race.I + p.traj.race.H + p.traj.race.Q + p.traj.race.D

```

## {-}

































# (2) Social distancing scenarios


## SCENARIOS EVALUATED: Increase contact rate on May 16th, 2020 by variable amounts {.tabset}

```{r scenarios-evaluated, include=FALSE}

R0_redux_est <- round(ABC.par.stats$`Frac R0 Mar11`[1] , 2)
R0_est <- round(ABC.par.stats$R0[1] , 2)
R0_redux_scenarios <- round(seq(R0_redux_est*100, 100, length.out=7),1)
incr_current_scenarios <- 100*(R0_redux_scenarios - 100*R0_redux_est) / (100*R0_redux_est)
R0_eff_scenarios <- round((R0_redux_scenarios/100)*R0_est,2)
scenario_idx <- seq(1:length(R0_redux_scenarios))-1
scenarios_table <- cbind(scenario_idx, R0_redux_scenarios, incr_current_scenarios, R0_eff_scenarios)
colnames(scenarios_table) <- c("Scenario", "% of orig. R0", "% increase from current", "Effective R0")

```

### Scenarios evaluated

`r length(R0_redux_scenarios)` are illustrated here. Each scenario corresponds to a different amount of contact rate, and can be understood in terms of:

- The *Effective $R0$*: The effective R0 this % decrease corresponds to
- The *% of original $R0$*: % of the original (pre-social-distancing) $R0$ the effective $R0$ this scenario represents
- The *% increase from current*: % increase from current (as of `r Sys.Date()`) level of social distancing / contact rate

```{r, echo=FALSE}

kable(scenarios_table) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

```{r, include=FALSE}

R0_redux_eval = R0_redux_scenarios/100

scenario = 2
intervention_date = "2020-05-16"
ABC.out.mat <- ABC.out.mat.yesR
number.pars.to.use = 500
iter = 20
time.steps=600

sd.redux = R0_redux_eval[1]
traj.2.May1.0 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.2.May1.1 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[3]
traj.2.May1.2 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[4]
traj.2.May1.3 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.2.May1.4 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[6]
traj.2.May1.5 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.2.May1.6 <- model.output.to.plot.SIM(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = vars.plus.R, 
                                       init.date.data="2020-03-01", all=TRUE, scenario.selection = scenario,intervention_date=intervention_date,sd.redux=sd.redux)


### PLOT OBJECTS

scenario=2
intervention_date = "2020-05-16"
use.title=TRUE
plot.capacity=TRUE
time.steps.4plot = 400
var.to.plot="Htot"
ymax=15000


sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.H.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.H.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.H.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.H.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.H.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.H.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.H.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)




##########################
## V

plot.capacity=TRUE
time.steps.4plot = 500
var.to.plot="V"
ymax=4000

sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.V.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.V.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.V.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.V.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.V.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.V.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.V.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)



##########################
## Q


plot.capacity=TRUE
time.steps.4plot = 500
var.to.plot="Q"
ymax=8000


sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.Q.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.Q.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.Q.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.Q.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.Q.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.Q.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.Q.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)


##########################
## V

plot.capacity=TRUE
time.steps.4plot = 500
var.to.plot="V"
ymax=4000

sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.V.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.V.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.V.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.V.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.V.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.V.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.V.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)



##########################
## D


plot.capacity=NULL
time.steps.4plot = 500
var.to.plot="D"
ymax=30000

sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.D.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.D.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.D.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.D.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.D.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.D.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.D.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)



##########################
## I


plot.capacity=NULL
time.steps.4plot = 500
var.to.plot="I"
ymax=70000

sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.I.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.I.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.I.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.I.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.I.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.I.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.I.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)



##########################
## Itot


plot.capacity=NULL
time.steps.4plot = 500
var.to.plot="Itot"
ymax=3e6

sd.redux = R0_redux_eval[1]
traj.CI=traj.2.May1.0
p.Itot.2.May1.0 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[2]
traj.CI=traj.2.May1.1
p.Itot.2.May1.1 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[3]
traj.CI=traj.2.May1.2
p.Itot.2.May1.2 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[4]
traj.CI=traj.2.May1.3
p.Itot.2.May1.3 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[5]
traj.CI=traj.2.May1.4
p.Itot.2.May1.4 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
sd.redux = R0_redux_eval[6]
traj.CI=traj.2.May1.5
p.Itot.2.May1.5 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

sd.redux = R0_redux_eval[7]
traj.CI=traj.2.May1.6
p.Itot.2.May1.6 <- plot.model.single(traj.CI=traj.CI, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                                   time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                                   scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)


```

### Maintain current level of social distancing

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[1,4])`
- *% of original R0*: `r as.numeric(scenarios_table[1,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[1,3])`

```{r}

ggplotly(p.H.2.May1.0)
ggplotly(p.D.2.May1.0)
ggplotly(p.Q.2.May1.0)
ggplotly(p.V.2.May1.0)
ggplotly(p.I.2.May1.0)
ggplotly(p.Itot.2.May1.0)

```

### *% of original R0*: `r as.numeric(scenarios_table[2,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[2,4])`
- *% of original R0*: `r as.numeric(scenarios_table[2,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[2,3])`

```{r}

ggplotly(p.H.2.May1.1)
ggplotly(p.D.2.May1.1)
ggplotly(p.Q.2.May1.1)
ggplotly(p.V.2.May1.1)
ggplotly(p.I.2.May1.1)
ggplotly(p.Itot.2.May1.1)

```

### *% of original R0*: `r as.numeric(scenarios_table[3,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[3,4])`
- *% of original R0*: `r as.numeric(scenarios_table[3,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[3,3])`

```{r}

ggplotly(p.H.2.May1.2)
ggplotly(p.D.2.May1.2)
ggplotly(p.Q.2.May1.2)
ggplotly(p.V.2.May1.2)
ggplotly(p.I.2.May1.2)
ggplotly(p.Itot.2.May1.2)

```

### *% of original R0*: `r as.numeric(scenarios_table[4,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[4,4])`
- *% of original R0*: `r as.numeric(scenarios_table[4,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[4,3])`

```{r}

ggplotly(p.H.2.May1.3)
ggplotly(p.D.2.May1.3)
ggplotly(p.Q.2.May1.3)
ggplotly(p.V.2.May1.3)
ggplotly(p.I.2.May1.3)
ggplotly(p.Itot.2.May1.3)

```

### *% of original R0*: `r as.numeric(scenarios_table[5,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[5,4])`
- *% of original R0*: `r as.numeric(scenarios_table[5,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[5,3])`

```{r}

ggplotly(p.H.2.May1.4)
ggplotly(p.D.2.May1.4)
ggplotly(p.Q.2.May1.4)
ggplotly(p.V.2.May1.4)
ggplotly(p.I.2.May1.4)
ggplotly(p.Itot.2.May1.4)

```

### *% of original R0*: `r as.numeric(scenarios_table[6,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[6,4])`
- *% of original R0*: `r as.numeric(scenarios_table[6,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[6,3])`

```{r}

ggplotly(p.H.2.May1.5)
ggplotly(p.D.2.May1.5)
ggplotly(p.Q.2.May1.5)
ggplotly(p.V.2.May1.5)
ggplotly(p.I.2.May1.5)
ggplotly(p.Itot.2.May1.5)

```

### *% of original R0*: `r as.numeric(scenarios_table[7,2])`

Equal to:

- The *Effective $R0$*: `r as.numeric(scenarios_table[7,4])`
- *% of original R0*: `r as.numeric(scenarios_table[7,2])`
- *% Increase from current*: `r as.numeric(scenarios_table[7,3])`

```{r}
ggplotly(p.H.2.May1.6)
ggplotly(p.D.2.May1.6)
ggplotly(p.Q.2.May1.6)
ggplotly(p.V.2.May1.6)
ggplotly(p.I.2.May1.6)
ggplotly(p.Itot.2.May1.6)
```

## {-}

# Summary
- Predictive epidemic modeling can help to evaluate the public health strategies for limiting the spread of COVID-19.
LA County is succeeding in mitigating the epidemic curve due to strong adherence to social distancing (model-estimated reduction in contact rate of >70%).
- Our model suggests that social distancing may need to be continued for a longer period of time to retain these mitigation effects.
- Our model predicts that higher risk groups -- characterized not only by advanced age but also combinations of existing health conditions -- will make up the majority of those afflicted with severe disease. We analyze how these risk factors project onto race/ethnicity groups and project expected illness patterns based on population size and prevalence of these risk factors.
- Model estimates can and will change as new studies and data become available.

# Acknowledgements
- We would like to acknowledge Claire Jacquillat and Adam Taylor for their contributions related to data wrangling, cleaning, interpretation, and visualization.

