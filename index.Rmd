---
title: "USC Predict COVID Project"
subtitle: "Predictive Epidemic Model for COVID-19 in Los Angeles County"
author: "University of Southern California, Department of Preventive Medicine"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
editor_options: 
  chunk_output_type: console
---

Updated with data available as of `r Sys.Date()`

``` {r setup, include=FALSE}

### Install necessary packages and get started

library(reshape2)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggrepel)
library(bindata)
library(odin)
library(fitR)
library(knitr)
library(EasyABC)
library(gridExtra)
library(odin)
library(lubridate)
library(EasyABC)
library(gridExtra)
library(kableExtra)
library(plyr)
library(dplyr)
library(data.table)
library(scales)
library(EasyABC)
library(patchwork)

library(tidyr)
library(readr)
library(purrr)
library(tibble)
library(stringr)
library(forcats)
library(network)
library(tidygraph)
library(ggraph)
library(visNetwork)
library(networkD3)
library(ggmosaic)
library(formattable)
library(DT)
library(reshape)
library(here)
library(fs)

library(MASS)
library(plotly)

lang_output <- function(x, lang) {
  cat(c(sprintf("```%s", lang), x, "```"), sep = "\n")
}
r_output <- function(x) lang_output(x, "r")

knitr::opts_chunk$set(
  fig.width = 9.5,
  fig.height = 8,
  echo=FALSE,
  warning=FALSE,
  cache=FALSE,
  message=FALSE)


code.dir=here("code/")
data.dir=here("data/")
result.dir = here("results/")
```

<br>

# Aims

The USC Predict COVID project has developed the **SEIR+RISK** epidemic model to estimate and gain insight into the impact of COVID-19 in Los Angeles County and on its residents. 

The primary questions we are addressing are:

- When will the peak of the epidemic occur and how will it impact health care capacity?
- What happens to the dynamics of the epidemic when social distancing is reduced or returns to pre-pandemic levels?
- How will the epidemic affect different at-risk groups?
- How will the epidemic affect different race / ethnicity groups?

Our epidemic modeling efforts provide:

- Projections of illness severity trajectories in L.A. County as a whole and for race/ethnicity groups, based on prevalence of known COVID-19 risk factors.
- Predictions for the impact on counts and corresponding time periods under various social distancing scenarios in which restrictions are eased.

**The particular contribution of our model over existing models estimating hospital resource demand is that it accounts for combinations of risk factors (age, unhealthy behaviors, existing comorbidities, and combinations of comorbidities), including area-level differences in prevalence of these risk factors, in determining COVID intensity.** Accounting for differential risk for specific populations is important both for making projections about the scale of the epidemic, and for prioritizing at-risk populations for protection. In the [Risk Table](https://uscbiostats.github.io/COVID19/risk_table.html) page, we also provide the results of our estimates as a tool where individuals can look up their risk of severe illness based on their individual combinations of risk factors.


```{r calc-risk-probs, include=FALSE, eval=TRUE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

# calc_risk_probs_code <- path(code.dir, "calc_risk_probs_042220.R")
# #r_output(readLines(calc_risk_probs_code))
# #source(calc_risk_probs_code)
# #
# Alpha.prior.mean <- risk.probs.SPAs[9,1]
# Kappa.prior.mean <- risk.probs.SPAs[9,2]
# Delta.prior.mean <- risk.probs.SPAs[9,3]

```


```{r read-in-current-COVID-data, include=FALSE}

###################################################################################################
## COVID INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

cum_file <- sort(dir_ls(data.dir, regexp = "cum_counts_"), decreasing = TRUE)[1]

obs_cum_new_counts = t(read.csv(cum_file, sep=",",stringsAsFactors = FALSE))
#import.date <- as.Date("2020-05-06")

colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","I_new","V_new","H_capacity","Q_capacity", "V_free", "Q_free")

nvars <- ncol(obs_cum_new_counts)
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:nvars] <- sapply(obs_cum_new_counts[1:nvars],as.character)
obs_cum_new_counts[1:nvars] <- sapply(obs_cum_new_counts[1:nvars],as.numeric)
no_obs <- nrow(obs_cum_new_counts)

step <- c(1:no_obs)
obs.shift <- cbind(step,obs_cum_new_counts)
data = obs.shift

## DATA FORMAT FOR PLOTTING (BELOW)
data.in.tmp.orig <- obs_cum_new_counts %>% dplyr::select(-c(H_capacity,Q_capacity,V_free,Q_free))

length(data.in.tmp.orig)
length(NH_counts)

```

```{r SNF-data-frac-calc, include=FALSE}

# READ IN SNF DATA AND CALCULATE FRACTIONS COMPOSED OF THIS GROUP
snf_file <- sort(dir_ls(data.dir, regexp = "SNF_"), decreasing = TRUE)[1]

NH_counts = t(read.csv(snf_file, sep=",",stringsAsFactors = FALSE))

### Process data
NH_counts <- as.data.frame(NH_counts)
NH_counts <- NH_counts[-1,]
colnames(NH_counts) <-c("I_staff_cum","I_resident_cum","D_resident_cum")
nvars <- ncol(NH_counts)
NH_counts[1:nvars] <- sapply(NH_counts[1:nvars],as.character)
NH_counts[1:nvars] <- sapply(NH_counts[1:nvars],as.numeric)
no_obs_NH <- nrow(NH_counts)

step <- c(1:no_obs_NH)
obs.shift <- cbind(step,NH_counts)
data_NH = obs.shift

# REMOVE NH COUNTS AND PLOT
clean_SNF_remove <- path(code.dir, "clean_SNF_remove.R")
#r_output(readLines(clean_SNF_remove))
source(clean_SNF_remove)

# CURRENT TOTAL % OF DEATHS COMING FROM SNF -- FOR METHODS
NH_total_frac <- last(NH_counts$D_resident_cum) / last(data.in.tmp.orig$D)
NH_total_per <- round(NH_total_frac*100,1)

```


```{r read-in-model-supporting-functions, include=FALSE}

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- path(code.dir, "stochastic_SEIHQDR_A.R")
r_output(readLines(path_seihqdr_model))

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

###################################################################################################
## READ IN REQUIRED FUNCTIONS

supporting_functions <- path(code.dir, "supporting_functions_Recovered.R")
#r_output(readLines(supporting_functions))
source(supporting_functions)

# FUNCTIONS INCLUDED:

## FOR ABC
### sum.stats: A function specifying the data to COVID-19 data to fit the model to
### model.1sim.stats: A function implementing the model to be simulated

## FUNCTIONS FOR GENERATING PROJECTIONS
### correlated.param: SPECIFYING EPIDEMIC MODEL TO BE SIMULATED AND SCENARIOS
### model.output.to.plot: ETTING MODEL OUTPUT + SUMMARY STATISTICS FUNCTION

## TABLE GENERATING FUNCTIONS

## PLOTTING FUNCTIONS
### plot.model.data.all: PLOTTING ALL FACETED FUNCTION
### plot.model.single: PLOTTING ONE AT A TIME FUNCTION INCLUDING SCENARIO SPECIFICATIONS

```



```{r bringing-in-Recovered, include=FALSE}

### Step 1: Calculate frac. Recovered from the prior bounds of r, fraction observed illnesses

## The equations informing Step 1
#frac.obs <- obs.R / total.R
#total.R <- obs.R / frac.obs
#frac.R <- obs.R / (frac.obs * pop.size)

## Inputs
pop.size <- 1e7
frac.obs <- c(0.02,0.1) # Best estimate from model
#frac.obs <- c(0.0002,0.0125)
# Dates 1 to 3 weeks before seroprevalence study
sero.date <- as.Date("2020-04-05")
whatis.1to3weeks.before.sero <- c(sero.date-21,sero.date-7)
whatis.1to3weeks.before.sero <- as.numeric(whatis.1to3weeks.before.sero - as.Date("2020-03-01"))
obs.R <- cum_counts_NH_update$Idetectcum[whatis.1to3weeks.before.sero]
#obs.R

## Output: frac. Recovered cases at point of serological study
frac.R.1 <- obs.R / (frac.obs[1] * pop.size)
frac.R.2 <- obs.R / (frac.obs[2] * pop.size)
frac.R.min <- min(frac.R.1,frac.R.2)
frac.R.max <- max(frac.R.1,frac.R.2)
frac.R.mean <- (frac.R.min+frac.R.max)/2
# frac.R.min <- min(frac.R.1)
# frac.R.max <- max(frac.R.2)
# frac.R.mean <- (frac.R.min + frac.R.max)/2
frac.R.mean
### Step 2: Interpolating time series for number Recovered from frac. Recovered 
###         and assumption of 1st Recovered case 2 weeks after 1st Infected case

## Date of first recovered
# Start time of outbreak --> first infection (in days before March 1st 2020)
start_time_for_interpolate = 45
# Choose the amount of recovery time (14 days)
days_to_assume_recovery = 14

start.interpolate <-  -start_time_for_interpolate+days_to_assume_recovery 
end.interpolate <- as.numeric(as.Date("2020-04-05") - as.Date("2020-03-01"))
n.interpolate <- end.interpolate - start.interpolate +1

# Input from Step 1
Recovered.data.point <- frac.R.mean*pop.size  #0.0002 * 1e7 #0.04 * 1e7
#Recovered.data.point <- .04 *pop.size  #0.0002 * 1e7 #0.04 * 1e7

# Interpolation
int.t <- c(start.interpolate,end.interpolate)
int.y <- c(1,Recovered.data.point)

interpolate_Recovered <- spline(x=int.t, y=(int.y)^(.5), n=n.interpolate, method="natural")
interpolate_Recovered$y <- (interpolate_Recovered$y)^2
#plot(interpolate_Recovered$x, (interpolate_Recovered$y), type ="o")

# Save only values from timestep 0 (i.e. from March 1 2020) onwards
interpolated.R <- as.data.frame(interpolate_Recovered) %>% filter(x>0)
interpolated.R <- as.numeric(interpolated.R$y)

```

```{r setup-ABC}

###################################################################################################
## SUMMARY STATISTICS COMPUTED ON DATA
data.in.tmp <- cum_counts_NH_update %>% select(-c(V_new))
no_obs <- nrow(data.in.tmp)

summarydata <- sum.stats.SIMTEST(data.in.tmp,include.R = FALSE)
summarydata.no.R <- summarydata

# Add interpolated number Recovered onto summary data
summarydata.yes.R <- c(summarydata,interpolated.R)


###################################################################################################
## DEFINING PRIORS
iter = 500
R0 <- 4.3 #3.25
r <- 0.03 #0.05
start_time <- 45
R0_redux <- .205 #.2  #Br(t)=Br*R0_redux
Delta <- .55 #.75
Alpha <- .18#.2
Kappa <- .35 #.25
p_V <- .5#.7
intervention_date="2020-03-12"

ABC.out.mat <- as.data.frame(t(rep(0,8)))
ABC.out.mat[1] <- R0
ABC.out.mat[2] <- r
ABC.out.mat[3] <- start_time
ABC.out.mat[4] <- R0_redux
ABC.out.mat[5] <- Delta
ABC.out.mat[6] <- Alpha
ABC.out.mat[7] <- Kappa
ABC.out.mat[8] <- p_V

###################################################################################################
## APPLY ABC 
###################################################################################################

###################################################################################################
## PRIOR DISTRIBUTIONS
## A list joining the prior for each parameter
prior.R0 <- c("normal",R0,.1) 
#prior.r <- c("unif", .005, .035) # c("normal",r,0.01)
prior.st <- c("unif",40,50) 
prior.R0.redux <- c("unif", R0_redux - 0.2, R0_redux + 0.2)  #c("normal",R0_redux, 0.05) 
prior.Delta <- c("normal",0.55,0.03) 
prior.Alpha <- c("normal",Alpha, 0.03) 
prior.Kappa <- c("normal",Kappa, 0.03)
prior.p_V <- c("unif", p_V-0.1, p_V+0.1 ) #c("normal",p_V, 0.08)

#prior.par <- list(prior.R0, prior.r,prior.st,prior.R0.redux,prior.Delta,prior.Alpha,prior.Kappa,prior.p_V)
intervention_date="2020-03-12"

## OTHER INPUTS
tolerance=c(15,4) # defining the sequence of tolerance levels 
#weights.vec <- c( rep(1,length(ss.I)), rep(5,length(ss.H)), rep(2,length(ss.V)), rep(5, length(ss.D)), rep(2,length(ss.Hnew)),rep(2,length(ss.Dnew))  )
```


```{r ABC.yes.R, include=FALSE}

###################################################################################################
## RUN ABC ALGORITHM (SOURCED FROM ABC_mcmc PACKAGE)

# Specifiying the prior for r to be close to sero study
#prior.r <- c("unif",0.00013,0.0125) #c("unif", .02, .036)  #c("unif", .017, .052) #  #c("unif", .028, .05) 
prior.r <- c("unif",0.02, 0.04)
#prior.r <- c("unif",0.0002,0.0125)
prior.par <- list(prior.R0, prior.r,prior.st,prior.R0.redux,prior.Delta,prior.Alpha,prior.Kappa,prior.p_V)

summarydata <- summarydata.yes.R
model.R <- model.1sim.stats.yes.R

# AA = 35
# BB = length(summarydata) - AA
# dist_weights = c(rep(1,BB), rep(1000,AA))

# ABC_Marjoram<-ABC_mcmc(method="Marjoram",model=model.R,prior=prior.par,
#                        summary_stat_target=summarydata, n_calibration=100000,
#                        tolerance_quantile=0.1,verbose=TRUE,progress=TRUE, n_rec=1000) #, dist_weights=dist_weights )

### FOR QUICK TESTS
ABC_Marjoram<-ABC_mcmc(method="Marjoram",model=model.R,prior=prior.par,
                       summary_stat_target=summarydata, n_calibration=100000,
                       tolerance_quantile=0.1,verbose=TRUE,progress=TRUE, n_rec=1000) #, dist_weights=dist_weights )

ABC_out <- ABC_Marjoram

ABC.par.out <- as.data.frame(ABC_out$param)
ABC.out.mat <- ABC_out$param
ABC.out.mat.yesR <- ABC.out.mat

## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean) %>% mutate_if(is.numeric,round,digits=4)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd) %>% mutate_if(is.numeric,round,digits=4)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))
colnames(ABC.par.stats)<-c("R0","Prop. cases detected (r)","Start time", "Frac R0 Mar11", "Pr(Death|ICU)", "Pr(Hospital|Illness)", "Pr(ICU|Hospital)", "Pr(Ventilation|ICU)")
rownames(ABC.par.stats)<-c("mean","sd")
ABC.par.stats
#ABC.par.stats %>% round(ABC.par.stats,4)

###################################################################################################
## PLOTTING DENSITIES
out_R0<- as.data.frame(cbind(ABC_out$param[,1],ABC_out$weights))
out_r<- as.data.frame(cbind(ABC_out$param[,2],ABC_out$weights))
out_R0redux<- as.data.frame(cbind(ABC_out$param[,4],ABC_out$weights))

yesR.p.R0redux <- ggplot2::ggplot(out_R0redux, aes(V1)) + geom_density() + xlab("R0 Redux Posterior Distribution") + ggtitle("R0 Redux") 
yesR.p.R0 <- ggplot(out_R0, aes(V1)) + geom_density() + xlab("R0 Posterior Distribution") + ggtitle("R0") 
yesR.p.r <- ggplot(out_r, aes(V1)) + geom_density() + xlab("r Posterior Distribution") + ggtitle("r") 

#yesR.p.R0redux + yesR.p.R0 + yesR.p.r

den3d <- kde2d(ABC.out.mat[,1], ABC.out.mat[,2])
yesR.p.3d.R0.r <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.R0.r, title="R0 and r (fraction observed cases) joint posterior density")

den3d <- kde2d(ABC.out.mat[,1], ABC.out.mat[,4])
yesR.p.3d.R0.redux <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.R0.redux, title="R0 and R0_redux (R0 factor reduction) joint posterior density")

den3d <- kde2d(ABC.out.mat[,2], ABC.out.mat[,4])
yesR.p.3d.r.redux <- plot_ly(x=den3d$x, y=den3d$y, z=den3d$z) %>% add_surface()
layout(yesR.p.3d.r.redux, title="r (fraction observed cases) and R0_redux (R0 factor reduction) joint posterior density")

###################################################################################################
## SUMMARY TABLE 

ABC.out.mat <- ABC_out$param[1:1000,]
time.steps = 400
par.vec.length=1000
iter <- 20
summary_table <- summary.table(ABC.out.mat=ABC.out.mat, par.vec.length=par.vec.length, iter=iter, time.steps=time.steps, init.date.data="2020-03-01")

###################################################################################################
## PLOTTING ALL VARIABLE FITS

ABC.out.mat <- ABC_out$param[1:1000,]
par.vec.length <- 1000
iter <- 25
time.steps <- 400
vars.to.plot <- vars.plus.R

traj.0 <- model.output.to.plot.SIM(ABC.out.mat=ABC.out.mat, par.vec.length=par.vec.length, iter=iter, time.steps=time.steps, vars.to.plot = vars.to.plot, init.date.data="2020-03-01", all=TRUE, scenario.selection = 4,intervention_date=intervention_date,sd.redux=NULL)

time.steps.4.plot = 150
#data.in <- data.in.tmp
data.in <- data.in.tmp
vars.to.plot <- vars.plus.R
## Plot all

yesR.plot.all.variables.current.scenario.150days <- 
plot.model.data.all(traj.CI = traj.0, data.in = data.in, init.date.data = "2020-03-01", date.offset.4plot = 15, time.steps.4plot=time.steps.4.plot, 
                    vars.to.plot=vars.plus.R)

time.steps.4.plot = 300
#data.in <- data.in.tmp
data.in <- data.in.tmp
vars.to.plot <- vars.plus.R
## Plot all

yesR.plot.all.variables.current.scenario.300days <- 
plot.model.data.all(traj.CI = traj.0, data.in = data.in, init.date.data = "2020-03-01", date.offset.4plot = 15, time.steps.4plot=time.steps.4.plot, 
                    vars.to.plot=vars.plus.R)

###################################################################################################
## PLOTTING NUMBERS IN COMPARTMENTS 

var.to.plot <- "Htot"
scenario=0
intervention_date = intervention_date
sd.redux = NULL
use.title=NULL
plot.capacity=TRUE
ymax=NULL
time.steps.4plot = 250

yesR.p.H.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(yesR.p.H.0)

var.to.plot <- "Q"
yesR.p.Q.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.Q.0)


var.to.plot <- "V"
yesR.p.V.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=plot.capacity, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.V.0)

var.to.plot <- "D"
yesR.p.D.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)
#ggplotly(p.D.0)

var.to.plot <- "I"
yesR.p.I.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)

var.to.plot <- "Itot"
yesR.p.Itot.0 <- plot.model.single(traj.CI=traj.0, data.in=data.in.tmp, init.date.data="2020-03-01", date.offset.4plot=15, 
                           time.steps.4plot=time.steps.4plot, ymax=ymax, plot.capacity=NULL, var.to.plot=var.to.plot,use.title=use.title,
                           scenario=scenario, intervention_date=intervention_date, sd.redux=sd.redux)


```

# Model Projections

## By Key Compartments {.tabset}

**Demonstrating detailed model projections (numbers in compartments over time, over time) for Los Angeles, for the following key variables/compartments:**

- Current census in Hospital
- Current census in ICU
- Current census Ventilated
- Cumulative Deaths
- Current Illnesses: Observed/Detected
- Current Total Illnesses: Observed + Unobserved

Projections are shown as the median number in compartments over time, with the 50% and 95% Confidence Intervals. Projections are shown against data for variables where data is available. Key healthcare capacity limits (hospital beds, ICU beds, ventilators) are indicated for Los Angeles County.

### Current in Hospital

**The dashed line represents healthcare resource capacity limits.**

```{r, echo=FALSE}
ggplotly(yesR.p.H.0)

```

### Current in ICU

**The dashed line represents healthcare resource capacity limits.**

```{r, echo=FALSE}
ggplotly(yesR.p.Q.0)

```

### Current in Ventilation

**The dashed line represents healthcare resource capacity limits.**

```{r, echo=FALSE}
ggplotly(yesR.p.V.0)

```

### Cumulative Deaths

**The black dots depict COVID-19 data, with counts from outbreaks in nursing homes removed** (for more details see [Data](https://uscbiostats.github.io/COVID19/method.html#data)).

```{r, echo=FALSE}
ggplotly(yesR.p.D.0)

```

### Current Observed Illnesses

**The black dots depict COVID-19 data, with counts from outbreaks in nursing homes removed** (for more details see [Data](https://uscbiostats.github.io/COVID19/method.html#data)).

```{r, echo=FALSE}
ggplotly(yesR.p.I.0)

```

### Current Total Illnesses (Observed + Unobserved)
```{r, echo=FALSE}
ggplotly(yesR.p.Itot.0)

```

## Against Data {.tabset}

**Summarizing model fit against COVID-19 data for Los Angeles, for all variables/compartments. Each variable/compartment can be tracked according to three views:**

* **New = new daily incidence**. Unstable but relevant for interpreting immediate trends.
* **Current = current census in compartment**. Relevant for comparing with healthcare capacity limitations.
* **Cumulative = running total over time**. Provides understanding of longer term trends.

These figures provide a summarizing view across all model variables. More detailed projections of key variables are provided in the section above.

### Short time horizon

**The black dots depict COVID-19 data, with counts from outbreaks in nursing homes removed** (for more details see [Data](https://uscbiostats.github.io/COVID19/method.html#data)).

**The dashed line represents healthcare resource capacity limits.**

```{r all-150days, echo=FALSE}

yesR.plot.all.variables.current.scenario.150days

```

### Longer time horizon

**The black dots depict COVID-19 data, with counts from outbreaks in nursing homes removed** (for more details see [Data](https://uscbiostats.github.io/COVID19/method.html#data)).

**The dashed line represents healthcare resource capacity limits.**

```{r all-300days, echo=FALSE}

yesR.plot.all.variables.current.scenario.300days

```

## Summary Table
### Posterior parameter estimates for key variables 
Median and 95% CI displayed

```{r, echo=FALSE}

# kable(summary_table) %>%
#   kable_styling(bootstrap_options = "striped", full_width = F)

summary_table2 <- as.data.frame(t(summary_table))
formattable(summary_table2,
            align=rep("c",NCOL(summary_table2)),
            list(`Case Fatality Rate: Observed` = percent,
                 `Case Fatality Rate: True, Estimated` = percent,
                 `r, fraction obs. illnesses` = percent,
                 `R0 fraction reduction` = percent,
                 `Pr(Hospital|Illness)` = percent,
                 `Pr(ICU|Hospital)` = percent,
                 `Pr(Death|ICU)` = percent)
            
)


```

```{r calc-risk-probs-initial, include=FALSE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

calc_risk_probs_code <- path(code.dir, "calc_risk_probs_042220.R")
r_output(readLines(calc_risk_probs_code))
source(calc_risk_probs_code)

```


```{r load.data, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220

## import prevalence by profile
data <- as.data.frame(profile.cnt.SPAs)
dataH <- as.data.frame(H.profile.share.relative.all.SPAs)
dataQ <- as.data.frame(Q.profile.share.relative.all.SPAs)
dataD <- as.data.frame(D.profile.share.relative.all.SPAs)

## import the probability by profile
Pr.H <- Pr.H #Pr.H.orig
Pr.Q <- Pr.Q #Pr.Q.orig
Pr.D <- Pr.D #Pr.D.orig

SPA.data <- risk.probs.SPAs

## Data from estimated SEIR model (traj.CI.out) ##################################################
traj.CI.out <- traj.0

# CLEAN AND PROCESS DATA
## Note: The 5 risk groups are assigned within this code
##       Currently are grouped according to Pr(D|Q).
##       To modify the risk grouping cutoffs see the end of this code.
clean_data_risk_estimates <- path(code.dir, "clean_data_risk_estimates.R")
r_output(readLines(clean_data_risk_estimates))
source(clean_data_risk_estimates)

```

```{r risk-profile-table, echo=FALSE}

unit.scale = function(x) (x - min(x)) / (max(x) - min(x))

data_subset <- subset(data, select = c(riskprofile,  age, BMI, smoking, comorbidity, `LA County`,  Pr.H, Pr.Q, Pr.D))
data_subset <- arrange(data_subset, desc(data_subset$"LA County"))

#risk_table <- as.datatable(formattable(subset(data2, select = c(riskprofile,  age, BMI, smoking, comorbidity, `LA County`,  Pr.H, Pr.Q, Pr.D)), 
risk_table <- as.datatable(formattable(data_subset, align="r",
            align = c(rep("c", 9)),
            list(
  `age`= color_tile('yellow', 'darkorange'),
  `BMI`= color_tile('lightblue', 'pink'),
  `smoking`= color_tile('grey', 'transparent'),
  `comorbidity`= color_tile('darkgrey', 'transparent'),
  `riskprofile`= color_tile('red', 'green'),
  `LA County`= color_bar('cornflowerblue', fun = unit.scale),
  `Pr.H`= color_bar('violet', fun = unit.scale),
  `Pr.Q`= color_bar('violet', fun = unit.scale),
  `Pr.D`= color_bar('violet', fun = unit.scale)
)), rownames = FALSE, colnames = c('Population Prevalence in L.A.County' = 'LA County', 'Age' = 'age', 'BMI status' = 'BMI', 'Smoking status' = 'smoking', 'Existing comorbidities' = 'comorbidity', 'Risk Group' = 'riskprofile', 'Pr(Hospital|Illness)' = 'Pr.H', 'Pr(ICU|Hospital)' = 'Pr.Q', 'Pr(Death|ICU)' = 'Pr.D' ), 
#filter = 'bottom', 
options = list(pageLength = 10, 
               autoWidth = TRUE) 
               # order = list(list(9, 'desc'),list(8,'desc'),list(7,'desc')))
               #order = list(list(6, 'desc'), list(7, 'desc'), list(8, 'desc')))
               #order(data2$"LA County",decreasing=TRUE))
)

```

```{r plotting-stacked-bars, include=FALSE}

## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################

data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$SPA.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$SPA.Name <- factor(data.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'SPA.Name' ) )


## 1) Risk profile in general population #######################################################################################

p.risk.gen <-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in general population by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))


p.BMI.gen <- 
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in general population by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.gen<-
ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in general population by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.gen<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in general population by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.gen<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.gen.pop, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in general population by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

## 2) Risk profile in hospitalized population #######################################################################################

p.risk.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in hospitalized by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in hospitalized by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in hospitalized by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in hospitalized by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.h<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.H, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in hospitalized by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

## 3) Risk profile in ICU population #######################################################################################

p.risk.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in ICU by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in ICU by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in ICU by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in ICU by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.q<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.Q, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in ICU by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))


## 4) Risk profile in deceased #######################################################################################

p.risk.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in deceased by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in deceased by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in deceased by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.age.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in deceased by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.d<-
  ggplot(data = full.data, aes(x=SPA.Name, y = prevalence.D, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in deceased by SPA", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))

```

```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>% 
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))


## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.SPA <- c(`Antelope Valley` = 'Antelope Valley' , `San Fernando` = 'San Fernando' , `San Gabriel`= 'San Gabriel' , Metro = 'Metro', West = 'West', South = 'South', East = 'East', `South Bay` = 'South Bay' , `LA County` = 'LA County')

p.prev.risk.stage.SPAs<- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    facet_wrap(SPA.Name ~ ., labeller=labeller(SPA.Name = labels.SPA)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and SPAs", x = NULL, y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

### Risk profiles, comorbidity, age, obesity by stage of disease for LA County ##############################################################  

LA.data <- subset(full.data, SPA.Name == 'LA County')

p.riskprofiles<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk Profiles By Stage of Disease", x = NULL, y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI<-
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Obesity By Stage of Disease", x = NULL, y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.age<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = age)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Age By Stage of Disease", x = NULL, y = "Age") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.comb<- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Any Comorbidity By Stage of Disease", x = NULL, y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

p.smoking<-
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = "Smoking Status By Stage of Disease", x = NULL, y = "Smoking") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

```

# Projections for At-Risk Groups

## By Risk Factors {.tabset}

- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County/SPA population, based on the population prevalence of the risk group in L.A. County/SPAs. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

### By SPA, stage of disease
```{r, echo=FALSE}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d + plot_layout(guides = 'collect')
```

### By stage of disease, SPA
```{r, echo=FALSE}
p.prev.risk.stage.SPAs
```

### Comparing risk factors
```{r, echo=FALSE}
p.riskprofiles + p.comb + p.age + p.BMI
```

### Age by stage of disease
```{r, echo=FALSE}
p.age.gen + p.age.h + p.age.q + p.age.d +
  plot_layout(guides = 'collect')

```

### Comorbidity by stage of disease
```{r, echo=FALSE}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d +
  plot_layout(guides = 'collect')

```

### BMI by stage of disease
```{r, echo=FALSE}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d +
  plot_layout(guides = 'collect')

```

### Smoking by stage of disease
```{r, echo=FALSE}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d +
  plot_layout(guides = 'collect')

```

```{r trajectory-process-clean, include=FALSE}

## PROCESS TRAJ.OUT TO FIND MEAN  ############################################################################
H.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Htot"))
Q.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Q"))
D.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("D"))

H.median$H <- H.median$median
H.median$median <- NULL
H.median$state.name <- NULL
Q.median$Q <- Q.median$median
Q.median$median <- NULL
D.median$D <- D.median$median
D.median$median <- NULL
HQD.median <- cbind(cbind(H.median,Q.median$Q),D.median$D)
colnames(HQD.median) <- c("date","H","Q","D")

## FIX DATES ##################################################################
HQD.median$date <- as.Date(HQD.median$date)

## ORGANIZE / CLEAN ##################################################################
HQD.median2 <- HQD.median
HQD.median2$Hospitalizations <- HQD.median2$H
HQD.median2$H <- NULL
HQD.median2$ICU <- HQD.median2$Q
HQD.median2$Q <- NULL
HQD.median2$Deaths <- HQD.median2$D
HQD.median2$D <- NULL
HQD.median2 <- melt(HQD.median2,id = 'date')
HQD.median2$Stage <- HQD.median2$variable
HQD.median2$variable <- NULL

```

```{r trajectory-groupby.risk, include=FALSE}

## 1A) GROUP BY RISK PROFILES  ############################################################################

str(HQD.median2)

#pull the total for each risk profile by stage

grouped.by.risk <- full.data %>% 
  dplyr::group_by(stage, riskprofile, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.risk$stage <- factor(grouped.by.risk$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.Q"] <- "ICU"
grouped.by.risk$stage[grouped.by.risk$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.risk <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.risk,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_risk=round(count*prop,3))


```

```{r trajectory-plotby.risk, include=FALSE}

## 1B) PLOT BY RISK PROFILES  ############################################################################


#Hospitalizations

p.traj.risk.h<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Risk Profile for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.risk.q<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Risk Profile for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.risk.d<-
  ggplot(filter(count.risk, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_risk,
           fill = riskprofile)) +
  geom_area() +
  scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Risk Profile for LA County",
       x = NULL,
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.risk.h + p.traj.risk.q + p.traj.risk.d

```

```{r trajectory-groupby.comb, include=FALSE}

## 2A) GROUP BY COMORBIDITY  ############################################################################

#pull the total for each risk profile by stage

grouped.by.comb <- full.data %>% 
  dplyr::group_by(stage, comorbidity, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.comb$stage <- factor(grouped.by.comb$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.Q"] <- "ICU"
grouped.by.comb$stage[grouped.by.comb$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.comb <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.comb,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_comb=round(count*prop,3))


```

```{r trajectory-plotby.comb, include=FALSE}

## 2B) PLOT BY COMORBIDITY  ############################################################################

p.traj.comb.h<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Comorbidity Status for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.comb.q<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Comorbidity Status for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.comb.d<-
  ggplot(filter(count.comb, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_comb,
           fill = comorbidity)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Comorbidity Status for LA County",
       x = NULL,
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.comb.h + p.traj.comb.q + p.traj.comb.d

```

```{r trajectory-groupby.age, include=FALSE}

## 3A) GROUP BY AGE  ############################################################################

#pull the total for each risk profile by stage

grouped.by.age <- full.data %>% 
  dplyr::group_by(stage, age, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.age$stage <- factor(grouped.by.age$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.age$stage[grouped.by.age$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.age$stage[grouped.by.age$stage == "prevalence.Q"] <- "ICU"
grouped.by.age$stage[grouped.by.age$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.age <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.age,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_age=round(count*prop,3))


```

```{r trajectory-plotby.age, include=FALSE}

## 3B) PLOT BY AGE  ############################################################################

p.traj.age.h<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Age for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.age.q<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Age for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.age.d<-
  ggplot(filter(count.age, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_age,
           fill = age)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Age for LA County",
       x = NULL,
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#p.traj.age.h + p.traj.age.q + p.traj.age.d

```

```{r trajectory-groupby.BMI, include=FALSE}

## 4A) GROUP BY BMI  ############################################################################

#pull the total for each risk profile by stage

grouped.by.BMI <- full.data %>% 
  dplyr::group_by(stage, BMI, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.BMI$stage <- factor(grouped.by.BMI$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.Q"] <- "ICU"
grouped.by.BMI$stage[grouped.by.BMI$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.BMI <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.BMI,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_BMI=round(count*prop,3))


```

```{r trajectory-plotby.BMI, include=FALSE}

## 4B) PLOT BY COMORBIDITY  ############################################################################

p.traj.BMI.h<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Obesity Status for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.BMI.q<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Obesity Status for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.BMI.d<-
  ggplot(filter(count.BMI, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_BMI,
           fill = BMI)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Obesity Status for LA County",
       x = NULL,
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

```

```{r trajectory-groupby.smoke, include=FALSE}

## 4A) GROUP BY SMOKING  ############################################################################

#pull the total for each risk profile by stage

grouped.by.smoke <- full.data %>% 
  dplyr::group_by(stage, smoking, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

#Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
grouped.by.smoke$stage <- factor(grouped.by.smoke$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
#HQD.median2$Stage <- factor(HQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.H"] <- "Hospitalizations"
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.Q"] <- "ICU"
grouped.by.smoke$stage[grouped.by.smoke$stage == "prevalence.D"] <- "Deaths"


#break down daily count by risk profile

count.smoke <- left_join(
  HQD.median2 %>% dplyr::rename(count=value), 
  grouped.by.smoke,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_smoke=round(count*prop,3))


```

```{r trajectory-plotby.smoking, include=FALSE}

## 4B) PLOT BY COMORBIDITY  ############################################################################

p.traj.smoke.h<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "Hospitalizations"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Hospitalizations by Obesity Status for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.smoke.q<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "ICU"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "ICU by Obesity Status for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.smoke.d<-
  ggplot(filter(count.smoke, SPA.Name == 'LA County' & Stage == "Deaths"), 
       aes(x = date,
           y = count_smoke,
           fill = smoking)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Deaths by Obesity Status for LA County",
       x = NULL,
       y = "Number deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
                 strip.text.x = element_text(size = 12, face = "bold"))

```

## Across risk factors {.tabset}

Fraction of all LA County Cases by risk factor 

### By risk group
```{r, echo=FALSE, message=FALSE}
(p.traj.risk.h + p.traj.risk.q) / p.traj.risk.d +
  plot_layout(guides = 'collect')
```

### By age
```{r, echo=FALSE, message=FALSE}
(p.traj.age.h + p.traj.age.q) / p.traj.age.d +
  plot_layout(guides = 'collect')
```

### By comorbidity
```{r, echo=FALSE, message=FALSE}
(p.traj.comb.h + p.traj.comb.q) / p.traj.comb.d +
  plot_layout(guides = 'collect')
```

### By obesity status
```{r, echo=FALSE, message=FALSE}
(p.traj.BMI.h + p.traj.BMI.q) / p.traj.BMI.d +
  plot_layout(guides = 'collect')
```

### By smoking status
```{r, echo=FALSE, message=FALSE}
(p.traj.smoke.h + p.traj.smoke.q) / p.traj.smoke.d +
  plot_layout(guides = 'collect')
```

## By race/ethnicity {.tabset}

```{r calc-risk-probs-race, include=FALSE}
###################################################################################################
## (1) PR(H) PR(Q) PR(D) ESTIMATION (PRIORS)
###################################################################################################

calc_risk_probs_RACE <- path(code.dir, "calc_risk_probs_SPA_race2.R")
r_output(readLines(calc_risk_probs_RACE))
source(calc_risk_probs_RACE)

```


```{r load.data.race, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220

##import prevalence by profile
data <- as.data.frame(profile.cnt.races)
dataH <- as.data.frame(H.profile.share.relative.all.races)
dataQ <- as.data.frame(Q.profile.share.relative.all.races)
dataD <- as.data.frame(D.profile.share.relative.all.races)

race.data <- risk.probs.races

### Data from estimated SEIR model (traj.CI.out) ##################################################
traj.CI.out <- traj.0

# CLEAN AND PROCESS DATA
## Note: The 5 risk groups are assigned within this code
##       Currently are grouped according to Pr(D|Q).
##       To modify the risk grouping cutoffs see the end of this code.
clean_data_risk_estimates_race <- path(code.dir, "clean_data_risk_estimates_race.R")
#r_output(readLines(clean_data_risk_estimates))
source(clean_data_risk_estimates_race)

```


```{r plotting-stacked-bars.race, include=FALSE}

## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################

data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$race.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$race.Name <- factor(data.melted$race.Name, levels =  c(rownames(race.data)))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'race.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'race.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'race.Name' ) )


## 1) Risk profile in general population #######################################################################################

p.risk.gen <-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in general population by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))


p.BMI.gen <- 
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in general population by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.gen<-
ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in general population by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.gen<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in general population by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.gen<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.gen.pop, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in general population by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

## 2) Risk profile in hospitalized population #######################################################################################

p.risk.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in hospitalized by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in hospitalized by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in hospitalized by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in hospitalized by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.h<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.H, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in hospitalized by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

## 3) Risk profile in ICU population #######################################################################################

p.risk.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in ICU by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in ICU by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in ICU by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in ICU by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.q<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.Q, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in ICU by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))


## 4) Risk profile in deceased #######################################################################################

p.risk.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    labs(title = "Risk profiles in deceased by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.BMI.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = BMI)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Obesity in deceased by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.comb.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = comorbidity)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Comorbidity in deceased by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.age.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = age)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Age in deceased by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

p.smoke.d<-
  ggplot(data = full.data, aes(x=race.Name, y = prevalence.D, fill = smoking)) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = "Smoking in deceased by race", x = NULL, y = "Prevalence") + 
    scale_x_discrete(labels = c(rownames(race.data))) +
    theme(axis.text.x = element_text(angle = 45))

```

```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>% 
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))


## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.race <- c(`Latino`= "Latinx" , `White`="White", `Black`= "Black", `American Indian`="American Indian", `Asian`= "Asian", `Native Hawaiian`="Native Hawaiian", `Other`="Other")

p.prev.risk.stage.races<- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
    facet_wrap(race.Name ~ ., labeller=labeller(race.Name = labels.race)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and races", x = NULL, y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

```


- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within each race/ethnicity population, based on the population prevalence of the risk group in race/ethnicity groups. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

### Risk groups by stage of disease, race
```{r, echo=FALSE}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d +
  plot_layout(guides = 'collect')

```

### Risk groups by race, stage of disease
```{r, echo=FALSE}
p.prev.risk.stage.races
```

### Age by stage of disease, race
```{r, echo=FALSE}
p.age.gen + p.age.h + p.age.q + p.age.d +
  plot_layout(guides = 'collect')

```

### Comorbidity by stage of disease, race
```{r, echo=FALSE}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d +
  plot_layout(guides = 'collect')

```

### BMI by stage of disease, race
```{r, echo=FALSE}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d +
  plot_layout(guides = 'collect')

```

### Smoking by stage of disease, race
```{r, echo=FALSE}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d +
  plot_layout(guides = 'collect')

```

```{r illness-severity-by-race,include=FALSE}

########################################################################################################################################################
########################################################################################################################################################
## BAR CHART COMPARISONS
########################################################################################################################################################
########################################################################################################################################################

Pr.H.races <- H.risk.all.races
Pr.Q.races <- Q.risk.all.races
Pr.D.races <- D.risk.all.races
nlevels <- length(Pr.H.races)

Pr.pop <- race.pop

# calculate relative shares in population, H, Q, D by race
relative.shares.races <- calc.HQD.shares(Pr.pop=Pr.pop,Pr.H=Pr.H.races,Pr.Q=Pr.Q.races,Pr.D=Pr.D.races)
rownames(relative.shares.races) <- race.order

# process data for easy ggplot input
relative.shares.races.melted <- melt(relative.shares.races, id=c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))
relative.shares.races.melted$group <-relative.shares.races.melted$X1
relative.shares.races.melted$stage <-relative.shares.races.melted$X2
relative.shares.races.melted$values <-relative.shares.races.melted$value
relative.shares.races.melted$X1 <- NULL
relative.shares.races.melted$X2 <- NULL
relative.shares.races.melted$value <- NULL

relative.shares.races.melted <- relative.shares.races.melted %>% mutate(Race=factor(group,levels=c(race.order)))

######################################
## Bar chart

p.shares.races<-
  relative.shares.races.melted %>%
  mutate(stage = factor(stage, levels=c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))) %>%
  ggplot( aes(x=stage, y=values,fill=Race)) +
#  ggplot( aes(x=stage,y=values,fill=factor(group,levels=c(race.order))))+
  geom_bar(position="stack", stat = 'identity')+
  labs(title = "Model-Projected Relative Proportion (%) of Race/Ethnicity \n by Stage of Disease", x = NULL, y = "Relative Proportion (%)", legend="Race/Ethnicity") +
  scale_x_discrete(labels = c("Population % \n (baseline)","Hospitalized %","ICU admittance %","Deaths %"))




##############################################################################################################################
## Compare projected D to observed D
race_file <- sort(dir_ls(data.dir, regexp = "race_D_"), decreasing = TRUE)[1]

race_observed_D = read.csv(race_file, sep=",", header=TRUE,row.names = 1 )
start.date.race <- as.Date("2020-03-28")
no.obs.race <- ncol(race_observed_D)
step.race <- seq(1:no.obs.race)
colnames.race <- start.date.race + step.race
colnames(race_observed_D) <- colnames.race

race_prevalence_gen_pop <- relative.shares.races[,"prevalence.gen.pop"]
race_model_D <- relative.shares.races[,"prevalence.D"]

D.dates.select <- c("2020-04-16", "2020-05-01", "2020-05-11", "2020-05-17", "2020-05-20")
race_observed_D_select <- race_observed_D %>% select(D.dates.select)
race_obs_D <- apply(race_observed_D_select, 2, function(x) round(x/sum(x),4))

relative.shares.races.D.obs <- as.data.frame(cbind(race_prevalence_gen_pop,race_obs_D,race_model_D))
colnames.race.D <- c("prevalence.gen.pop", paste0("obs.D.",D.dates.select), "model.D")
colnames(relative.shares.races.D.obs) <- colnames.race.D

# process data for easy ggplot input
relative.shares.races.D.obs.melted <- melt(as.matrix(relative.shares.races.D.obs))
relative.shares.races.D.obs.melted$race <-relative.shares.races.D.obs.melted$X1
relative.shares.races.D.obs.melted$stage <-relative.shares.races.D.obs.melted$X2
relative.shares.races.D.obs.melted$values <-relative.shares.races.D.obs.melted$value
relative.shares.races.D.obs.melted$X1 <- NULL
relative.shares.races.D.obs.melted$X2 <- NULL
relative.shares.races.D.obs.melted$value <- NULL

######################################
## Bar chart

relative.shares.races.D.obs.melted <- relative.shares.races.D.obs.melted %>% mutate(Race=factor(race,levels=c(race.order)))

labels.shares.races.D <- c("% in \n population", paste0("Obs.Deaths \n",D.dates.select), "Model Est.\n Deaths ")

p.shares.races.D.obs<-
  relative.shares.races.D.obs.melted %>%
  mutate(stage = factor(stage, levels=colnames.race.D)) %>%
  ggplot( aes(x=stage, y=values,fill=Race)) +
#  ggplot( aes(x=stage,y=values,fill=factor(group,levels=c(race.order))))+
  geom_bar(position="stack", stat = 'identity')+
  labs(title = "Deaths by Race/Ethnicity: Model Projection vs. Observed", x = "Projection (Model) or Observation (Data)", y = "Relative % by Race", legend="Race/Ethnicity") +
  scale_x_discrete(labels = labels.shares.races.D)


```


```{r trajectory-process-clean.race, include=FALSE}

########################################################################################################################################################
########################################################################################################################################################
## TRAJECTORIES
########################################################################################################################################################
########################################################################################################################################################

## PROCESS MODEL PROJECTS DATA TO GET MEAN/MEDIAN  ############################################################################
I.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Idetectcum"))
H.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Htot"))
Q.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("Q"))
D.median <- traj.CI.out %>% select(c(date,state.name,median)) %>% filter(state.name==c("D"))

I.median$I <- I.median$median
I.median$median <- NULL
H.median$H <- H.median$median
H.median$median <- NULL
H.median$state.name <- NULL
Q.median$Q <- Q.median$median
Q.median$median <- NULL
D.median$D <- D.median$median
D.median$median <- NULL

IHQD.median <- cbind(I.median,H.median$H,Q.median$Q,D.median$D)
IHQD.median$state.name = NULL
colnames(IHQD.median) <- c("date","I","H","Q","D")

## FIX DATES ##################################################################
IHQD.median$date <- as.Date(IHQD.median$date)

## ORGANIZE / CLEAN ##################################################################
IHQD.median2 <- IHQD.median
IHQD.median2$Illnesses <- IHQD.median2$I
IHQD.median2$I <- NULL
IHQD.median2$Hospitalizations <- IHQD.median2$H
IHQD.median2$H <- NULL
IHQD.median2$ICU <- IHQD.median2$Q
IHQD.median2$Q <- NULL
IHQD.median2$Deaths <- IHQD.median2$D
IHQD.median2$D <- NULL
IHQD.median2 <- melt(IHQD.median2,id = 'date')
IHQD.median2$Stage <- IHQD.median2$variable
IHQD.median2$variable <- NULL


## MERGE WITH COUNTS  ############################################################################

str(IHQD.median2)

#Add all the factor names so we can rename the factors in the dataframe to match the daily count
TEST <- relative.shares.races.melted
TEST$stage <- factor(TEST$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D","Illnesses", "Hospitalizations", "ICU", "Deaths"  ))
IHQD.median2$Stage <- factor(IHQD.median2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Illnesses", "Hospitalizations", "ICU", "Deaths"  ))

#match the daily count naming
TEST$stage[TEST$stage == "prevalence.gen.pop"] <- "Illnesses"
TEST$stage[TEST$stage == "prevalence.H"] <- "Hospitalizations"
TEST$stage[TEST$stage == "prevalence.Q"] <- "ICU"
TEST$stage[TEST$stage == "prevalence.D"] <- "Deaths"

#break down daily count by race shares
count.races <- left_join(
  IHQD.median2 %>% dplyr::rename(count=value), 
  TEST,
  by = c("Stage" = "stage")
) %>% 
  dplyr::rename(prop=values) %>% 
  mutate(count_races=round(count*prop,3))


## PLOT BY RISK PROFILES  ############################################################################

#Population

p.traj.race.I<-
  ggplot(filter(count.races, Stage == "Illnesses"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  #scale_fill_manual("legend", values = c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")) + 
  labs(title = "Projected Cumulative Illnesses by Race/Ethnicity (by population share)",
       x = NULL,
       y = "Cumulative Illnesses") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#Hospitalizations

p.traj.race.H<-
  ggplot(filter(count.races, Stage == "Hospitalizations"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected Hospitalizations by Race/Ethnicity for LA County",
       x = NULL,
       y = "Number in Hospital") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#ICU

p.traj.race.Q<-
  ggplot(filter(count.races, Stage == "ICU"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected ICU by Race/Ethnicity for LA County",
       x = NULL,
       y = "Number in ICU") +
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

#Death

p.traj.race.D<-
  ggplot(filter(count.races, Stage == "Deaths"), 
         aes(x = date,
             y = count_races,
             fill = Race)) +
  geom_area() +
  labs(title = "Projected Deaths by Race/Ethnicity for LA County",
       x = NULL,
       y = "Number Deceased")+
  scale_x_date(limits = as.Date(c("2020-03-01","2020-09-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
  theme(axis.text.x = element_text(angle = 90), 
        strip.text.x = element_text(size = 12, face = "bold"))

```

## Across race/ethnicity {.tabset}

- These figures demostrate the projections of the relative share of hospitalizations, ICU admissions, and deaths by race/ethnicity from our model, which accounts for biological risk factors for COVID-19. Values are compared with the baseline distribution of the relative share of the L.A. County population in each race/ethnicity group.
- Due to disparities in the prevalence of the risk factors for COVID-19 (health conditions, health behaviors, and age) the relative risk of hospitalization, ICU admittance, and death is not distributed equally across each race/ethnicity (i.e., is not distributed in accordance with the population distribution).

### Deaths by race: Model projections vs. observed LA data

- This figure compares model projections of the relative share of deaths by race/ethnicity (right-most bar) with the observed relative share of deaths by race/ethnicity in L.A. County. The population prevalence of each race/ethnicity is also provided as a baseline (left-most bar). 

- A key insight from this figure is that as the epidemic evolves, the trend of the distribution of deaths by race/ethnicity appears to be converging to the expected distribution based on the biological risk factors for COVID-19, as calculated by our model. Time will tell if this distribution stabilizes or if the relative share of each race/ethnicity grows disproportionately to that expected by biological factors, indicating the role of other factors in determining the illness dynamics.

```{r, echo=FALSE, message=FALSE}

p.shares.races.D.obs

```

### Projected illness severity by race
```{r, echo=FALSE, message=FALSE}

p.shares.races

```

### Projected timeseries by race and stage of disease
```{r, echo=FALSE, message=FALSE}

p.traj.race.I + p.traj.race.H + p.traj.race.Q + p.traj.race.D +
  plot_layout(guides = 'collect')

```

## {-}

