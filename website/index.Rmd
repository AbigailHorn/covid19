---
title: "USC Predict COVID Project: \n Predictive Epidemic Model for COVID-19 in Los Angeles County"
author: "Abigail Horn, PhD^[abigail.horn@usc.edu], Lai Jiang, MS, Wendy Cozen, MD, David Conti, PhD"
date: "4/24/2020"
output: 
  html_document:
     css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = FALSE,
                      out.width = "100%",
                      fig.asp = 0.619, fig.width = 10,
                      dpi = 100)
```

```{r}
library(tidyverse)
library(patchwork)
library(here)
library(glue)
library(odin)
library(fitR)
library(knitr)
library(kableExtra)
library(formattable)
```

```{r}
source(here("code/supporting_functions.R"))
```


## Updated with data available as of April 25, 2020

# Summary

## Aims
### The USC Predict COVID project is using an epidemic model to estimate the impact of COVID-19 in Los Angeles County

We are addressing the key questions of:

- When will the peak of the epidemic occur and how will it impact health care capacity?
- What happens to the dynamics of the epidemic when social distancing ends? 
- How will the epidemic affect different at-risk groups?

## Why our model is unique

- Our epidemic compartmental model uses stochastic differential equations and approximate Bayes calculation techniques for parameter estimation.
- Importantly, the model presents the uncertainty in all estimations and predictions. 
- We incorporate prior information for parameter specification.
- We incorporate risk factors (e.g. advanced age, existing health conditions) into the analysis. 
- We can modify parameters at different time points, enabling the specification of interventions, e.g. social distancing scenarios

## Predictions and Estimation

### (1) Critical healthcare variables predicted by the model are the counts of the numbers of individuals over time, including the peak occurrence, for the following:

- The total number of infected cases including both the number detected and observed with testing and the undetected/untested cases
- The total number of individuals hospitalized (including those in the ICU)
- The number of patients in the ICU
- The number of patients on ventilators
- The number of deaths

### (2) We estimate a number of key epidemic parameters, including:
- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are detected and reported out of all illnesses
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness, i.e. $Pr(Hospital | Illness)$
- $\kappa$, the probability of ICU care necessary given hospitalization, i.e. $Pr(ICU | Hospital)$
- $p_v$, the probability of ventilation given ICU care, i.e. $Pr(Ventilation | ICU)$
- $\delta$, the probability of death given ICU care, i.e. $Pr(Death | ICU)$

### (3) We also provide predictions for the impact on counts and corresponding time periods under various **social distancing scenarios** in which restrictions are eased.

# Projections

## Current Projections: Summary of Key Model Estimated Variables

```{r}
ABC_out <- read_rds(here("website_results", "ABC_out.rds"))
risk.probs.SPAs <- read_rds(here("website_results", "risk.probs.SPAs.rds"))

Alpha.prior.mean <- risk.probs.SPAs[9, 1]
Kappa.prior.mean <- risk.probs.SPAs[9, 2]

abc_posteriors <- as.data.frame(ABC_out$param) %>%
  set_names(c("R0", "r", "st", "R0redux", "Delta", "Alpha", "Kappa", "p_V")) %>%
  pivot_longer(everything())

abc_priors <- tribble(
  ~param,    ~fun, ~var1, ~var2, ~range1, ~range2,
  "R0",      dnorm, 2.7, 0.3, 1, 4,
  "r",       dunif, .05, 0.3, 0, 0.5,
  "R0redux", dunif, .3, .55, .15,.7,
  "Alpha",   dunif, Alpha.prior.mean - (Alpha.prior.mean / 6), Alpha.prior.mean + (Alpha.prior.mean / 2), .05, .5,
  "Kappa",   dunif, Kappa.prior.mean - (Kappa.prior.mean / 6), Kappa.prior.mean + (Kappa.prior.mean / 2), .15, .7,
  "Delta",   dunif, .2, .8, .15, .9,
  "p_V",     dunif, 0.6, 0.9, .4, .95
) %>%
  pmap_dfr(function(param, fun, var1, var2, range1, range2) {
    x <- seq(range1, range2, length = 512)
    tibble(x,
           y = fun(x, var1, var2),
           param = param)
        })
```

```{r, include=FALSE}
###################################################################################################
## INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

obs_cum_new_counts = t(read.csv(here("data", "cum_counts_042420.csv"), sep=",",stringsAsFactors = FALSE)) 
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.character)
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.numeric)
no_obs <- dim(obs_cum_new_counts)[1]

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- here("code", "stochastic_SEIHQDR_A.R")

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

##############################################
## MODEL PROJECTIONS WITH ESTIMATED PARAMETERS
##############################################
ABC.par.out <- as.data.frame(ABC_out$param)

## DATA FORMAT FOR PLOTTING (BELOW)
data.in.tmp <- obs_cum_new_counts %>% dplyr::select(-c(H_capacity,Q_capacity))
```

```{r summary-table-compute, include=FALSE}
par.vec.length = 100
iter = 50
time.steps = 400
quick.facts.table <- model.output.to.table(ABC_out$param, par.vec.length, iter, 
                                           time.steps, init.date.data = "2020-01-03")
```

```{r, include=FALSE}
###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## COMPILE
x <- seihqdr_generator(Beta_t = Beta_t, Beta_y = Beta_y, S_ini = 1e7, 
                       E_ini = 10, r = r, Delta = Delta, Alpha = Alpha, 
                       Kappa = Kappa, p_QV = p_V)

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st + no_obs - 1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## SIMULATE AND PLOT ZOOMED
TEST <- as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
```

```{r summary-table-print, echo=FALSE}
kable(quick.facts.table, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Current Projections: Illnesses, Hospitalizations, ICU Admittances, Ventilation Requirements, Deaths {.tabset}

**Dashed line = Maximum possible capacity (i.e., total licensed hospital beds, ICU beds, ventilators) in L.A. County**

```{r, include=FALSE}
########################################################################################
## PLOTTING INPUT
########################################################################################

### IF PLOTTING ALL VARIABLES
all.variables <- c(
  "S",
  "Itot",
  "Itotcum",#
  "I",
  "Idetectcum",
  "Htot",
  "H_new",
  "Htotcum",
  "Q",
  "Qcum", #
  "V",
  "Vcum",
  "D",
  "D_new"
)

### IF ONLY PLOTTING VARIABLES AGAINST DATA
only.vars.with.data <- c(
  "Idetectcum",
  "H_new",
  "Htotcum",
  "Vcum",
  "D",
  "D_new"
)

 
traj.0 <- model.output.to.plot(ABC_out$param, 
                               par.vec.length = 100, 
                               iter = 50, 
                               time.steps = 400, 
                               vars.to.plot = all.variables, 
                               init.date.data = "2020-03-01", 
                               all = TRUE, 
                               scenario.selection = 0,
                               intervention_date = NULL,
                               sd.redux = NULL)


##################################################################
## Generate plots
##################################################################

forecast_plotting_function <- function(traj.CI,
                                       scenario,
                                       var.to.plot,
                                       intervention_date = NULL,
                                       sd.redux = NULL,
                                       use.title=NULL,
                                       plot.capacity=TRUE,
                                       ymax=NULL,
                                       time.steps.4plot = 350) {
 plot.model.single(traj.CI = traj.CI, 
                   data.in = data.in.tmp, 
                   init.date.data = "2020-03-01", 
                   date.offset.4plot = 15, 
                   time.steps.4plot = time.steps.4plot, 
                   ymax = ymax, 
                   plot.capacity = plot.capacity, 
                   var.to.plot = var.to.plot,
                   use.title = use.title,
                   scenario = scenario, 
                   intervention_date = intervention_date, 
                   sd.redux = sd.redux) 
}

```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:33.33333%">
<a class="nav-link active" data-toggle="tab" href="#paramtab1"><b>Hospitalizations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab2"><b>ICU Admittances By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab3"><b>Ventilations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab4"><b>Cumulative Deaths</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab5"><b>Observed Illnesses By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab6"><b>Total Illnesses By Time</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="paramtab1" class="tab-pane active">
```{r}
forecast_plotting_function(traj.0, 0, "Htot") + 
  plot_annotation(title = "Hospitalizations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab2" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "Q") + 
  plot_annotation(title = "ICU Admittances By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab3" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "V") + 
  plot_annotation(title = "Ventilations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab4" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "D", plot.capacity = NULL) + 
  plot_annotation(title = "Cumulative Deaths", 
                  caption = "L.A. data plotted as black dots", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab5" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "I", plot.capacity = NULL) + 
  plot_annotation(title = "*Observed* Illnesses By Time", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab6" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "Itot", plot.capacity = NULL) + 
  plot_annotation(title = "*Total* Illnesses By Time (Observed + Undetected)", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

</div>
</div>

# Model Fits Against Data

**Demonstrating model fit against COVID-19 data for Los Angeles, for the following variables:**

- Observed illnesses, cumulative
- Hospitalizations, cumulative
- Hospitalization, daily new incidence
- Ventilation, cumulative
- Deaths, cumulative
- Deaths, daily new incidence

**COVID-19 data is shown as black dots in the figures below.**

```{r input-for-plot-all-vars, include=FALSE}
scenario=0
intervention_date = NULL
sd.redux = NULL
number.pars.to.use = 200
iter = 50
time.steps = 400

# traj.0 <- model.output.to.plot(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = all.variables, 
#                                               init.date.data="2020-03-01", all=TRUE, 
#                                               scenario.selection =scenario,intervention_date=intervention_date,sd.redux=sd.redux)

# PLOTS OVER 1 YEAR
time.steps.4.plot = 350
## Plot all
plot.all.variables.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )

# PLOTS ZOOMED SHORTER TIME PERIOD
time.steps.4.plot = 150
## Plot all
plot.all.variables.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )
```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fittab1"><b>All variables, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab2"><b>All variables, 150 days</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab3"><b>Only variables with data, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab4"><b>Only variables with data, 150 days</b></a>
</li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fittab1" class="tab-pane active">
```{r}
plot.all.variables.current.scenario
```
</div>

<div id="fittab2" class="tab-pane">
```{r}
plot.all.variables.current.scenario.150days
```
</div>

<div id="fittab3" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario
```
</div>

<div id="fittab4" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario.150days
```
</div>

</div>
</div>

# Comparing Social Distancing Mitigation Strategies 

- Model projections forecast that, if everything continutes as is, LA is not going to see a sharp peak in illnesses in the near future, and rather will see a long, shallow, *manageable* epidemic curve over the next number of months.
- What can we do to maintain this manageable epidemic curve while sustaining a functioning society?
- Here we evaluate the effect of scenarios relating to social distancing on the ultimate epidemic trajectory 

## Scenario Comparison

```{r, include=FALSE}
## GET MODEL OUTPUT AND CALCULATE CI
## Specify scenario through:
## scenario.selection
## 0 = no scenario
## 1 = scenario
## intervention_date
## sd.redux: % reduction in contact rate due to social distancing 
## Output:
## Summary statistics by date and state.name (i.e. variable)

##################################################################
## Generate trajectory data
##################################################################

number.pars.to.use = 100
iter = 50
time.steps = 400

### SCENARIO: WHAT IF SOCIAL DISTANCING NEVER IMPLEMENTED
scenario = 1
intervention_date = NULL
sd.redux = NULL

traj.1 <- model.output.to.plot(ABC_out$param, 
                               par.vec.length = number.pars.to.use, 
                               iter = iter, 
                               time.steps = time.steps, 
                               vars.to.plot = all.variables, 
                               init.date.data = "2020-03-01", 
                               all = TRUE, 
                               scenario.selection = scenario,
                               intervention_date = intervention_date,
                               sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON MAY 1ST
scenario = 2
intervention_date = "2020-05-01"
sd.redux = 0.25
traj.2.May1.25 <- model.output.to.plot(ABC_out$param, 
                                       par.vec.length = number.pars.to.use, 
                                       iter = iter, 
                                       time.steps = time.steps, 
                                       vars.to.plot = all.variables, 
                                       init.date.data = "2020-03-01", 
                                       all = TRUE, 
                                       scenario.selection = scenario,
                                       intervention_date = intervention_date,
                                       sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON JUNE 1ST
scenario = 2
intervention_date = "2020-06-01"
sd.redux = 0.25
traj.2.June1.25 <- model.output.to.plot(ABC_out$param, 
                                        par.vec.length = number.pars.to.use,
                                        iter = iter, 
                                        time.steps = time.steps, 
                                        vars.to.plot = all.variables, 
                                        init.date.data = "2020-03-01",
                                        all = TRUE, 
                                        scenario.selection = scenario,
                                        intervention_date = intervention_date,
                                        sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON JULY 1ST
scenario = 2
intervention_date = "2020-07-01"
sd.redux = 0.25
traj.2.July1.25 <- model.output.to.plot(ABC_out$param, 
                                        par.vec.length = number.pars.to.use, 
                                        iter = iter, 
                                        time.steps = time.steps, 
                                        vars.to.plot = all.variables, 
                                        init.date.data = "2020-03-01", 
                                        all = TRUE, 
                                        scenario.selection = scenario,
                                        intervention_date = intervention_date,
                                        sd.redux = sd.redux)


### SCENARIO: DECREASE SOCIAL DISTANCING TO 0% ON MAY 1ST
scenario = 2
intervention_date = "2020-06-01"
sd.redux = 0
traj.2.June1.0 <- model.output.to.plot(ABC_out$param, 
                                       par.vec.length = number.pars.to.use, 
                                       iter = iter, 
                                       time.steps = time.steps, 
                                       vars.to.plot = all.variables, 
                                       init.date.data = "2020-03-01", 
                                       all = TRUE, 
                                       scenario.selection = scenario,
                                       intervention_date = intervention_date,
                                       sd.redux = sd.redux)

### SCENARIO: GRADUAL EASING OF SOCIAL DISTANCING BEGINNING JUNE 1ST
scenario = 3
intervention_date = "2020-06-01"
sd.redux = 0
traj.3.June1 <- model.output.to.plot(ABC_out$param, 
                                     par.vec.length = number.pars.to.use, 
                                     iter = iter, 
                                     time.steps = time.steps, 
                                     vars.to.plot = all.variables, 
                                     init.date.data = "2020-03-01", 
                                     all = TRUE, 
                                     scenario.selection = scenario,
                                     intervention_date = intervention_date,
                                     sd.redux = sd.redux)
```

```{r}
##################################################################
## Scenarios: generate plots
##################################################################

ymax.H <- 100000
ymax.D <- 200000

##################################################################
### SCENARIO 0 
p.H.0 <- forecast_plotting_function(traj.CI = traj.0, 
                                    scenario = 0, 
                                    var.to.plot = "Htot", 
                                    use.title = TRUE,
                                    ymax = ymax.H)

p.D.0 <- forecast_plotting_function(traj.CI = traj.0, 
                                    scenario = 0, 
                                    var.to.plot = "D", 
                                    use.title = TRUE, 
                                    ymax = ymax.D, 
                                    plot.capacity = NULL)

##################################################################
### SCENARIO 1: WHAT IF SOCIAL DISTANCING NEVER IMPLEMENTED
p.H.1 <-forecast_plotting_function(traj.CI = traj.1, 
                                   scenario = 1, 
                                   var.to.plot = "Htot", 
                                   use.title = TRUE, 
                                   ymax = ymax.H)

p.D.1 <- forecast_plotting_function(traj.CI = traj.1, 
                                    scenario = 1, 
                                    var.to.plot = "D", 
                                    use.title = TRUE, 
                                    ymax = ymax.D, 
                                    plot.capacity = NULL)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON MAY 1ST
p.H.2.May1.25 <- forecast_plotting_function(traj.CI = traj.2.May1.25, 
                                            scenario = 2, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-05-01", 
                                            sd.redux = 0.25,
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.2.May1.25 <- forecast_plotting_function(traj.CI = traj.2.May1.25, 
                                            scenario = 2, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-05-01", 
                                            sd.redux = 0.25,
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON JUNE 1ST
p.H.2.June1.25 <- forecast_plotting_function(traj.CI = traj.2.June1.25, 
                                             scenario = 2, 
                                             var.to.plot = "Htot", 
                                             intervention_date = "2020-06-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             ymax = ymax.H)

p.D.2.June1.25 <- forecast_plotting_function(traj.CI = traj.2.June1.25, 
                                             scenario = 2, 
                                             var.to.plot = "D", 
                                             intervention_date = "2020-06-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             plot.capacity = NULL,
                                             ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON JULY 1ST
p.H.2.July1.25 <- forecast_plotting_function(traj.CI = traj.2.July1.25, 
                                             scenario = 2, 
                                             var.to.plot = "Htot", 
                                             intervention_date = "2020-07-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             ymax = ymax.H)

p.D.2.July1.25 <- forecast_plotting_function(traj.CI = traj.2.July1.25, 
                                             scenario = 2, 
                                             var.to.plot = "D", 
                                             intervention_date = "2020-07-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             plot.capacity = NULL,
                                             ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 0% ON JUNE 1ST
p.H.2.June1.0 <- forecast_plotting_function(traj.CI = traj.2.June1.0, 
                                            scenario = 2, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-06-01", 
                                            sd.redux = 0, 
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.2.June1.0 <- forecast_plotting_function(traj.CI = traj.2.June1.0, 
                                            scenario = 2, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-06-01", 
                                            sd.redux = 0, 
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)

##################################################################
### SCENARIO 3: GRADUAL EASING OF SOCIAL DISTANCING
p.H.3.June1 <- forecast_plotting_function(traj.CI = traj.3.June1, 
                                            scenario = 3, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-06-01", 
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.3.June1 <- forecast_plotting_function(traj.CI = traj.3.June1, 
                                            scenario = 3, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-06-01", 
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)
```


<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:50%">
<a class="nav-link active" data-toggle="tab" href="#Scenariotab1"><b>Counterfactual: No social distancing implemented</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab2"><b>Easing of social distancing from 50% to 25% on May 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab3"><b>Easing of social distancing from 50% to 25% on June 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab4"><b>Easing of social distancing from 50% to 25% on July 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab5"><b>Removal of social distancing on June 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab6"><b>Gradual easing of social distancing beginning on June 1st</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="Scenariotab1" class="tab-pane active">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and counterfactual: if social distancing had never been implemented**
```{r}
(p.H.0 + p.H.1) / (p.D.0 + p.D.1)
```
</div>

<div id="Scenariotab2" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on May 1, 2020**
```{r}
(p.H.0 + p.H.2.May1.25) / (p.D.0 + p.D.2.May1.25)
```
</div>

<div id="Scenariotab3" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on June 1, 2020**
```{r}
(p.H.0 + p.H.2.June1.25) / (p.D.0 + p.D.2.June1.25)
```
</div>

<div id="Scenariotab4" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on July 1, 2020**
```{r}
(p.H.0 + p.H.2.July1.25) / (p.D.0 + p.D.2.July1.25)
```
</div>

<div id="Scenariotab5" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and removal of social distancing on June 1, 2020**
```{r}
(p.H.0 + p.H.2.June1.0) / (p.D.0 + p.D.2.June1.0)
```
</div>

<div id="Scenariotab6" class="tab-pane">
**Comparison between policy of easing of social distancing from 50% to 25% on June 1, 2020 and gradual easing beginning June 1, 2020 of social distancing from 50% to no social distancing**
```{r}
(p.H.2.June1.0 + p.H.3.June1) / (p.D.2.June1.0 + p.D.3.June1)
```
</div>

</div>
</div>

# Projections by Key Risk Groups and Risk Factors 

- We analyze how population prevalence of known COVID-19 *risk factors*: advanced age, existence of other health conditions or comorbidities, smoking status, and obesity status, affect COVID-19 illness trajectories in L.A. County and spatial subdivisions.

- First, we estimate the conditional probability of COVID illness severity given combinations of risk factors. We categorize the population into a number of *risk profiles*, representing different combinations of known COVID-19 *risk factors*: advanced age, existence of other health conditions or comorbidities, smoking status, and obesity status. Using previous COVID-19 studies reporting the marginal risk of severe COVID-19 outcomes given individual risk factors, we develop a statistical model to estimate the probability of COVID illness trajectories for individuals having or not having combinations of risk factors represented by these *risk profiles*. Specifically, we estimate the probability that individuals within a specific risk group are admitted to hospital given having acquired illness $Pr(Hospital | Illness, Profile_i)$, are admitted to the ICU given admittance to hospitalized $Pr(ICU | Hospital, Profile_i)$, and that die given being admitted to the ICU $Pr(Death | ICU, Profile_i)$. More information is provided below under **Methods and Data**.

- For the analysis below, we have grouped the multiple *risk profiles* into 5 key *risk groups* according to similar within-group levels of the probabilities $Pr(Hospital | Illness, Profile_i)$, $Pr(ICU | Hospital, Profile_i)$, and $Pr(Death | ICU, Profile_i)$. 

- Second, we use these probabilities to estimate the proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County population, based on the prevalence of each risk group in the population.

- Results are also presented for each Service Planning Area (SPA) population within L.A. County. [A SPA is a specific geographical region within Los Angeles County used by the Department of Public Health to plan and provide health services](http://publichealth.lacounty.gov/chs/SPAMain/ServicePlanningAreas.htm). There are 8 SPAs in Los Angeles County. 

### Risk Profiles, Risk Factors, and Risk Groups

- The following table presents the model-estimated probabilities $Pr(Hospital | Illness,Profile_i)$, $Pr(ICU | Hospital,Profile_i)$, and $Pr(Death | ICU,Profile_i)$ for each risk group (or combination of risk factors), as well as the prevalence of these risk groups/factors in the general L.A. County Population $Pr(Profile_i)$.

```{r load.data, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220
profile.cnt.SPAs <- readr::read_csv(here("results", "ProfilePrev.GeneralPop.csv"))
H.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.HospitalPop.csv"))
Q.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.ICUPop.csv"))
D.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.DeadPop.csv"))

##import prevalence by profile
data <- as.data.frame(profile.cnt.SPAs)
dataH <- as.data.frame(H.profile.share.relative.all.SPAs)
dataQ <- as.data.frame(Q.profile.share.relative.all.SPAs)
dataD <- as.data.frame(D.profile.share.relative.all.SPAs)

#import the probability by profile
Pr.H <- read_csv(here("results", "Pr.H.BMI.csv"))
Pr.Q <- read_csv(here("results", "Pr.Q.BMI.csv"))
Pr.D <- read_csv(here("results", "Pr.D.BMI.csv"))

SPA.data <- risk.probs.SPAs

### Data from estimated SEIR model (traj.CI.out) ##################################################
traj.CI.out <- traj.0
```

```{r clean-process-data, include=FALSE}
# CLEAN AND PROCESS DATA

## 1) RENAME VARIABLES #############################################################################

#Change the profile numbers to factors and name the variable
Profile <- factor(seq(1,nrow(data)))
data <- cbind(data,Profile)

## dataH ##

#Change the profile numbers to factors and name the variable
dataH <- cbind(dataH,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataH$Age0.19 <- NULL
dataH$Age20.44 <- NULL
dataH$Age45.64 <- NULL  
dataH$Age65. <- NULL
dataH$ObesityBMI.30 <- NULL
dataH$ObesityBMI30.40 <- NULL
dataH$ObesityBMI.40 <- NULL
dataH$SmokingYes <- NULL
dataH$ComorbidityYes <- NULL
dataH$X1 <- NULL
  
#melt data
dataH.melted <- melt(dataH, id = 'Profile')
dataH.melted$SPA.Name <- dataH.melted$variable
dataH.melted$variable <- NULL
dataH.melted$SPA.Name <- factor(dataH.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataH.melted$prevalence.H <- dataH.melted$value
dataH.melted$value <- NULL

## dataQ ##

#Change the profile numbers to factors and name the variable
dataQ <- cbind(dataQ, Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataQ$Age0.19 <- NULL
dataQ$Age20.44 <- NULL
dataQ$Age45.64 <- NULL  
dataQ$Age65. <- NULL
dataQ$ObesityBMI.30 <- NULL
dataQ$ObesityBMI30.40 <- NULL
dataQ$ObesityBMI.40 <- NULL
dataQ$SmokingYes <- NULL
dataQ$ComorbidityYes <- NULL
dataQ$X1 <- NULL

#melt data
dataQ.melted <- melt(dataQ, id = 'Profile')
dataQ.melted$SPA.Name <- dataQ.melted$variable
dataQ.melted$variable <- NULL
dataQ.melted$SPA.Name <- factor(dataQ.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataQ.melted$prevalence.Q <- dataQ.melted$value
dataQ.melted$value <- NULL

## dataD ##

#Change the profile numbers to factors and name the variable
dataD <- cbind(dataD,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataD$Age0.19 <- NULL
dataD$Age20.44 <- NULL
dataD$Age45.64 <- NULL  
dataD$Age65. <- NULL
dataD$ObesityBMI.30 <- NULL
dataD$ObesityBMI30.40 <- NULL
dataD$ObesityBMI.40 <- NULL
dataD$SmokingYes <- NULL
dataD$ComorbidityYes <- NULL
dataD$X1 <- NULL


#melt data
dataD.melted <- melt(dataD, id = 'Profile')
dataD.melted$SPA.Name <- dataD.melted$variable
dataD.melted$variable <- NULL
dataD.melted$SPA.Name <- factor(dataD.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataD.melted$prevalence.D <- dataD.melted$value
dataD.melted$value <- NULL

## PrH ## 

#Change the profile numbers to factors and name the variable
Pr.H$Profile <- factor(seq_len(nrow(Pr.H)))

#Change the name of the variable "Pr" to a more detailed name
Pr.H$Pr.H <- Pr.H$Pr
Pr.H$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.H$Age0.19 <- NULL
Pr.H$Age20.44 <- NULL
Pr.H$Age45.64 <- NULL  
Pr.H$Age65. <- NULL
Pr.H$ObesityBMI.30 <- NULL
Pr.H$ObesityBMI30.40 <- NULL
Pr.H$ObesityBMI.40 <- NULL
Pr.H$SmokingYes <- NULL
Pr.H$ComorbidityYes <- NULL
Pr.H$X1 <- NULL

## PrQ ##

#Change the profile numbers to factors and name the variable
Pr.Q$Profile <- factor(seq_len(nrow(Pr.Q)))

#Change the name of the variable "Pr" to a more detailed name
Pr.Q$Pr.Q <- Pr.Q$Pr
Pr.Q$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.Q$Age0.19 <- NULL
Pr.Q$Age20.44 <- NULL
Pr.Q$Age45.64 <- NULL  
Pr.Q$Age65. <- NULL
Pr.Q$ObesityBMI.30 <- NULL
Pr.Q$ObesityBMI30.40 <- NULL
Pr.Q$ObesityBMI.40 <- NULL
Pr.Q$SmokingYes <- NULL
Pr.Q$ComorbidityYes <- NULL
Pr.Q$X1 <- NULL

## PrD ##

#Change the profile numbers to factors and name the variable
Pr.D$Profile <- factor(seq_len(nrow(Pr.D)))

Pr.D$Pr.D <- Pr.D$Pr
Pr.D$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.D$Age0.19 <- NULL
Pr.D$Age20.44 <- NULL
Pr.D$Age45.64 <- NULL  
Pr.D$Age65. <- NULL
Pr.D$ObesityBMI.30 <- NULL
Pr.D$ObesityBMI30.40 <- NULL
Pr.D$ObesityBMI.40 <- NULL
Pr.D$SmokingYes <- NULL
Pr.D$ComorbidityYes <- NULL
Pr.D$X1 <- NULL


## 2) DUMMY VARIABLES <- LEVELS ##################################################################
data$X1 <- NULL
data$age <- "Blank"
data$age[data$Age0.19==1] <- "0-19"
data$age[data$Age20.44==1] <- "20-44"
data$age[data$Age45.64==1] <- "45-64"
data$age[data$Age65.==1] <- "65+"
data$Age0.19 <- NULL
data$Age20.44 <- NULL
data$Age45.64 <- NULL
data$Age65. <- NULL
data$age <- factor(data$age, levels =  c("0-19", "20-44", "45-64", "65+"))

data$BMI <- "Blank"
data$BMI[data$ObesityBMI.30==1] <- "BMI<30"
data$BMI[data$ObesityBMI30.40==1] <- "30<BMI<40"
data$BMI[data$ObesityBMI.40==1] <- "BMI>40"
data$ObesityBMI.30 <- NULL
data$ObesityBMI30.40 <- NULL
data$ObesityBMI.40 <- NULL

data$BMI <- factor(data$BMI, levels =  c("BMI<30", "30<BMI<40", "BMI>40"))

data$smoking <- "Blank"
data$smoking[data$SmokingYes==1] <- "Smoker"
data$smoking[data$SmokingYes==0] <- "Non Smoker"
data$smoking <- factor(data$smoking, levels = c("Smoker", "Non Smoker"))

data$SmokingYes <- NULL

data$comorbidity <- "Blank"
data$comorbidity[data$ComorbidityYes==1] <- "Comorbidity"
data$comorbidity[data$ComorbidityYes==0] <- "No Comorbidity"
data$comorbidity <- factor(data$comorbidity, levels = c("Comorbidity", "No Comorbidity"))

data$ComorbidityYes <- NULL


## 3) MERGE DATASETS ##################################################################

data <- merge(data, Pr.H, by = "Profile")
data <- merge(data, Pr.Q, by = "Profile")
data <- merge(data, Pr.D, by = "Profile")


## 4) Create Risk Profile Groupings ##################################################################
### NOTE: Grouping done by death risk level
data$riskprofile <- "Blank"
data$riskprofile[data$Pr.D<.01] <- "Risk 5"
data$riskprofile[(data$Pr.D<.07) & (data$Pr.D>.01)] <- "Risk 4"
data$riskprofile[(data$Pr.D<.14) & (data$Pr.D>.07)] <- "Risk 3"
data$riskprofile[(data$Pr.D<.24) & (data$Pr.D>.14)] <- "Risk 2"
data$riskprofile[(data$Pr.D>.24)] <- "Risk 1"
# data$riskprofile[data$Pr.D<.01] <- "Risk 5"
# data$riskprofile[(data$Pr.D<.09) & (data$Pr.D>.01)] <- "Risk 4"
# data$riskprofile[(data$Pr.D<.19) & (data$Pr.D>.09)] <- "Risk 3"
# data$riskprofile[(data$Pr.D<.3) & (data$Pr.D>.19)] <- "Risk 2"
# data$riskprofile[(data$Pr.D>.3)] <- "Risk 1"
data$riskprofile <- factor(data$riskprofile, levels = c("Risk 1", "Risk 2", "Risk 3", "Risk 4", "Risk 5" ))

## Round all numeric variable to 3 digits
data <- data %>% 
  mutate_if(is.numeric, round, digits = 3)
```

```{r risk-profile-table, echo=FALSE}
unit.scale = function(x) (x - min(x)) / (max(x) - min(x))

as.datatable(formattable(subset(data, select = c(riskprofile,  age, BMI, smoking, comorbidity, `LA County`,  Pr.H, Pr.Q, Pr.D)), 
            align =c("l","l","l","l","l","l","l","c","c","c","l","l","l"), 
            list(
  #`Profile` = formatter("span", style = ~ style(color = "grey",font.weight = "bold")), 
  `age`= color_tile('yellow', 'darkorange'),
  `BMI`= color_tile('lightblue', 'pink'),
  `smoking`= color_tile('grey', 'transparent'),
  `comorbidity`= color_tile('darkgrey', 'transparent'),
  `riskprofile`= color_tile('red', 'green'),
  `LA County`= color_bar('cornflowerblue', fun = unit.scale),
  `Pr.H`= color_bar('violet', fun = unit.scale),
  `Pr.Q`= color_bar('violet', fun = unit.scale),
  `Pr.D`= color_bar('violet', fun = unit.scale)
)), rownames = FALSE, colnames = c('Pop prevalence Pr(Profile i in L.A.County)' = 'LA County', 'Age' = 'age', 'BMI status' = 'BMI', 'Smoking status' = 'smoking', 'Existing comorbidities' = 'comorbidity', 'Risk Group' = 'riskprofile', 'Pr(Hospital|Illness)' = 'Pr.H', 'Pr(ICU|Hospital)' = 'Pr.Q', 'Pr(Death|ICU)' = 'Pr.D' ), 
#filter = 'bottom', 
options = list(pageLength = 10, 
               autoWidth = TRUE, 
               order = list(list(6, 'desc'), list(7, 'desc'), list(8, 'desc')))
)
```

## 5 Risk Groups by Stage of Disease and SPA

```{r}
## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################
data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$SPA.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$SPA.Name <- factor(data.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'SPA.Name' ) )

# Risk coloring
risk_color_key <- c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")


## 1) Risk profile #######################################################################################
risk_profile_chart <- function(y, title) {
  ggplot(data = full.data, aes(x=SPA.Name, y = {{y}}, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = risk_color_key) + 
    labs(title = glue("Risk profiles in {title} by SPA"), x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))
}

p.risk.gen <- risk_profile_chart(y = prevalence.gen.pop, title = "hospitalized")
p.risk.h <- risk_profile_chart(y = prevalence.H, title = "general population")
p.risk.q <- risk_profile_chart(y = prevalence.Q, title = "ICU")
p.risk.d <- risk_profile_chart(y = prevalence.D, title = "deceased")

risk_factor_chart <- function(y, fill, title) {
  ggplot(data = full.data, aes(x = SPA.Name, y = {{y}}, fill = {{fill}})) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = title, x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))
}

## 1) Risk factors in general population ######################################
p.BMI.gen   <- risk_factor_chart(y = prevalence.gen.pop, fill = BMI, title = "Obesity in general population by SPA")
p.comb.gen  <- risk_factor_chart(y = prevalence.gen.pop, fill = comorbidity, title = "Comorbidity in general population by SPA")
p.age.gen   <- risk_factor_chart(y = prevalence.gen.pop, fill = age, title = "Age in general population by SPA")
p.smoke.gen <- risk_factor_chart(y = prevalence.gen.pop, fill = smoking, title = "Smoking in general population by SPA")

## 2) Risk factors in hospitalized population #################################
p.BMI.h   <- risk_factor_chart(y = prevalence.H, fill = BMI, title = "Obesity in hospitalized by SPA")
p.comb.h  <- risk_factor_chart(y = prevalence.H, fill = comorbidity, title = "Comorbidity in hospitalized by SPA")
p.age.h   <- risk_factor_chart(y = prevalence.H, fill = age, title = "Age in hospitalized by SPA")
p.smoke.h <- risk_factor_chart(y = prevalence.H, fill = smoking, title = "Smoking in hospitalized by SPA")

## 3) Risk factors in ICU population ##########################################
p.BMI.q   <- risk_factor_chart(y = prevalence.Q, fill = BMI, title = "Obesity in ICU by SPA")
p.comb.q  <- risk_factor_chart(y = prevalence.Q, fill = comorbidity, title = "Comorbidity in ICU by SPA")
p.age.q   <- risk_factor_chart(y = prevalence.Q, fill = age, title = "Age in ICU by SPA")
p.smoke.q <- risk_factor_chart(y = prevalence.Q, fill = smoking, title = "Smoking in ICU by SPA")

## 4) Risk factors in deceased ################################################
p.BMI.d   <- risk_factor_chart(y = prevalence.D, fill = BMI, title = "Obesity in deceased by SPA")
p.comb.d  <- risk_factor_chart(y = prevalence.D, fill = comorbidity, title = "Comorbidity in deceased by SPA")
p.age.d   <- risk_factor_chart(y = prevalence.D, fill = age, title = "Age in deceased by SPA")
p.smoke.d <- risk_factor_chart(y = prevalence.D, fill = smoking, title = "Smoking in deceased by SPA")
```


```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>%
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))

## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.SPA <- c(`Antelope Valley` = 'Antelope Valley' , 
                `San Fernando` = 'San Fernando' , 
                `San Gabriel`= 'San Gabriel' , 
                Metro = 'Metro', 
                West = 'West', 
                South = 'South', 
                East = 'East', 
                `South Bay` = 'South Bay' , 
                `LA County` = 'LA County')

p.prev.risk.stage.SPAs <- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = risk_color_key) + 
    facet_wrap(SPA.Name ~ ., labeller=labeller(SPA.Name = labels.SPA)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and SPAs", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

### Risk profiles, comorbidity, age, obesity by stage of disease for LA County ##############################################################  

LA.data <- subset(full.data, SPA.Name == 'LA County')

p.riskprofiles <- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = risk_color_key) + 
    labs(title = "Risk Profiles By Stage of Disease", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

la_risk_factor_chart <- function(fill, title) {
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = {{fill}})) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = title, x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))
}

p.BMI <-     la_risk_factor_chart(BMI, "Obesity By Stage of Disease")
p.age <-     la_risk_factor_chart(age, "Age By Stage of Disease")
p.comb <-    la_risk_factor_chart(comorbidity, "Any Comorbidity By Stage of Disease")
p.smoking <- la_risk_factor_chart(smoking, "Smoking Status By Stage of Disease")
```

- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County/SPA population, based on the population prevalence of the risk group in L.A. County/SPAs. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#riskgrouptab1"><b>By SPA, stage of disease</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#riskgrouptab2"><b>By stage of disease, SPA</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="riskgrouptab1" class="tab-pane active">
```{r}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d
```
</div>

<div id="riskgrouptab2" class="tab-pane">
```{r}
p.prev.risk.stage.SPAs
```
</div>

</div>
</div>

## Key Risk Factors by Stage of Disease

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:50%">
<a class="nav-link active" data-toggle="tab" href="#keyriskfactortab1"><b>Comparing risk factors</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab2"><b>Age by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab3"><b>Comorbidity by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab4"><b>BMI by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab5"><b>Smoking by stage of disease</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="keyriskfactortab1" class="tab-pane active">
```{r}
p.riskprofiles + p.comb + p.age + p.BMI
```
</div>

<div id="keyriskfactortab2" class="tab-pane">
```{r}
p.age.gen + p.age.h + p.age.q + p.age.d
```
</div>

<div id="keyriskfactortab3" class="tab-pane">
```{r}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d
```
</div>

<div id="keyriskfactortab4" class="tab-pane">
```{r}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d
```
</div>

<div id="keyriskfactortab5" class="tab-pane">
```{r}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d
```
</div>

</div>
</div>



















## Peak hospitalization, ICU, ventilation vs. capacity

```{r, eval=FALSE}
## SIMULATE AND PLOT AGAINST CAPACITY
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)

capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,
                                      capacity_H_vec,
                                      capacity_Q_vec,
                                      capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
CapacityPlot <- plotTraj(traj = TEST, data= capacity_H_Q_V, 
                         state.names = c("H","Q","V"), time.column ="step",
                         summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
CapacityPlot
```

# Sensitivity of model projections to parameter estimates

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#sensT0"><b>$T0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensR0"><b>$R0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensFracR0"><b>$Frac_{R0}$</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="sensT0" class="tab-pane active">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#T0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="T0mean" class="tab-pane active">
```{r, eval=FALSE}
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
st_mean <- ABC.par.stats[1,3]
st_sd <- ABC.par.stats[2,3]
st_upper <- st_mean + 1.96*st_sd
st_lower <- st_mean - 1.96*st_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(st){
  
start_time <- st  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(st_mean)
TEST.upper <- get.param.CI(st_upper)
TEST.lower <- get.param.CI(st_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

  ## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="T0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="T0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="T0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#R0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="R0mean" class="tab-pane active">
```{r, eval=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_mean <- ABC.par.stats[1,1]
R0_sd <- ABC.par.stats[2,1]
R0_upper <- R0_mean + 1.96*R0_sd
R0_lower <- R0_mean - 1.96*R0_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_mean)
TEST.upper <- get.param.CI(R0_upper)
TEST.lower <- get.param.CI(R0_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="R0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="R0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="R0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensFracR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fracR0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fracR0mean" class="tab-pane active">
```{r, eval=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_redux_mean <- ABC.par.stats[1,4]
R0_redux_sd <- ABC.par.stats[2,4]
R0_redux_upper <- R0_redux_mean + 1.96*R0_redux_sd
R0_redux_lower <- R0_redux_mean - 1.96*R0_redux_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0_redux){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_redux_mean)
TEST.upper <- get.param.CI(R0_redux_upper)
TEST.lower <- get.param.CI(R0_redux_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="fracR0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="fracR0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="fracR0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

</div>
</div>

# Model as a tool for future intervention scenario planning

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov1tab1"><b>0%</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov1tab2"><b>25%</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov1tab1" class="tab-pane active">

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab1"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab2"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab1" class="tab-pane active">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 200, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)


## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
R0_redux_100_May1_plot
```
</div>

<div id="scenariov2tab2" class="tab-pane">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON JUNE 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 225, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
R0_redux_100_June1_plot
```
</div>

</div>
</div>

</div>

<div id="scenariov1tab2" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab3"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab4"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab3" class="tab-pane active">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
R0_redux_75_May1_plot
```
</div>

<div id="scenariov2tab4" class="tab-pane">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
R0_redux_75_June1_plot
```
</div>

</div>
</div>
</div>

</div>
</div>

