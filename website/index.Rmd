---
title: "USC Predict COVID Project: \n Predictive Epidemic Model for COVID-19 in Los Angeles County"
author: "Abigail Horn, PhD^[abigail.horn@usc.edu], Lai Jiang, MS, Wendy Cozen, MD, David Conti, PhD"
date: "4/24/2020"
output: 
  html_document:
     css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = TRUE,
                      out.width = "100%",
                      fig.asp = 0.619, fig.width = 10,
                      dpi = 100)
```

```{r}
library(tidyverse)
library(patchwork)
library(here)
library(glue)
library(odin)
library(fitR)
library(knitr)
library(kableExtra)
```

```{r}
source(here("code/supporting_functions.R"))
```


## Updated with data available as of April 25, 2020

# Summary

## Aims
### The USC Predict COVID project is using an epidemic model to estimate the impact of COVID-19 in Los Angeles County

We are addressing the key questions of:

- When will the peak of the epidemic occur and how will it impact health care capacity?
- What happens to the dynamics of the epidemic when social distancing ends? 
- How will the epidemic affect different at-risk groups?

## Why our model is unique

- Our epidemic compartmental model uses stochastic differential equations and approximate Bayes calculation techniques for parameter estimation.
- Importantly, the model presents the uncertainty in all estimations and predictions. 
- We incorporate prior information for parameter specification.
- We incorporate risk factors (e.g. advanced age, existing health conditions) into the analysis. 
- We can modify parameters at different time points, enabling the specification of interventions, e.g. social distancing scenarios

## Predictions and Estimation

### (1) Critical healthcare variables predicted by the model are the counts of the numbers of individuals over time, including the peak occurrence, for the following:

- The total number of infected cases including both the number detected and observed with testing and the undetected/untested cases
- The total number of individuals hospitalized (including those in the ICU)
- The number of patients in the ICU
- The number of patients on ventilators
- The number of deaths

### (2) We estimate a number of key epidemic parameters, including:
- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are detected and reported out of all illnesses
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness, i.e. $Pr(Hospital | Illness)$
- $\kappa$, the probability of ICU care necessary given hospitalization, i.e. $Pr(ICU | Hospital)$
- $p_v$, the probability of ventilation given ICU care, i.e. $Pr(Ventilation | ICU)$
- $\delta$, the probability of death given ICU care, i.e. $Pr(Death | ICU)$

### (3) We also provide predictions for the impact on counts and corresponding time periods under various **social distancing scenarios** in which restrictions are eased.

# Projections

## Current Projections: Summary of Key Model Estimated Variables

```{r}
ABC_out <- read_rds(here("website_results", "ABC_out.rds"))
risk.probs.SPAs <- read_rds(here("website_results", "risk.probs.SPAs.rds"))

Alpha.prior.mean <- risk.probs.SPAs[9, 1]
Kappa.prior.mean <- risk.probs.SPAs[9, 2]

abc_posteriors <- as.data.frame(ABC_out$param) %>%
  set_names(c("R0", "r", "st", "R0redux", "Delta", "Alpha", "Kappa", "p_V")) %>%
  pivot_longer(everything())

abc_priors <- tribble(
  ~param,    ~fun, ~var1, ~var2, ~range1, ~range2,
  "R0",      dnorm, 2.7, 0.3, 1, 4,
  "r",       dunif, .05, 0.3, 0, 0.5,
  "R0redux", dunif, .3, .55, .15,.7,
  "Alpha",   dunif, Alpha.prior.mean - (Alpha.prior.mean / 6), Alpha.prior.mean + (Alpha.prior.mean / 2), .05, .5,
  "Kappa",   dunif, Kappa.prior.mean - (Kappa.prior.mean / 6), Kappa.prior.mean + (Kappa.prior.mean / 2), .15, .7,
  "Delta",   dunif, .2, .8, .15, .9,
  "p_V",     dunif, 0.6, 0.9, .4, .95
) %>%
  pmap_dfr(function(param, fun, var1, var2, range1, range2) {
    x <- seq(range1, range2, length = 512)
    tibble(x,
           y = fun(x, var1, var2),
           param = param)
        })
```

```{r, include=FALSE}
###################################################################################################
## INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

obs_cum_new_counts = t(read.csv(here("data", "cum_counts_040920.csv"), sep=",",stringsAsFactors = FALSE)) 
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.character)
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.numeric)
no_obs <- dim(obs_cum_new_counts)[1]

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- here("code", "stochastic_SEIHQDR_A.R")

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

##############################################
## MODEL PROJECTIONS WITH ESTIMATED PARAMETERS
##############################################
ABC.par.out <- as.data.frame(ABC_out$param)

## DATA FORMAT FOR PLOTTING (BELOW)
data.in.tmp <- obs_cum_new_counts %>% dplyr::select(-c(H_capacity,Q_capacity))
```

```{r summary-table-compute, include=FALSE}
par.vec.length = 100
iter = 50
time.steps = 400
quick.facts.table <- model.output.to.table(ABC_out$param, par.vec.length, iter, 
                                           time.steps, init.date.data = "2020-01-03")
```

```{r, include=FALSE}
###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## COMPILE
x <- seihqdr_generator(Beta_t = Beta_t, Beta_y = Beta_y, S_ini = 1e7, 
                       E_ini = 10, r = r, Delta = Delta, Alpha = Alpha, 
                       Kappa = Kappa, p_QV = p_V)

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st + no_obs - 1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## SIMULATE AND PLOT ZOOMED
TEST <- as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
```

```{r summary-table-print, echo=FALSE}
kable(quick.facts.table, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Current Projections: Illnesses, Hospitalizations, ICU Admittances, Ventilation Requirements, Deaths {.tabset}

**Dashed line = Maximum possible capacity (i.e., total licensed hospital beds, ICU beds, ventilators) in L.A. County**

```{r, include=FALSE}
########################################################################################
## PLOTTING INPUT
########################################################################################

### IF PLOTTING ALL VARIABLES
all.variables <- c(
  "S",
  "Itot",
  "Itotcum",#
  "I",
  "Idetectcum",
  "Htot",
  "H_new",
  "Htotcum",
  "Q",
  "Qcum", #
  "V",
  "Vcum",
  "D",
  "D_new"
)

### IF ONLY PLOTTING VARIABLES AGAINST DATA
only.vars.with.data <- c(
  "Idetectcum",
  "H_new",
  "Htotcum",
  "Vcum",
  "D",
  "D_new"
)

 
traj.0 <- model.output.to.plot(ABC_out$param, 
                               par.vec.length = 100, 
                               iter = 50, 
                               time.steps = 400, 
                               vars.to.plot = all.variables, 
                               init.date.data = "2020-03-01", 
                               all = TRUE, 
                               scenario.selection = 0,
                               intervention_date = NULL,
                               sd.redux = NULL)


##################################################################
## Generate plots
##################################################################

forecast_plotting_function <- function(scenario,
                                       var.to.plot,
                                       intervention_date = NULL,
                                       sd.redux = NULL,
                                       use.title=NULL,
                                       plot.capacity=TRUE,
                                       ymax=NULL,
                                       time.steps.4plot = 350) {
 plot.model.single(traj.CI = traj.0, 
                           data.in = data.in.tmp, 
                           init.date.data = "2020-03-01", 
                           date.offset.4plot = 15, 
                           time.steps.4plot = time.steps.4plot, 
                           ymax = ymax, 
                           plot.capacity = plot.capacity, 
                           var.to.plot = var.to.plot,
                           use.title = use.title,
                           scenario = scenario, 
                           intervention_date = intervention_date, 
                           sd.redux = sd.redux) 
}

```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:33.33333%">
<a class="nav-link active" data-toggle="tab" href="#paramtab1"><b>Hospitalizations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab2"><b>ICU Admittances By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab3"><b>Ventilations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab4"><b>Cumulative Deaths</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab5"><b>Observed Illnesses By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab6"><b>Total Illnesses By Time</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="paramtab1" class="tab-pane active">
```{r}
forecast_plotting_function(0, "Htot") + 
  plot_annotation(title = "Hospitalizations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab2" class="tab-pane">
```{r}
forecast_plotting_function(0, "Q") + 
  plot_annotation(title = "ICU Admittances By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab3" class="tab-pane">
```{r}
forecast_plotting_function(0, "V") + 
  plot_annotation(title = "Ventilations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab4" class="tab-pane">
```{r}
forecast_plotting_function(0, "D", plot.capacity = NULL) + 
  plot_annotation(title = "Cumulative Deaths", 
                  caption = "L.A. data plotted as black dots", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab5" class="tab-pane">
```{r}
forecast_plotting_function(0, "I", plot.capacity = NULL) + 
  plot_annotation(title = "*Observed* Illnesses By Time", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab6" class="tab-pane">
```{r}
forecast_plotting_function(0, "Itot", plot.capacity = NULL) + 
  plot_annotation(title = "*Total* Illnesses By Time (Observed + Undetected)", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

</div>
</div>

# Model Fits Against Data

**Demonstrating model fit against COVID-19 data for Los Angeles, for the following variables:**

- Observed illnesses, cumulative
- Hospitalizations, cumulative
- Hospitalization, daily new incidence
- Ventilation, cumulative
- Deaths, cumulative
- Deaths, daily new incidence

**COVID-19 data is shown as black dots in the figures below.**

```{r input-for-plot-all-vars, include=FALSE}
scenario=0
intervention_date = NULL
sd.redux = NULL
number.pars.to.use = 200
iter = 50
time.steps = 400

# traj.0 <- model.output.to.plot(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = all.variables, 
#                                               init.date.data="2020-03-01", all=TRUE, 
#                                               scenario.selection =scenario,intervention_date=intervention_date,sd.redux=sd.redux)

# PLOTS OVER 1 YEAR
time.steps.4.plot = 350
## Plot all
plot.all.variables.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )

# PLOTS ZOOMED SHORTER TIME PERIOD
time.steps.4.plot = 150
## Plot all
plot.all.variables.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )
```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fittab1"><b>All variables, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab2"><b>All variables, 150 days</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab3"><b>Only variables with data, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab4"><b>Only variables with data, 150 days</b></a>
</li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fittab1" class="tab-pane active">
```{r}
plot.all.variables.current.scenario
```
</div>

<div id="fittab2" class="tab-pane">
```{r}
plot.all.variables.current.scenario.150days
```
</div>

<div id="fittab3" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario
```
</div>

<div id="fittab4" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario.150days
```
</div>

</div>
</div>

## Peak hospitalization, ICU, ventilation vs. capacity

```{r, eval=FALSE}
## SIMULATE AND PLOT AGAINST CAPACITY
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)

capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,
                                      capacity_H_vec,
                                      capacity_Q_vec,
                                      capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
CapacityPlot <- plotTraj(traj = TEST, data= capacity_H_Q_V, 
                         state.names = c("H","Q","V"), time.column ="step",
                         summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
CapacityPlot
```

# Sensitivity of model projections to parameter estimates

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#sensT0"><b>$T0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensR0"><b>$R0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensFracR0"><b>$Frac_{R0}$</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="sensT0" class="tab-pane active">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#T0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="T0mean" class="tab-pane active">
```{r, eval=FALSE}
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
st_mean <- ABC.par.stats[1,3]
st_sd <- ABC.par.stats[2,3]
st_upper <- st_mean + 1.96*st_sd
st_lower <- st_mean - 1.96*st_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(st){
  
start_time <- st  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(st_mean)
TEST.upper <- get.param.CI(st_upper)
TEST.lower <- get.param.CI(st_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

  ## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="T0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="T0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="T0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#R0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="R0mean" class="tab-pane active">
```{r, eval=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_mean <- ABC.par.stats[1,1]
R0_sd <- ABC.par.stats[2,1]
R0_upper <- R0_mean + 1.96*R0_sd
R0_lower <- R0_mean - 1.96*R0_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_mean)
TEST.upper <- get.param.CI(R0_upper)
TEST.lower <- get.param.CI(R0_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="R0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="R0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="R0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensFracR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fracR0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fracR0mean" class="tab-pane active">
```{r, eval=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_redux_mean <- ABC.par.stats[1,4]
R0_redux_sd <- ABC.par.stats[2,4]
R0_redux_upper <- R0_redux_mean + 1.96*R0_redux_sd
R0_redux_lower <- R0_redux_mean - 1.96*R0_redux_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0_redux){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_redux_mean)
TEST.upper <- get.param.CI(R0_redux_upper)
TEST.lower <- get.param.CI(R0_redux_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
CapacityPlot.Mean
```
</div>

<div id="fracR0upper" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Upper
```
</div>

<div id="fracR0lower" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Lower
```
</div>

<div id="fracR0combined" class="tab-pane">
```{r, eval=FALSE}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

</div>
</div>

# Model as a tool for future intervention scenario planning

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov1tab1"><b>0%</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov1tab2"><b>25%</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov1tab1" class="tab-pane active">

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab1"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab2"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab1" class="tab-pane active">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 200, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)


## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
R0_redux_100_May1_plot
```
</div>

<div id="scenariov2tab2" class="tab-pane">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON JUNE 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 225, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
R0_redux_100_June1_plot
```
</div>

</div>
</div>

</div>

<div id="scenariov1tab2" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab3"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab4"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab3" class="tab-pane active">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r, eval=FALSE}
R0_redux_75_May1_plot
```
</div>

<div id="scenariov2tab4" class="tab-pane">
```{r, eval=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r, eval=FALSE}
R0_redux_75_June1_plot
```
</div>

</div>
</div>
</div>

</div>
</div>

