---
title: "USC Predict COVID Project: \n Predictive Epidemic Model for COVID-19 in Los Angeles County"
author: "Abigail Horn, PhD^[abigail.horn@usc.edu], Lai Jiang, MS, Wendy Cozen, MD, David Conti, PhD"
date: "4/24/2020"
output: 
  html_document:
     css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      out.width = "100%",
                      fig.asp = 0.619, fig.width = 10,
                      dpi = 100)
```

```{r}
library(tidyverse)
library(patchwork)
library(here)
library(glue)
library(odin)
library(fitR)
library(knitr)
library(kableExtra)
library(formattable)
```

```{r}
source(here("code/supporting_functions.R"))
```


## Updated with data available as of April 25, 2020

# Summary

## Aims
### The USC Predict COVID project is using an epidemic model to estimate the impact of COVID-19 in Los Angeles County

We are addressing the key questions of:

- When will the peak of the epidemic occur and how will it impact health care capacity?
- What happens to the dynamics of the epidemic when social distancing ends? 
- How will the epidemic affect different at-risk groups?

## Why our model is unique

- Our epidemic compartmental model uses stochastic differential equations and approximate Bayes calculation techniques for parameter estimation.
- Importantly, the model presents the uncertainty in all estimations and predictions. 
- We incorporate prior information for parameter specification.
- We incorporate risk factors (e.g. advanced age, existing health conditions) into the analysis. 
- We can modify parameters at different time points, enabling the specification of interventions, e.g. social distancing scenarios

## Predictions and Estimation

### (1) Critical healthcare variables predicted by the model are the counts of the numbers of individuals over time, including the peak occurrence, for the following:

- The total number of infected cases including both the number detected and observed with testing and the undetected/untested cases
- The total number of individuals hospitalized (including those in the ICU)
- The number of patients in the ICU
- The number of patients on ventilators
- The number of deaths

### (2) We estimate a number of key epidemic parameters, including:
- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are detected and reported out of all illnesses
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness, i.e. $Pr(Hospital | Illness)$
- $\kappa$, the probability of ICU care necessary given hospitalization, i.e. $Pr(ICU | Hospital)$
- $p_v$, the probability of ventilation given ICU care, i.e. $Pr(Ventilation | ICU)$
- $\delta$, the probability of death given ICU care, i.e. $Pr(Death | ICU)$

### (3) We also provide predictions for the impact on counts and corresponding time periods under various **social distancing scenarios** in which restrictions are eased.

# Projections

## Current Projections: Summary of Key Model Estimated Variables

```{r}
ABC_out <- read_rds(here("website_results", "ABC_out.rds"))
risk.probs.SPAs <- read_rds(here("website_results", "risk.probs.SPAs.rds"))

Alpha.prior.mean <- risk.probs.SPAs[9, 1]
Kappa.prior.mean <- risk.probs.SPAs[9, 2]
```

```{r, include=FALSE}
###################################################################################################
## INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

obs_cum_new_counts = t(read.csv(here("data", "cum_counts_042420.csv"), sep=",",stringsAsFactors = FALSE)) 
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.character)
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.numeric)
no_obs <- dim(obs_cum_new_counts)[1]

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- here("code", "stochastic_SEIHQDR_A.R")

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

##############################################
## MODEL PROJECTIONS WITH ESTIMATED PARAMETERS
##############################################
ABC.par.out <- as.data.frame(ABC_out$param)

## DATA FORMAT FOR PLOTTING (BELOW)
data.in.tmp <- obs_cum_new_counts %>% dplyr::select(-c(H_capacity,Q_capacity))
```

```{r summary-table-compute, include=FALSE}
par.vec.length = 100
iter = 50
time.steps = 400
quick.facts.table <- model.output.to.table(ABC_out$param, par.vec.length, iter, 
                                           time.steps, init.date.data = "2020-01-03")
```

```{r, include=FALSE}
###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.par.out <- as.data.frame(ABC_out$param)

###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean) %>% mutate_if(is.numeric,round,digits=2)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd) %>% mutate_if(is.numeric,round,digits=2)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))
colnames(ABC.par.stats)<-c("R0","Prop. cases detected (r)","Start time", "Frac R0 Mar11","Pr(Death|ICU)","Pr(Hospital|Illness)","Pr(ICU|Hospital)","Pr(Ventilation|ICU)","Frac R0 Apr23")
rownames(ABC.par.stats)<-c("mean","sd")

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## COMPILE
x <- seihqdr_generator(Beta_t = Beta_t, Beta_y = Beta_y, S_ini = 1e7, 
                       E_ini = 10, r = r, Delta = Delta, Alpha = Alpha, 
                       Kappa = Kappa, p_QV = p_V)

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st + no_obs - 1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## SIMULATE AND PLOT ZOOMED
TEST <- as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
```

```{r summary-table-print, echo=FALSE}
kable(quick.facts.table, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Current Projections: Illnesses, Hospitalizations, ICU Admittances, Ventilation Requirements, Deaths {.tabset}

**Dashed line = Maximum possible capacity (i.e., total licensed hospital beds, ICU beds, ventilators) in L.A. County**

```{r, include=FALSE}
########################################################################################
## PLOTTING INPUT
########################################################################################

### IF PLOTTING ALL VARIABLES
all.variables <- c(
  "S",
  "Itot",
  "Itotcum",#
  "I",
  "Idetectcum",
  "Htot",
  "H_new",
  "Htotcum",
  "Q",
  "Qcum", #
  "V",
  "Vcum",
  "D",
  "D_new"
)

### IF ONLY PLOTTING VARIABLES AGAINST DATA
only.vars.with.data <- c(
  "Idetectcum",
  "H_new",
  "Htotcum",
  "Vcum",
  "D",
  "D_new"
)

 
traj.0 <- model.output.to.plot(ABC_out$param, 
                               par.vec.length = 100, 
                               iter = 50, 
                               time.steps = 400, 
                               vars.to.plot = all.variables, 
                               init.date.data = "2020-03-01", 
                               all = TRUE, 
                               scenario.selection = 0,
                               intervention_date = NULL,
                               sd.redux = NULL)


##################################################################
## Generate plots
##################################################################

forecast_plotting_function <- function(traj.CI,
                                       scenario,
                                       var.to.plot,
                                       intervention_date = NULL,
                                       sd.redux = NULL,
                                       use.title=NULL,
                                       plot.capacity=TRUE,
                                       ymax=NULL,
                                       time.steps.4plot = 350) {
 plot.model.single(traj.CI = traj.CI, 
                   data.in = data.in.tmp, 
                   init.date.data = "2020-03-01", 
                   date.offset.4plot = 15, 
                   time.steps.4plot = time.steps.4plot, 
                   ymax = ymax, 
                   plot.capacity = plot.capacity, 
                   var.to.plot = var.to.plot,
                   use.title = use.title,
                   scenario = scenario, 
                   intervention_date = intervention_date, 
                   sd.redux = sd.redux) 
}

```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:33.33333%">
<a class="nav-link active" data-toggle="tab" href="#paramtab1"><b>Hospitalizations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab2"><b>ICU Admittances By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab3"><b>Ventilations By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab4"><b>Cumulative Deaths</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab5"><b>Observed Illnesses By Time</b></a>
</li>

<li class="nav-item" style ="width:33.33333%">
<a class="nav-link" data-toggle="tab" href="#paramtab6"><b>Total Illnesses By Time</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="paramtab1" class="tab-pane active">
```{r}
forecast_plotting_function(traj.0, 0, "Htot") + 
  plot_annotation(title = "Hospitalizations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab2" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "Q") + 
  plot_annotation(title = "ICU Admittances By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab3" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "V") + 
  plot_annotation(title = "Ventilations By Time, Against Capacity", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab4" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "D", plot.capacity = NULL) + 
  plot_annotation(title = "Cumulative Deaths", 
                  caption = "L.A. data plotted as black dots", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab5" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "I", plot.capacity = NULL) + 
  plot_annotation(title = "*Observed* Illnesses By Time", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

<div id="paramtab6" class="tab-pane">
```{r}
forecast_plotting_function(traj.0, 0, "Itot", plot.capacity = NULL) + 
  plot_annotation(title = "*Total* Illnesses By Time (Observed + Undetected)", 
                  theme = theme(plot.title = element_text(hjust = .5, face = "bold")))
```
</div>

</div>
</div>

# Model Fits Against Data

**Demonstrating model fit against COVID-19 data for Los Angeles, for the following variables:**

- Observed illnesses, cumulative
- Hospitalizations, cumulative
- Hospitalization, daily new incidence
- Ventilation, cumulative
- Deaths, cumulative
- Deaths, daily new incidence

**COVID-19 data is shown as black dots in the figures below.**

```{r input-for-plot-all-vars, include=FALSE}
scenario=0
intervention_date = NULL
sd.redux = NULL
number.pars.to.use = 200
iter = 50
time.steps = 400

# traj.0 <- model.output.to.plot(ABC.out.mat, par.vec.length=number.pars.to.use, iter=iter, time.steps=time.steps, vars.to.plot = all.variables, 
#                                               init.date.data="2020-03-01", all=TRUE, 
#                                               scenario.selection =scenario,intervention_date=intervention_date,sd.redux=sd.redux)

# PLOTS OVER 1 YEAR
time.steps.4.plot = 350
## Plot all
plot.all.variables.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )

# PLOTS ZOOMED SHORTER TIME PERIOD
time.steps.4.plot = 150
## Plot all
plot.all.variables.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = all.variables
  )

## Plot only vars with LA COVID data
plot.only.vars.with.data.current.scenario.150days <- plot.model.data.all(
  traj.CI = traj.0, 
  data.in = data.in.tmp, 
  init.date.data = "2020-03-01", 
  date.offset.4plot = 15, 
  time.steps.4plot = time.steps.4.plot, 
  vars.to.plot = only.vars.with.data
  )
```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fittab1"><b>All variables, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab2"><b>All variables, 150 days</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab3"><b>Only variables with data, 1 year</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab4"><b>Only variables with data, 150 days</b></a>
</li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fittab1" class="tab-pane active">
```{r}
plot.all.variables.current.scenario
```
</div>

<div id="fittab2" class="tab-pane">
```{r}
plot.all.variables.current.scenario.150days
```
</div>

<div id="fittab3" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario
```
</div>

<div id="fittab4" class="tab-pane">
```{r}
plot.only.vars.with.data.current.scenario.150days
```
</div>

</div>
</div>

# Comparing Social Distancing Mitigation Strategies 

- Model projections forecast that, if everything continutes as is, LA is not going to see a sharp peak in illnesses in the near future, and rather will see a long, shallow, *manageable* epidemic curve over the next number of months.
- What can we do to maintain this manageable epidemic curve while sustaining a functioning society?
- Here we evaluate the effect of scenarios relating to social distancing on the ultimate epidemic trajectory 

## Scenario Comparison

```{r, include=FALSE}
## GET MODEL OUTPUT AND CALCULATE CI
## Specify scenario through:
## scenario.selection
## 0 = no scenario
## 1 = scenario
## intervention_date
## sd.redux: % reduction in contact rate due to social distancing 
## Output:
## Summary statistics by date and state.name (i.e. variable)

##################################################################
## Generate trajectory data
##################################################################

number.pars.to.use = 100
iter = 50
time.steps = 400

### SCENARIO: WHAT IF SOCIAL DISTANCING NEVER IMPLEMENTED
scenario = 1
intervention_date = NULL
sd.redux = NULL

traj.1 <- model.output.to.plot(ABC_out$param, 
                               par.vec.length = number.pars.to.use, 
                               iter = iter, 
                               time.steps = time.steps, 
                               vars.to.plot = all.variables, 
                               init.date.data = "2020-03-01", 
                               all = TRUE, 
                               scenario.selection = scenario,
                               intervention_date = intervention_date,
                               sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON MAY 1ST
scenario = 2
intervention_date = "2020-05-01"
sd.redux = 0.25
traj.2.May1.25 <- model.output.to.plot(ABC_out$param, 
                                       par.vec.length = number.pars.to.use, 
                                       iter = iter, 
                                       time.steps = time.steps, 
                                       vars.to.plot = all.variables, 
                                       init.date.data = "2020-03-01", 
                                       all = TRUE, 
                                       scenario.selection = scenario,
                                       intervention_date = intervention_date,
                                       sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON JUNE 1ST
scenario = 2
intervention_date = "2020-06-01"
sd.redux = 0.25
traj.2.June1.25 <- model.output.to.plot(ABC_out$param, 
                                        par.vec.length = number.pars.to.use,
                                        iter = iter, 
                                        time.steps = time.steps, 
                                        vars.to.plot = all.variables, 
                                        init.date.data = "2020-03-01",
                                        all = TRUE, 
                                        scenario.selection = scenario,
                                        intervention_date = intervention_date,
                                        sd.redux = sd.redux)

### SCENARIO: DECREASE SOCIAL DISTANCING TO 25% ON JULY 1ST
scenario = 2
intervention_date = "2020-07-01"
sd.redux = 0.25
traj.2.July1.25 <- model.output.to.plot(ABC_out$param, 
                                        par.vec.length = number.pars.to.use, 
                                        iter = iter, 
                                        time.steps = time.steps, 
                                        vars.to.plot = all.variables, 
                                        init.date.data = "2020-03-01", 
                                        all = TRUE, 
                                        scenario.selection = scenario,
                                        intervention_date = intervention_date,
                                        sd.redux = sd.redux)


### SCENARIO: DECREASE SOCIAL DISTANCING TO 0% ON MAY 1ST
scenario = 2
intervention_date = "2020-06-01"
sd.redux = 0
traj.2.June1.0 <- model.output.to.plot(ABC_out$param, 
                                       par.vec.length = number.pars.to.use, 
                                       iter = iter, 
                                       time.steps = time.steps, 
                                       vars.to.plot = all.variables, 
                                       init.date.data = "2020-03-01", 
                                       all = TRUE, 
                                       scenario.selection = scenario,
                                       intervention_date = intervention_date,
                                       sd.redux = sd.redux)

### SCENARIO: GRADUAL EASING OF SOCIAL DISTANCING BEGINNING JUNE 1ST
scenario = 3
intervention_date = "2020-06-01"
sd.redux = 0
traj.3.June1 <- model.output.to.plot(ABC_out$param, 
                                     par.vec.length = number.pars.to.use, 
                                     iter = iter, 
                                     time.steps = time.steps, 
                                     vars.to.plot = all.variables, 
                                     init.date.data = "2020-03-01", 
                                     all = TRUE, 
                                     scenario.selection = scenario,
                                     intervention_date = intervention_date,
                                     sd.redux = sd.redux)
```

```{r}
##################################################################
## Scenarios: generate plots
##################################################################

ymax.H <- 100000
ymax.D <- 200000

##################################################################
### SCENARIO 0 
p.H.0 <- forecast_plotting_function(traj.CI = traj.0, 
                                    scenario = 0, 
                                    var.to.plot = "Htot", 
                                    use.title = TRUE,
                                    ymax = ymax.H)

p.D.0 <- forecast_plotting_function(traj.CI = traj.0, 
                                    scenario = 0, 
                                    var.to.plot = "D", 
                                    use.title = TRUE, 
                                    ymax = ymax.D, 
                                    plot.capacity = NULL)

##################################################################
### SCENARIO 1: WHAT IF SOCIAL DISTANCING NEVER IMPLEMENTED
p.H.1 <-forecast_plotting_function(traj.CI = traj.1, 
                                   scenario = 1, 
                                   var.to.plot = "Htot", 
                                   use.title = TRUE, 
                                   ymax = ymax.H)

p.D.1 <- forecast_plotting_function(traj.CI = traj.1, 
                                    scenario = 1, 
                                    var.to.plot = "D", 
                                    use.title = TRUE, 
                                    ymax = ymax.D, 
                                    plot.capacity = NULL)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON MAY 1ST
p.H.2.May1.25 <- forecast_plotting_function(traj.CI = traj.2.May1.25, 
                                            scenario = 2, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-05-01", 
                                            sd.redux = 0.25,
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.2.May1.25 <- forecast_plotting_function(traj.CI = traj.2.May1.25, 
                                            scenario = 2, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-05-01", 
                                            sd.redux = 0.25,
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON JUNE 1ST
p.H.2.June1.25 <- forecast_plotting_function(traj.CI = traj.2.June1.25, 
                                             scenario = 2, 
                                             var.to.plot = "Htot", 
                                             intervention_date = "2020-06-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             ymax = ymax.H)

p.D.2.June1.25 <- forecast_plotting_function(traj.CI = traj.2.June1.25, 
                                             scenario = 2, 
                                             var.to.plot = "D", 
                                             intervention_date = "2020-06-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             plot.capacity = NULL,
                                             ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 25% ON JULY 1ST
p.H.2.July1.25 <- forecast_plotting_function(traj.CI = traj.2.July1.25, 
                                             scenario = 2, 
                                             var.to.plot = "Htot", 
                                             intervention_date = "2020-07-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             ymax = ymax.H)

p.D.2.July1.25 <- forecast_plotting_function(traj.CI = traj.2.July1.25, 
                                             scenario = 2, 
                                             var.to.plot = "D", 
                                             intervention_date = "2020-07-01", 
                                             sd.redux = 0.25, 
                                             use.title = TRUE, 
                                             plot.capacity = NULL,
                                             ymax = ymax.D)

##################################################################
### SCENARIO 2: DECREASE SOCIAL DISTANCING TO 0% ON JUNE 1ST
p.H.2.June1.0 <- forecast_plotting_function(traj.CI = traj.2.June1.0, 
                                            scenario = 2, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-06-01", 
                                            sd.redux = 0, 
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.2.June1.0 <- forecast_plotting_function(traj.CI = traj.2.June1.0, 
                                            scenario = 2, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-06-01", 
                                            sd.redux = 0, 
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)

##################################################################
### SCENARIO 3: GRADUAL EASING OF SOCIAL DISTANCING
p.H.3.June1 <- forecast_plotting_function(traj.CI = traj.3.June1, 
                                            scenario = 3, 
                                            var.to.plot = "Htot", 
                                            intervention_date = "2020-06-01", 
                                            use.title = TRUE, 
                                            ymax = ymax.H)

p.D.3.June1 <- forecast_plotting_function(traj.CI = traj.3.June1, 
                                            scenario = 3, 
                                            var.to.plot = "D", 
                                            intervention_date = "2020-06-01", 
                                            use.title = TRUE, 
                                            plot.capacity = NULL,
                                            ymax = ymax.D)
```


<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:50%">
<a class="nav-link active" data-toggle="tab" href="#Scenariotab1"><b>Counterfactual: No social distancing implemented</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab2"><b>Easing of social distancing from 50% to 25% on May 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab3"><b>Easing of social distancing from 50% to 25% on June 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab4"><b>Easing of social distancing from 50% to 25% on July 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab5"><b>Removal of social distancing on June 1st</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#Scenariotab6"><b>Gradual easing of social distancing beginning on June 1st</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="Scenariotab1" class="tab-pane active">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and counterfactual: if social distancing had never been implemented**
```{r}
(p.H.0 + p.H.1) / (p.D.0 + p.D.1)
```
</div>

<div id="Scenariotab2" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on May 1, 2020**
```{r}
(p.H.0 + p.H.2.May1.25) / (p.D.0 + p.D.2.May1.25)
```
</div>

<div id="Scenariotab3" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on June 1, 2020**
```{r}
(p.H.0 + p.H.2.June1.25) / (p.D.0 + p.D.2.June1.25)
```
</div>

<div id="Scenariotab4" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and easing of social distancing from 50% to 25% on July 1, 2020**
```{r}
(p.H.0 + p.H.2.July1.25) / (p.D.0 + p.D.2.July1.25)
```
</div>

<div id="Scenariotab5" class="tab-pane">
**Comparison between current level of social distancing of ~50% beginning March 15, 2020 and removal of social distancing on June 1, 2020**
```{r}
(p.H.0 + p.H.2.June1.0) / (p.D.0 + p.D.2.June1.0)
```
</div>

<div id="Scenariotab6" class="tab-pane">
**Comparison between policy of easing of social distancing from 50% to 25% on June 1, 2020 and gradual easing beginning June 1, 2020 of social distancing from 50% to no social distancing**
```{r}
(p.H.2.June1.0 + p.H.3.June1) / (p.D.2.June1.0 + p.D.3.June1)
```
</div>

</div>
</div>

# Projections by Key Risk Groups and Risk Factors 

- We analyze how population prevalence of known COVID-19 *risk factors*: advanced age, existence of other health conditions or comorbidities, smoking status, and obesity status, affect COVID-19 illness trajectories in L.A. County and spatial subdivisions.

- First, we estimate the conditional probability of COVID illness severity given combinations of risk factors. We categorize the population into a number of *risk profiles*, representing different combinations of known COVID-19 *risk factors*: advanced age, existence of other health conditions or comorbidities, smoking status, and obesity status. Using previous COVID-19 studies reporting the marginal risk of severe COVID-19 outcomes given individual risk factors, we develop a statistical model to estimate the probability of COVID illness trajectories for individuals having or not having combinations of risk factors represented by these *risk profiles*. Specifically, we estimate the probability that individuals within a specific risk group are admitted to hospital given having acquired illness $Pr(Hospital | Illness, Profile_i)$, are admitted to the ICU given admittance to hospitalized $Pr(ICU | Hospital, Profile_i)$, and that die given being admitted to the ICU $Pr(Death | ICU, Profile_i)$. More information is provided below under **Methods and Data**.

- For the analysis below, we have grouped the multiple *risk profiles* into 5 key *risk groups* according to similar within-group levels of the probabilities $Pr(Hospital | Illness, Profile_i)$, $Pr(ICU | Hospital, Profile_i)$, and $Pr(Death | ICU, Profile_i)$. 

- Second, we use these probabilities to estimate the proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County population, based on the prevalence of each risk group in the population.

- Results are also presented for each Service Planning Area (SPA) population within L.A. County. [A SPA is a specific geographical region within Los Angeles County used by the Department of Public Health to plan and provide health services](http://publichealth.lacounty.gov/chs/SPAMain/ServicePlanningAreas.htm). There are 8 SPAs in Los Angeles County. 

### Risk Profiles, Risk Factors, and Risk Groups

- The following table presents the model-estimated probabilities $Pr(Hospital | Illness,Profile_i)$, $Pr(ICU | Hospital,Profile_i)$, and $Pr(Death | ICU,Profile_i)$ for each risk group (or combination of risk factors), as well as the prevalence of these risk groups/factors in the general L.A. County Population $Pr(Profile_i)$.

```{r load.data, include=FALSE}
# LOAD DATA

### Data from calc_risk_profiles_042220
profile.cnt.SPAs <- readr::read_csv(here("results", "ProfilePrev.GeneralPop.csv"))
H.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.HospitalPop.csv"))
Q.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.ICUPop.csv"))
D.profile.share.relative.all.SPAs <- readr::read_csv(here("results", "ProfilePrev.DeadPop.csv"))

##import prevalence by profile
data <- as.data.frame(profile.cnt.SPAs)
dataH <- as.data.frame(H.profile.share.relative.all.SPAs)
dataQ <- as.data.frame(Q.profile.share.relative.all.SPAs)
dataD <- as.data.frame(D.profile.share.relative.all.SPAs)

#import the probability by profile
Pr.H <- read_csv(here("results", "Pr.H.BMI.csv"))
Pr.Q <- read_csv(here("results", "Pr.Q.BMI.csv"))
Pr.D <- read_csv(here("results", "Pr.D.BMI.csv"))

SPA.data <- risk.probs.SPAs

### Data from estimated SEIR model (traj.CI.out) ##################################################
traj.CI.out <- traj.0
```

```{r clean-process-data, include=FALSE}
# CLEAN AND PROCESS DATA

## 1) RENAME VARIABLES #############################################################################

#Change the profile numbers to factors and name the variable
Profile <- factor(seq(1,nrow(data)))
data <- cbind(data,Profile)

## dataH ##

#Change the profile numbers to factors and name the variable
dataH <- cbind(dataH,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataH$Age0.19 <- NULL
dataH$Age20.44 <- NULL
dataH$Age45.64 <- NULL  
dataH$Age65. <- NULL
dataH$ObesityBMI.30 <- NULL
dataH$ObesityBMI30.40 <- NULL
dataH$ObesityBMI.40 <- NULL
dataH$SmokingYes <- NULL
dataH$ComorbidityYes <- NULL
dataH$X1 <- NULL
  
#melt data
dataH.melted <- melt(dataH, id = 'Profile')
dataH.melted$SPA.Name <- dataH.melted$variable
dataH.melted$variable <- NULL
dataH.melted$SPA.Name <- factor(dataH.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataH.melted$prevalence.H <- dataH.melted$value
dataH.melted$value <- NULL

## dataQ ##

#Change the profile numbers to factors and name the variable
dataQ <- cbind(dataQ, Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataQ$Age0.19 <- NULL
dataQ$Age20.44 <- NULL
dataQ$Age45.64 <- NULL  
dataQ$Age65. <- NULL
dataQ$ObesityBMI.30 <- NULL
dataQ$ObesityBMI30.40 <- NULL
dataQ$ObesityBMI.40 <- NULL
dataQ$SmokingYes <- NULL
dataQ$ComorbidityYes <- NULL
dataQ$X1 <- NULL

#melt data
dataQ.melted <- melt(dataQ, id = 'Profile')
dataQ.melted$SPA.Name <- dataQ.melted$variable
dataQ.melted$variable <- NULL
dataQ.melted$SPA.Name <- factor(dataQ.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataQ.melted$prevalence.Q <- dataQ.melted$value
dataQ.melted$value <- NULL

## dataD ##

#Change the profile numbers to factors and name the variable
dataD <- cbind(dataD,Profile)

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
dataD$Age0.19 <- NULL
dataD$Age20.44 <- NULL
dataD$Age45.64 <- NULL  
dataD$Age65. <- NULL
dataD$ObesityBMI.30 <- NULL
dataD$ObesityBMI30.40 <- NULL
dataD$ObesityBMI.40 <- NULL
dataD$SmokingYes <- NULL
dataD$ComorbidityYes <- NULL
dataD$X1 <- NULL


#melt data
dataD.melted <- melt(dataD, id = 'Profile')
dataD.melted$SPA.Name <- dataD.melted$variable
dataD.melted$variable <- NULL
dataD.melted$SPA.Name <- factor(dataD.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))
dataD.melted$prevalence.D <- dataD.melted$value
dataD.melted$value <- NULL

## PrH ## 

#Change the profile numbers to factors and name the variable
Pr.H$Profile <- factor(seq_len(nrow(Pr.H)))

#Change the name of the variable "Pr" to a more detailed name
Pr.H$Pr.H <- Pr.H$Pr
Pr.H$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.H$Age0.19 <- NULL
Pr.H$Age20.44 <- NULL
Pr.H$Age45.64 <- NULL  
Pr.H$Age65. <- NULL
Pr.H$ObesityBMI.30 <- NULL
Pr.H$ObesityBMI30.40 <- NULL
Pr.H$ObesityBMI.40 <- NULL
Pr.H$SmokingYes <- NULL
Pr.H$ComorbidityYes <- NULL
Pr.H$X1 <- NULL

## PrQ ##

#Change the profile numbers to factors and name the variable
Pr.Q$Profile <- factor(seq_len(nrow(Pr.Q)))

#Change the name of the variable "Pr" to a more detailed name
Pr.Q$Pr.Q <- Pr.Q$Pr
Pr.Q$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.Q$Age0.19 <- NULL
Pr.Q$Age20.44 <- NULL
Pr.Q$Age45.64 <- NULL  
Pr.Q$Age65. <- NULL
Pr.Q$ObesityBMI.30 <- NULL
Pr.Q$ObesityBMI30.40 <- NULL
Pr.Q$ObesityBMI.40 <- NULL
Pr.Q$SmokingYes <- NULL
Pr.Q$ComorbidityYes <- NULL
Pr.Q$X1 <- NULL

## PrD ##

#Change the profile numbers to factors and name the variable
Pr.D$Profile <- factor(seq_len(nrow(Pr.D)))

Pr.D$Pr.D <- Pr.D$Pr
Pr.D$Pr <- NULL

#Drop variables we don't care about (they are included in the whole dataset, this will avoid dupliactes)
Pr.D$Age0.19 <- NULL
Pr.D$Age20.44 <- NULL
Pr.D$Age45.64 <- NULL  
Pr.D$Age65. <- NULL
Pr.D$ObesityBMI.30 <- NULL
Pr.D$ObesityBMI30.40 <- NULL
Pr.D$ObesityBMI.40 <- NULL
Pr.D$SmokingYes <- NULL
Pr.D$ComorbidityYes <- NULL
Pr.D$X1 <- NULL


## 2) DUMMY VARIABLES <- LEVELS ##################################################################
data$X1 <- NULL
data$age <- "Blank"
data$age[data$Age0.19==1] <- "0-19"
data$age[data$Age20.44==1] <- "20-44"
data$age[data$Age45.64==1] <- "45-64"
data$age[data$Age65.==1] <- "65+"
data$Age0.19 <- NULL
data$Age20.44 <- NULL
data$Age45.64 <- NULL
data$Age65. <- NULL
data$age <- factor(data$age, levels =  c("0-19", "20-44", "45-64", "65+"))

data$BMI <- "Blank"
data$BMI[data$ObesityBMI.30==1] <- "BMI<30"
data$BMI[data$ObesityBMI30.40==1] <- "30<BMI<40"
data$BMI[data$ObesityBMI.40==1] <- "BMI>40"
data$ObesityBMI.30 <- NULL
data$ObesityBMI30.40 <- NULL
data$ObesityBMI.40 <- NULL

data$BMI <- factor(data$BMI, levels =  c("BMI<30", "30<BMI<40", "BMI>40"))

data$smoking <- "Blank"
data$smoking[data$SmokingYes==1] <- "Smoker"
data$smoking[data$SmokingYes==0] <- "Non Smoker"
data$smoking <- factor(data$smoking, levels = c("Smoker", "Non Smoker"))

data$SmokingYes <- NULL

data$comorbidity <- "Blank"
data$comorbidity[data$ComorbidityYes==1] <- "Comorbidity"
data$comorbidity[data$ComorbidityYes==0] <- "No Comorbidity"
data$comorbidity <- factor(data$comorbidity, levels = c("Comorbidity", "No Comorbidity"))

data$ComorbidityYes <- NULL


## 3) MERGE DATASETS ##################################################################

data <- merge(data, Pr.H, by = "Profile")
data <- merge(data, Pr.Q, by = "Profile")
data <- merge(data, Pr.D, by = "Profile")


## 4) Create Risk Profile Groupings ##################################################################
### NOTE: Grouping done by death risk level
data$riskprofile <- "Blank"
data$riskprofile[data$Pr.D<.01] <- "Risk 5"
data$riskprofile[(data$Pr.D<.07) & (data$Pr.D>.01)] <- "Risk 4"
data$riskprofile[(data$Pr.D<.14) & (data$Pr.D>.07)] <- "Risk 3"
data$riskprofile[(data$Pr.D<.24) & (data$Pr.D>.14)] <- "Risk 2"
data$riskprofile[(data$Pr.D>.24)] <- "Risk 1"
# data$riskprofile[data$Pr.D<.01] <- "Risk 5"
# data$riskprofile[(data$Pr.D<.09) & (data$Pr.D>.01)] <- "Risk 4"
# data$riskprofile[(data$Pr.D<.19) & (data$Pr.D>.09)] <- "Risk 3"
# data$riskprofile[(data$Pr.D<.3) & (data$Pr.D>.19)] <- "Risk 2"
# data$riskprofile[(data$Pr.D>.3)] <- "Risk 1"
data$riskprofile <- factor(data$riskprofile, levels = c("Risk 1", "Risk 2", "Risk 3", "Risk 4", "Risk 5" ))

## Round all numeric variable to 3 digits
data <- data %>% 
  mutate_if(is.numeric, round, digits = 3)
```

```{r risk-profile-table, echo=FALSE}
unit.scale = function(x) (x - min(x)) / (max(x) - min(x))

as.datatable(formattable(subset(data, select = c(riskprofile,  age, BMI, smoking, comorbidity, `LA County`,  Pr.H, Pr.Q, Pr.D)), 
            align =c("l","l","l","l","l","l","l","c","c","c","l","l","l"), 
            list(
  #`Profile` = formatter("span", style = ~ style(color = "grey",font.weight = "bold")), 
  `age`= color_tile('yellow', 'darkorange'),
  `BMI`= color_tile('lightblue', 'pink'),
  `smoking`= color_tile('grey', 'transparent'),
  `comorbidity`= color_tile('darkgrey', 'transparent'),
  `riskprofile`= color_tile('red', 'green'),
  `LA County`= color_bar('cornflowerblue', fun = unit.scale),
  `Pr.H`= color_bar('violet', fun = unit.scale),
  `Pr.Q`= color_bar('violet', fun = unit.scale),
  `Pr.D`= color_bar('violet', fun = unit.scale)
)), rownames = FALSE, colnames = c('Pop prevalence Pr(Profile i in L.A.County)' = 'LA County', 'Age' = 'age', 'BMI status' = 'BMI', 'Smoking status' = 'smoking', 'Existing comorbidities' = 'comorbidity', 'Risk Group' = 'riskprofile', 'Pr(Hospital|Illness)' = 'Pr.H', 'Pr(ICU|Hospital)' = 'Pr.Q', 'Pr(Death|ICU)' = 'Pr.D' ), 
#filter = 'bottom', 
options = list(pageLength = 10, 
               autoWidth = TRUE, 
               order = list(list(6, 'desc'), list(7, 'desc'), list(8, 'desc')))
)
```

## 5 Risk Groups by Stage of Disease and SPA

```{r}
## 0) PROCESS DATA TO PLOT STACKED BAR CHARTS #######################################################################################
data.melted <- melt(data, id = c('Profile', 'age', 'BMI', 'smoking', 'comorbidity', 'Pr.H', 'Pr.Q', 'Pr.D', 'riskprofile'))

data.melted$SPA.Name <- data.melted$variable
data.melted$variable <- NULL

data.melted$SPA.Name <- factor(data.melted$SPA.Name, levels =  c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County"))

data.melted$prevalence.gen.pop <- data.melted$value
data.melted$value <- NULL

#merge with everything else

full.data <- merge(data.melted, dataH.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataQ.melted, by = c('Profile', 'SPA.Name' ) )
full.data <- merge(full.data, dataD.melted, by = c('Profile', 'SPA.Name' ) )

# Risk coloring
risk_color_key <- c("Risk 1" = "#ff0000", "Risk 2" = "#bf4000", "Risk 3" = "#7f7f00", "Risk 4" = "#40bf00", "Risk 5" = "#00ff00")


## 1) Risk profile #######################################################################################
risk_profile_chart <- function(y, title) {
  ggplot(data = full.data, aes(x=SPA.Name, y = {{y}}, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') +
    scale_fill_manual("legend", values = risk_color_key) + 
    labs(title = glue("Risk profiles in {title} by SPA"), x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))
}

p.risk.gen <- risk_profile_chart(y = prevalence.gen.pop, title = "hospitalized")
p.risk.h <- risk_profile_chart(y = prevalence.H, title = "general population")
p.risk.q <- risk_profile_chart(y = prevalence.Q, title = "ICU")
p.risk.d <- risk_profile_chart(y = prevalence.D, title = "deceased")

risk_factor_chart <- function(y, fill, title) {
  ggplot(data = full.data, aes(x = SPA.Name, y = {{y}}, fill = {{fill}})) +
    geom_bar(position="stack", stat = 'identity') +
    labs(title = title, x = "SPA", y = "Prevalence") + 
    scale_x_discrete(labels = c("Antelope Valley", "San Fernando", "San Gabriel", "Metro", "West", "South", "East", "South Bay", "LA County")) +
    theme(axis.text.x = element_text(angle = 45))
}

## 1) Risk factors in general population ######################################
p.BMI.gen   <- risk_factor_chart(y = prevalence.gen.pop, fill = BMI, title = "Obesity in general population by SPA")
p.comb.gen  <- risk_factor_chart(y = prevalence.gen.pop, fill = comorbidity, title = "Comorbidity in general population by SPA")
p.age.gen   <- risk_factor_chart(y = prevalence.gen.pop, fill = age, title = "Age in general population by SPA")
p.smoke.gen <- risk_factor_chart(y = prevalence.gen.pop, fill = smoking, title = "Smoking in general population by SPA")

## 2) Risk factors in hospitalized population #################################
p.BMI.h   <- risk_factor_chart(y = prevalence.H, fill = BMI, title = "Obesity in hospitalized by SPA")
p.comb.h  <- risk_factor_chart(y = prevalence.H, fill = comorbidity, title = "Comorbidity in hospitalized by SPA")
p.age.h   <- risk_factor_chart(y = prevalence.H, fill = age, title = "Age in hospitalized by SPA")
p.smoke.h <- risk_factor_chart(y = prevalence.H, fill = smoking, title = "Smoking in hospitalized by SPA")

## 3) Risk factors in ICU population ##########################################
p.BMI.q   <- risk_factor_chart(y = prevalence.Q, fill = BMI, title = "Obesity in ICU by SPA")
p.comb.q  <- risk_factor_chart(y = prevalence.Q, fill = comorbidity, title = "Comorbidity in ICU by SPA")
p.age.q   <- risk_factor_chart(y = prevalence.Q, fill = age, title = "Age in ICU by SPA")
p.smoke.q <- risk_factor_chart(y = prevalence.Q, fill = smoking, title = "Smoking in ICU by SPA")

## 4) Risk factors in deceased ################################################
p.BMI.d   <- risk_factor_chart(y = prevalence.D, fill = BMI, title = "Obesity in deceased by SPA")
p.comb.d  <- risk_factor_chart(y = prevalence.D, fill = comorbidity, title = "Comorbidity in deceased by SPA")
p.age.d   <- risk_factor_chart(y = prevalence.D, fill = age, title = "Age in deceased by SPA")
p.smoke.d <- risk_factor_chart(y = prevalence.D, fill = smoking, title = "Smoking in deceased by SPA")
```


```{r include=FALSE}

# RISK PROFILE AT EACH STAGE FOR LA COUNTY

## RESHAPE DATASET #######################################################################################

full.data <- full.data %>%
  gather(keys, values, prevalence.gen.pop:prevalence.D )
full.data$stage <- full.data$keys
full.data$keys <- NULL 
full.data$stage <- factor(full.data$stage, levels =  c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D"))

## Prevalence of risk profiles at each stage of disease ##############################################################  

labels.SPA <- c(`Antelope Valley` = 'Antelope Valley' , 
                `San Fernando` = 'San Fernando' , 
                `San Gabriel`= 'San Gabriel' , 
                Metro = 'Metro', 
                West = 'West', 
                South = 'South', 
                East = 'East', 
                `South Bay` = 'South Bay' , 
                `LA County` = 'LA County')

p.prev.risk.stage.SPAs <- ggplot(full.data, aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = risk_color_key) + 
    facet_wrap(SPA.Name ~ ., labeller=labeller(SPA.Name = labels.SPA)) +
    labs(title = "Prevalence of risk profiles at each stage for LA County and SPAs", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

### Risk profiles, comorbidity, age, obesity by stage of disease for LA County ##############################################################  

LA.data <- subset(full.data, SPA.Name == 'LA County')

p.riskprofiles <- 
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = riskprofile)) +
    geom_bar(position="stack", stat = 'identity') + 
    scale_fill_manual("legend", values = risk_color_key) + 
    labs(title = "Risk Profiles By Stage of Disease", x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))

la_risk_factor_chart <- function(fill, title) {
  ggplot(subset(full.data, SPA.Name == 'LA County'), aes(x = stage, y = values, fill = {{fill}})) +
    geom_bar(position="stack", stat = 'identity') + 
    labs(title = title, x = "Stage", y = "Prevalence") +
    scale_x_discrete(labels = c("General Pop", "Hospitalized", "ICU", "Dead")) +
    theme(axis.text.x = element_text(angle = 45))
}

p.BMI <-     la_risk_factor_chart(BMI, "Obesity By Stage of Disease")
p.age <-     la_risk_factor_chart(age, "Age By Stage of Disease")
p.comb <-    la_risk_factor_chart(comorbidity, "Any Comorbidity By Stage of Disease")
p.smoking <- la_risk_factor_chart(smoking, "Smoking Status By Stage of Disease")
```

- These figures show the estimated proportion of each *risk group* that will make up the resulting cohorts of COVID patients admitted to hospital, admitted to ICU, or that die within the L.A. County/SPA population, based on the population prevalence of the risk group in L.A. County/SPAs. 
- The analyses are presented for each risk group, as well as stratified to the individual risk factors (age, comorbidities, obesity status, smoking status).

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#riskgrouptab1"><b>By SPA, stage of disease</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#riskgrouptab2"><b>By stage of disease, SPA</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="riskgrouptab1" class="tab-pane active">
```{r}
p.risk.gen + p.risk.h + p.risk.q + p.risk.d
```
</div>

<div id="riskgrouptab2" class="tab-pane">
```{r}
p.prev.risk.stage.SPAs
```
</div>

</div>
</div>

## Key Risk Factors by Stage of Disease

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:50%">
<a class="nav-link active" data-toggle="tab" href="#keyriskfactortab1"><b>Comparing risk factors</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab2"><b>Age by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab3"><b>Comorbidity by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab4"><b>BMI by stage of disease</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#keyriskfactortab5"><b>Smoking by stage of disease</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="keyriskfactortab1" class="tab-pane active">
```{r}
p.riskprofiles + p.comb + p.age + p.BMI
```
</div>

<div id="keyriskfactortab2" class="tab-pane">
```{r}
p.age.gen + p.age.h + p.age.q + p.age.d
```
</div>

<div id="keyriskfactortab3" class="tab-pane">
```{r}
p.comb.gen + p.comb.h + p.comb.q + p.comb.d
```
</div>

<div id="keyriskfactortab4" class="tab-pane">
```{r}
p.BMI.gen + p.BMI.h + p.BMI.q + p.BMI.d
```
</div>

<div id="keyriskfactortab5" class="tab-pane">
```{r}
p.smoke.gen + p.smoke.h + p.smoke.q + p.smoke.d
```
</div>

</div>
</div>

## {-}

```{r trajectory-process-clean, include=FALSE}
## PROCESS TRAJ.OUT TO FIND MEAN  ############################################################################
H.mean <- traj.CI.out %>% select(c(date,state.name,mean)) %>% filter(state.name==c("Htot"))
Q.mean <- traj.CI.out %>% select(c(date,state.name,mean)) %>% filter(state.name==c("Q"))
D.mean <- traj.CI.out %>% select(c(date,state.name,mean)) %>% filter(state.name==c("D"))

H.mean$H <- H.mean$mean
H.mean$mean <- NULL
H.mean$state.name <- NULL
Q.mean$Q <- Q.mean$mean
Q.mean$mean <- NULL
D.mean$D <- D.mean$mean
D.mean$mean <- NULL
HQD.mean <- cbind(cbind(H.mean,Q.mean$Q),D.mean$D)
colnames(HQD.mean) <- c("date","H","Q","D")

## FIX DATES ##################################################################
HQD.mean$date <- as.Date(HQD.mean$date)

## ORGANIZE / CLEAN ##################################################################
HQD.mean2 <- HQD.mean
HQD.mean2$Hospitalizations <- HQD.mean2$H
HQD.mean2$H <- NULL
HQD.mean2$ICU <- HQD.mean2$Q
HQD.mean2$Q <- NULL
HQD.mean2$Deaths <- HQD.mean2$D
HQD.mean2$D <- NULL
HQD.mean2 <- melt(HQD.mean2,id = 'date')
HQD.mean2$Stage <- HQD.mean2$variable
HQD.mean2$variable <- NULL

HQD.mean2$Stage <- factor(HQD.mean2$Stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
```

```{r trajectory-groupby.risk, include=FALSE}

# Trajectory count data 

#pull the total for each risk profile by stage
count_risk_profile <- function(group) {
  grouped.by.data <- full.data %>% 
  dplyr::group_by(stage, {{group}}, SPA.Name) %>% 
  dplyr::summarise(values = sum(values)) %>%
  ungroup

  #Add all the factor names to the grouped.by.risk dataframe so we can rename the factors in the dataframe to match the daily count
  grouped.by.data$stage <- factor(grouped.by.data$stage, levels = c("prevalence.gen.pop", "prevalence.H", "prevalence.Q", "prevalence.D", "Hospitalizations", "ICU", "Deaths"  ))
  
  #match the daily count naming
  grouped.by.data$stage[grouped.by.data$stage == "prevalence.H"] <- "Hospitalizations"
  grouped.by.data$stage[grouped.by.data$stage == "prevalence.Q"] <- "ICU"
  grouped.by.data$stage[grouped.by.data$stage == "prevalence.D"] <- "Deaths"
  
  #break down daily count by risk profile
  left_join(
    HQD.mean2 %>% dplyr::rename(count=value), 
    grouped.by.data,
    by = c("Stage" = "stage")
  ) %>% 
    dplyr::rename(prop=values) %>% 
    mutate(count_res=round(count*prop,3))
}

count.risk <- count_risk_profile(riskprofile)
count.comb <- count_risk_profile(comorbidity)
count.age <- count_risk_profile(age)
count.BMI <- count_risk_profile(BMI)
count.smoke <- count_risk_profile(smoking)
```

```{r}
#Hospitalizations
trajectory_chart <- function(data, fill, stage, y.label) {
  ggplot(filter(data, SPA.Name == 'LA County' & Stage == stage), 
         aes(x = date,
             y = count_res,
             fill = {{fill}})) +
    geom_area() +
    labs(title = glue("{stage} by Risk Profile for LA County"),
         x = "Date",
         y = y.label) +
    scale_x_date(limits = as.Date(c("2020-03-01","2021-01-01")), date_breaks = "1 month" , date_labels = "%d-%b-%y") +
    theme(axis.text.x = element_text(angle = 90), 
                   strip.text.x = element_text(size = 12, face = "bold"))
}

p.traj.risk.h <- trajectory_chart(count.risk, fill = riskprofile, stage = "Hospitalizations", y.label = "Numbers in Hospital") +
      scale_fill_manual("legend", values = risk_color_key) 
p.traj.risk.q <- trajectory_chart(count.risk, fill = riskprofile, stage = "ICU", y.label = "Numbers in ICU") +
      scale_fill_manual("legend", values = risk_color_key)
p.traj.risk.d <- trajectory_chart(count.risk, fill = riskprofile, stage = "Deaths", y.label = "Number deceased") +     
  scale_fill_manual("legend", values = risk_color_key)

p.traj.comb.h <- trajectory_chart(count.comb, fill = comorbidity, stage = "Hospitalizations", y.label = "Numbers in Hospital")
p.traj.comb.q <- trajectory_chart(count.comb, fill = comorbidity, stage = "ICU", y.label = "Numbers in ICU")
p.traj.comb.d <- trajectory_chart(count.comb, fill = comorbidity, stage = "Deaths", y.label = "Number deceased")

p.traj.age.h <- trajectory_chart(count.age, fill = age, stage = "Hospitalizations", y.label = "Numbers in Hospital")
p.traj.age.q <- trajectory_chart(count.age, fill = age, stage = "ICU", y.label = "Numbers in ICU")
p.traj.age.d <- trajectory_chart(count.age, fill = age, stage = "Deaths", y.label = "Number deceased")

p.traj.BMI.h <- trajectory_chart(count.BMI, fill = BMI, stage = "Hospitalizations", y.label = "Numbers in Hospital")
p.traj.BMI.q <- trajectory_chart(count.BMI, fill = BMI, stage = "ICU", y.label = "Numbers in ICU")
p.traj.BMI.d <- trajectory_chart(count.BMI, fill = BMI, stage = "Deaths", y.label = "Number deceased")

p.traj.smoke.h <- trajectory_chart(count.smoke, fill = smoking, stage = "Hospitalizations", y.label = "Numbers in Hospital")
p.traj.smoke.q <- trajectory_chart(count.smoke, fill = smoking, stage = "ICU", y.label = "Numbers in ICU")
p.traj.smoke.d <- trajectory_chart(count.smoke, fill = smoking, stage = "Deaths", y.label = "Number deceased")
```

## Trajectories: Hospitalizations, ICU, Deaths by Key Risk Factors LA County

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#trajectory1tab1"><b>By risk group</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#trajectory1tab2"><b>By age</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#trajectory1tab3"><b>By comorbidity</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#trajectory1tab4"><b>By obesity status</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#trajectory1tab5"><b>By smoking status</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="trajectory1tab1" class="tab-pane active">
```{r}
(p.traj.risk.h + p.traj.risk.q) / p.traj.risk.d
```
</div>

<div id="trajectory1tab2" class="tab-pane">
```{r}
(p.traj.age.h + p.traj.age.q) / p.traj.age.d
```
</div>

<div id="trajectory1tab3" class="tab-pane">
```{r}
(p.traj.comb.h + p.traj.comb.q) / p.traj.comb.d
```
</div>

<div id="trajectory1tab4" class="tab-pane">
```{r}
(p.traj.BMI.h + p.traj.BMI.q) / p.traj.BMI.d
```
</div>

<div id="trajectory1tab5" class="tab-pane">
```{r}
(p.traj.smoke.h + p.traj.smoke.q) / p.traj.smoke.d
```
</div>

</div>
</div>

## Trajectories: Broken down by key risk factors for LA County

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:50%">
<a class="nav-link active" data-toggle="tab" href="#trajectory2tab1"><b>Hospitalizations by risk group, age, comorbidity, BMI status</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#trajectory2tab2"><b>ICU by risk group, age, comorbidity, BMI status</b></a>
</li>

<li class="nav-item" style ="width:50%">
<a class="nav-link" data-toggle="tab" href="#trajectory2tab3"><b>Deaths by risk group, age, comorbidity, BMI status</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="trajectory2tab1" class="tab-pane active">
```{r}
p.traj.risk.h + p.traj.age.h + p.traj.comb.h + p.traj.BMI.h
```
</div>

<div id="trajectory2tab2" class="tab-pane">
```{r}
p.traj.risk.q + p.traj.age.q + p.traj.comb.q + p.traj.BMI.q
```
</div>

<div id="trajectory2tab3" class="tab-pane">
```{r}
p.traj.risk.d + p.traj.age.d + p.traj.comb.d + p.traj.BMI.d
```
</div>

</div>
</div>

# Parameter estimates

```{r}
out_R0 <- as.data.frame(cbind(ABC_out$param[,1],ABC_out$weights))
out_r <- as.data.frame(cbind(ABC_out$param[,2],ABC_out$weights))
out_st <- as.data.frame(cbind(ABC_out$param[,3],ABC_out$weights))
out_R0redux <- as.data.frame(cbind(ABC_out$param[,4],ABC_out$weights))
out_Delta <- as.data.frame(cbind(ABC_out$param[,5],ABC_out$weights))
out_Alpha <- as.data.frame(cbind(ABC_out$param[,6],ABC_out$weights))
out_Kappa <- as.data.frame(cbind(ABC_out$param[,7],ABC_out$weights))
out_p_V <- as.data.frame(cbind(ABC_out$param[,8],ABC_out$weights))
```


## Model estimated parameters and prior information
Here we summarize our estimated parameter values for key epidemic and model quantities: 

- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are observed
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness, i.e. $Pr(Hospital | Illness)$
- $\kappa$, the probability of ICU care necessary given hospitalization, i.e. $Pr(ICU | Hospital)$
- $p_v$, the probability of ventilation given ICU care, i.e. $Pr(Ventilation | ICU)$
- $\delta$, the probability of death given ICU care, i.e. $Pr(Death | ICU)$

Because our model is stochastic and we are using Bayesian techniques for parameter estimation, each posterior parameter estimate is represented by a distribution of likely values.

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">

<li class="nav-item active" style ="width:100%">
<a class="nav-link active" data-toggle="tab" href="#paramestimatestab1"><b>Summary of estimated parameters</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab2"><b>$R0$, Reproductive number</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab3"><b>$r$, proportion of observed illnesses</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab4"><b>$Frac_{R0}$, the reduction in the initial R0 due to social distancing</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab5"><b>Incorporation of risk factors</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab6"><b>$Pr(Hospital|Illness)$, the probability of hospitalization given illness</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab7"><b>$Pr(ICU|Hospital)$, the probability of ICU care necessary given hospitalization</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab8"><b>$Pr(Death|ICU)$, the probability of death given ICU care</b></a>
</li>

<li class="nav-item" style ="width:100%">
<a class="nav-link" data-toggle="tab" href="#paramestimatestab9"><b>$Pr(Ventilation|ICU)$, the probability of ventilation given ICU care</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="paramestimatestab1" class="tab-pane active">
This table summarizes key statistics of each estimated parameter: the mean and the standard deviation (sd).

```{r estimated-par, echo=FALSE}

ABC.par.stats.print <- dplyr::select(ABC.par.stats, -c('Start time'))
#ABC.par.stats.print$"Reduction R0 Mar11"[1] <- 1-ABC.par.stats.print$"Reduction R0 Mar11"[1]
#ABC.par.stats.print$"Reduction R0 Apr23"[1] <- 1-ABC.par.stats.print$"Reduction R0 Apr23"[1]

kable(ABC.par.stats.print, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```
</div>

<div id="paramestimatestab2" class="tab-pane">
* Mean = `r round(ABC.par.stats$R0[1],3)`
* Standard deviation = `r round(ABC.par.stats$R0[2],3)`

**Information informing prior distribution**
- $R0$ prior estimate is based on values for $R0$ estimated from other published studies on COVID-19.

```{r posterior-R0, echo=FALSE}

x1 <- seq(1.0,4,length=50)
y1 <- dnorm(x1, mean=2.7, sd=0.3)
d1 <- data.frame(x1,y1)
p1 <- ggplot(d1, aes(x=x1, y=y1)) +
  geom_line()+ylab("density")+xlab("R0 Prior")+ggtitle("R0 Assumed Prior Distribution") 

p=ggplot(out_R0, aes(V1)) + geom_density() + xlab("R0 Posterior Distribution") +xlim(1,4) + ggtitle("R0 Model Estimated Posterior Distribution") 

p1 + p
```
</div>

<div id="paramestimatestab3" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,2],3)`
* Standard deviation = `r round(ABC.par.stats[2,2],3)`

```{r posterior-r, echo=FALSE}

x2 <- seq(0,0.5,length=50)
y2 <- dunif(x2, .05, 0.3)
d2 <- data.frame(x2,y2)
p2 <- ggplot(d2, aes(x=x2, y=y2)) +
  geom_line()+ylab("density")+xlab("Proportion Unreported Prior")+ggtitle("Proportion Reported Cases: Assumed Prior Distribution")


p=ggplot(out_r, aes(V1)) + geom_density() + xlab("Proportion Reported Posterior") +xlim(0,.5) + ggtitle("Proportion Reported Cases: Model Estimated Posterior Distribution") 

p2 + p
```
</div>

<div id="paramestimatestab4" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,4],3)`
* Standard deviation = `r round(ABC.par.stats[2,4],3)`


**Information informing this parameter's prior distribution:**

- We use mobility data to narrow the specification of the reduction in the average number of new infections due to an infected person (R0) in a completely susceptible population under recent social distancing restrictions.

- Effectively, reductions in mobility correspond to a proportional reduction in R0

- Reduction in mobility observed in LA County:
![Mobility reduction](mobility_redux.png)
**Source**: [Assessing changes in commuting and individual mobility
in major metropolitan areas in the United States during
the COVID-19 outbreak](https://www.mobs-lab.org/uploads/6/7/8/7/6787877/assessing_mobility_changes_in_the_united_states_during_the_covid_19_outbreak.pdf)

- Our modeled reduction in R0 timeline:
```{r posterior-R0-timeline, echo=FALSE}

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
p <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01"))) # date_labels = "%b %d %Y")+ggtitle("Reduction in R0 over time, following observed data)
p
```

```{r posterior-R0-redux, echo=FALSE}
x4 <- seq(.15,.7,length=50)
y4 <- dunif(x4, .3, .55)
d4 <- data.frame(x4,y4)
p4 <- ggplot(d4, aes(x=x4, y=y4)) +
  geom_line()+ylab("density")+xlab("R0 Fraction Reduction Prior")+ggtitle("R0 Fraction Reduction: Assumed Prior")

p=ggplot(out_R0redux, aes(V1)) + geom_density() + xlab("R0 Fraction Reduction Posterior") +xlim(.2,.7) + ggtitle("R0 Fraction Reduction: Posterior") 

p4 + p
```
</div>

<div id="paramestimatestab5" class="tab-pane">
We use previous studies to narrow the specification of the probability of hospitalization given illness, admittance to the intensive care unit (ICU) given being in hospital, ventilation given being in ICU, and death given being in ICU by incorporating risk factors, including age, sex, smoking and other comorbidities.
The prevalence of these risk factors in Los Angeles County is also included.

Studies on COVID-19 clinical presentation and trajectories to inform the probability of hospitalization, ICU, and ventilation based on single risk factors:
- Guan, Wei-jie, et al. "[Clinical characteristics of coronavirus disease 2019 in China.](https://www.nejm.org/doi/full/10.1056/NEJMoa2002032)" New England Journal of Medicine (2020). 
- Petrilli, Christopher M., et al. "[Factors associated with hospitalization and critical illness among 4,103 patients with COVID-19 disease in New York City](https://www.medrxiv.org/content/10.1101/2020.04.08.20057794v1)." medRxiv (2020).


Prevalence data sources:
- [Los Angeles County Health Survey](http://publichealth.lacounty.gov/ha/hasurveyintro.htm)
- [UCLA California Health Information Survey](https://healthpolicy.ucla.edu/chis/Pages/default.aspx)
</div>

<div id="paramestimatestab6" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,6],3)`
* Standard deviation = `r round(ABC.par.stats[2,6],3)`

```{r posterior-alpha, echo=FALSE}
x6 <- seq(.05,.5,length=50)
y6 <- dunif(x6, Alpha.prior.mean - (Alpha.prior.mean/6), Alpha.prior.mean + (Alpha.prior.mean/2))
d6 <- data.frame(x6,y6)
p6 <- ggplot(d6, aes(x=x6, y=y6)) +
  geom_line()+ylab("density")+xlab("Pr(Hospitalization) Prior")+ggtitle("Pr(Hospitalization): Assumed Prior Distribution")

p=ggplot(out_Alpha, aes(V1)) + geom_density() + xlab("Pr(Hospitalization) Posterior") +xlim(.05,.5) + ggtitle("Pr(Hospitalization) Posterior Distribution") 

p6 + p
```
</div>

<div id="paramestimatestab7" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,7],3)`
* Standard deviation = `r round(ABC.par.stats[2,7],3)`

```{r posterior-kappa, echo=FALSE}

x7 <- seq(.15,.7,length=50)
y7 <- dunif(x7, Kappa.prior.mean - (Kappa.prior.mean/6), Kappa.prior.mean + (Kappa.prior.mean/2))
d7 <- data.frame(x7,y7)
p7 <- ggplot(d7, aes(x=x7, y=y7)) +
  geom_line()+ylab("density")+xlab("Pr(ICU) Prior")+ggtitle("Pr(ICU): Assumed Prior Distribution")

p=ggplot(out_Kappa, aes(V1)) + geom_density() + xlab("Pr(ICU) Posterior") +xlim(.15,.7) + ggtitle("Pr(ICU) Posterior Distribution") 

p7 + p
```
</div>

<div id="paramestimatestab8" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,5],3)`
* Standard deviation = `r round(ABC.par.stats[2,5],3)`

```{r posterior-delta, echo=FALSE}

x5 <- seq(.15,.9,length=50)
y5 <- dunif(x5, .2, .8)
d5 <- data.frame(x5,y5)
p5 <- ggplot(d5, aes(x=x5, y=y5)) +
  geom_line()+ylab("density")+xlab("Pr(Death) Prior")+ggtitle("Pr(Death): Assumed Prior Distribution")

p=ggplot(out_Delta, aes(V1)) + geom_density() + xlab("Pr(Death) Posterior") +xlim(.15,.9) + ggtitle("Pr(Death) Posterior Distribution") 

p5 + p
```
</div>

<div id="paramestimatestab9" class="tab-pane">
* Mean = `r round(ABC.par.stats[1,8],3)`
* Standard deviation = `r round(ABC.par.stats[2,8],3)`

```{r posterior-p_V, echo=FALSE}
x8 <- seq(.4,.95,length=50)
y8 <- dunif(x8, 0.6,0.9)
d8 <- data.frame(x8,y8)
p8 <- ggplot(d8, aes(x=x8, y=y8)) +
  geom_line()+ylab("density")+xlab("Pr(Ventilation) Prior")+ggtitle("Pr(Ventilation): Assumed Prior Distribution")

p=ggplot(out_p_V, aes(V1)) + geom_density() + xlab("Pr(Ventilation) Posterior") +xlim(.4,.95) + ggtitle("Pr(Ventilation) Posterior Distribution") 

p8 + p
```
</div>

</div>
</div>

# Summary
- Predictive epidemic modeling can help to evaluate the public health strategies for limiting the spread of COVID-19.
LA County is succeeding in mitigating the epidemic curve due to strong adherence to social distancing (model-estimated reduction in infection rate of >60%).
- Our model suggests that social distancing may need to be continued for a longer period of time to retain these mitigation effects.
- Our model predicts that higher risk groups -- characterized not only by advanced age but also combinations of existing health conditions -- will make up the majority of those afflicted with severe disease. This model estimates how disparities in prevalences of risk factors across neighborhoods within LA will impact severe disease outcomes.
- Model estimates can and will change as new data comes in.

# Methods and data

## Data

### Illness case data

- We use current numbers of **infected (observed)**, **hospitalized**, **ICU**, **ventilated**, and **deaths**, as well as the capacity (total number of resouces available) at hospitals, ICUs, and ventilators in L.A. County from the Los Angeles County Department of Public Health, updated daily by Faith Washburn (shared privately)
- The data used in this version of the report (April 24th, 2020) includes counts up through **April 22th, 2020**

## Model overview

### Stochastic differential equation model: 

- Deterministic model: for given values of parameters, dynamics across compartments will be fixed. 
- Stochastic model: Appropriate probability distributions are used model the transfer of individuals across
compartments.

What a stochastic model allows:

- Looking back: Provides a better framework for parameter estimation, based on observed data 
- Looking forward: Enables forecasts with confidence bounds that account for variability in parameters

### Approximate Bayesian Computation (ABC) for parameter estimation: 

- Allows us to incorporate the uncertainty in all the parameters in fitting the model to data and estimating parameters
- Allows us to include all prior information and/or assumptions about the distribution (the range of values) for each parameter
- Allows us to prioritize data input that is more reliable in fitting the model to data (e.g., not including more unreliable early illness count data)

### Flow diagram

![Compartmental model flow diagram](flow_diagram_v2.png)

### System of Equations
$$
\begin{align*}
    dS/dt &= -\beta S(I+A)\\
    dE/dt &= \beta S(I+A) - \tfrac{1}{d_{EI}}E\\
    dA/dt &= \tfrac{1-r}{d_{EI}}E - \tfrac{1}{d_{IR}}A\\
    dI/dt &= \tfrac{r}{d_{EI}}E - (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I\\
    dH/dt &= \alpha (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I - (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H \\
    dQ/dt &= \kappa (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H - (\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q \\
    dV/dt &= p_V Q\\
    dD/dt &= \delta (\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q\\
    dR/dt &= (1-\alpha) (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I + (1-\kappa) (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H + (1-\delta)(\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q + \tfrac{1}{d_{IR}}A   \
\end{align*}
$$

$$
R0 = \beta ({\frac{r}{\tfrac{\alpha}{d_{IH}}+\tfrac{1-\alpha}{d_{IR}}}+ (1-r){d_{IR}}})
\\
N=S+E+A+I+H+Q+D+R
$$


### Model parameters

| Parameter | Description                                                       | Value                                     |
|-----------|-------------------------------------------------------------------|-------------------------------------------|
| $R0$      | Basic reproductive number                                         | Estimated                                 |
| $\beta$   | transmission rate                                                 | Analytically derived from model and R0    |
| $d_{EI}$  |  days between exposure and infectivity   (incubation period)      | 5 days                                    |
| $d_{IH}$  | days between symptom onset and  hospitalization (if required)     | 10 days                                   |
| $d_{IR}$  | days between symptom onset and  recovery (if not hospitalized)    | 7 days                                    |
| $d_{HQ}$  | days between hospitalization and  ICU (if required)               | 1 days                                    |
| $d_{QR}$  | days between hospitalization and  recovery (if ICU not required)  | 12 days                                   |
| $d_{QD}$  | days between ICU and fatality                                     | 8 days                                    |
| $d_{QR}$  | days between ICU and recovery                                     | 7 days                                    |
| $\alpha$  | probability infected (I) requires  hospitalization (vs. recovers) | Estimated                                 |
| $\kappa$  | probability hospitalized (H)  requires ICU (vs. recovers)         | Estimated                                 |
| $\delta$  | probability ICU (Q) patient dies                                  | Estimated                                 |
| $p_V$     |  probability ventilation (V) required  given ICU                  | Estimated                                 |
| $N$       | Total population size                                             |                                           |
| $S$       | Susceptible population                                            |                                           |
| $E$       | Exposed not yet infectious                                        |                                           |
| $A$       | Infected, unobserved                                              |                                           |
| $I$       | Infected, observed                                                |                                           |
| $H$       | In Hospital                                                       |                                           |
| $Q$       | In ICU                                                            |                                           |
| $V$       | On ventilator                                                     |                                           |
| $D$       | Dead                                                              |                                           |
| $R$       | Recovered/removed                                                 |                                           |


**Model parameters - fixed, taken from literature:**
- Transition times between compartments
- Sources provided at [this link](https://docs.google.com/spreadsheets/d/1PQttOS0VllpDGZswngMBIX5GMV2cMAxyseD3L-aNw-U/edit#gid=1798107562)

**Model Parameters — estimated by our model**
- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are observed
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness, i.e. $Pr(Hospital | Illness)$
- $\kappa$, the probability of ICU care necessary given hospitalization, i.e. $Pr(ICU | Hospital)$
- $p_v$, the probability of ventilation given ICU care, i.e. $Pr(Ventilation | ICU)$
- $\delta$, the probability of death given ICU care, i.e. $Pr(Death | ICU)$

### Projections by Key Risk Groups and Risk Factors

We analyze how population prevalence of known COVID-19 *risk factors*: advanced age, existence of other health conditions or comorbidities, smoking status, and obesity status, affect COVID-19 illness trajectories in L.A. County and spatial subdivisions.

**(1) Estimating the conditional probability of COVID illness severity given combinations of risk factors** 

- Using studies reporting the marginal risk of severe COVID-19 outcomes given individual risk factors, we develop a statistical model to estimate the probability of COVID illness trajectories for individuals with combinations of risk factors.
- Specifically, we estimate the probability that individuals having (or not) combinations of risk factors are admitted to hospital given having acquired illness $Pr(Hospital | Illness)$, are admitted to the ICU given admittance to hospitalized $Pr(ICU | Hospital)$, and that die given being admitted to the ICU $Pr(Death | ICU)$.
- Our methodology for joint risk factor estimation relies on a model, called JAM, developed for use in genome-wide analyses to identify the conditional relative risk (RR) of phenotypic occurrence given joint combinations of genes from two pieces of information: (i) the marginal RR between single genes and phenotype and (ii) the correlation structure between the genes. 
- We apply the JAM model to estimate the conditional RR of COVID-19 illness severity (hospitalization, ICU, and death) given joint combinations of risk factors. For information informing (i) we obtain the marginal RR between individual risk factors and COVID-19 illness severity from published COVID-19 studies (sources below, peer-reviewed where available). For (2), we obtain the correlation structure between the risk factors using data from The National Health and Nutrition Examination Survey (NHANES). NHANES is a survey research program conducted by the National Center for Health Statistics (NCHS) to assess the health and nutritional status of adults and children in the United States, and to track changes over time. We use the NHANES cohort of 2018-2019.
- After obtaining the conditional RR of COVID-19 illness severity (hospitalization, ICU, and death) given joint combinations of risk factors, we convert these to the probabilities $Pr(Hospital | Illness, Profile_i)$, $Pr(ICU | Hospital,Profile_i)$, and $Pr(Death | ICU,Profile_i)$.
- The analysis we present here has taken the combinations of risk factors and grouped these into 5 key *risk groups* according to similar within-group levels of the probabilities $Pr(Hospital | Illness, Profile_i)$, $Pr(ICU | Hospital, Profile_i)$, and $Pr(Death | ICU, Profile_i)$. 
- To produce an estimate of the overall $Pr(Hospital | Illness)$ across all risk groups for L.A. County and subpopulations, we take the weighted average of the probability for each risk group and the prevalence of the risk group in all illnesses, i.e.

$$
\begin{align*}
Pr(Hospital | Illness) = \sum_i Pr(Group_i | Illness)Pr(Hospital|Group_i,Illness)
\end{align*}
$$
We assume that the prevalence of the risk group in the ill population, $Pr(Group_i|Illness)$, is equal to the prevalence of the group in the general population of L.A. County, i.e. $Pr(Group_i)$. We again borrow the correlation structure between risk factors derived from the NHANES cohort to estimate the population prevalence $Pr(Group_i)$ from available data on the prevalence of individual risk factors.

The same approach is applied to estimate $Pr(ICU | Hospital)$ and $Pr(Death|ICU)$:
$$
\begin{align*}
Pr(ICU | Hosptial) = \sum_i Pr(Group_i | Hospital)Pr(ICU|Group_i,Hospital)\\
Pr(Death | ICU) = \sum_i Pr(Group_i | ICU)Pr(Death|Group_i,ICU)
\end{align*}
$$

**(2) Estimating the proportion of each risk group that will make up the cohorts of COVID patients admitted to hospital, admitted to ICU, or that die in L.A. County and SPAs**

- We estimate the proportion of each risk group that will make up the cohorts of COVID patients admitted to hospital ($Pr(Group_i|Hospital$)), admitted to ICU ($Pr(Group_i|ICU$)), or death ($Pr(Group_i|Death$)) in L.A. County population and each SPA, as the relative share of each group and disease status, i.e.
$$
\begin{align*}
Pr(Group_i|Hospital) = \frac{Pr(Group_i|Illness)Pr(Hospital|Group_i,Illness)}{Pr(Hospital|Illness)}\\
Pr(Group_i|ICU) = \frac{Pr(Group_i|Hospital)Pr(ICU|Group_i,Hospital)}{Pr(ICU|Hospital)}\\
Pr(Group_i|Death) = \frac{Pr(Group_i|ICU)Pr(Death|Group_i,ICU)}{Pr(Death|ICU)}\\
\end{align*}
$$
We multiply the group prevalences above by the trajectory median values for number in hospital, ICU, and death from the epidemic model to arrive at the trajectory breakdowns presented above.

**Data sources**

- The comorbidities included in the "any comorbidity" category are: hypertension, diabetes, cardiovascular disease, cerebrovascular disease / stroke, cancer, COPD, and athsma. It is important to note that each of these conditions has its own risk of disease outcome; future models will disaggregate risk estimates by specific risk conditions when sufficient data becomes available to produce these estimations. 
Studies on COVID-19 clinical presentation and trajectories to inform the probability of hospitalization, ICU, and ventilation based on single risk factors:
- Guan, Wei-jie, et al. "[Clinical characteristics of coronavirus disease 2019 in China.](https://www.nejm.org/doi/full/10.1056/NEJMoa2002032)" New England Journal of Medicine (2020). 
- Petrilli, Christopher M., et al. "[Factors associated with hospitalization and critical illness among 4,103 patients with COVID-19 disease in New York City](https://www.medrxiv.org/content/10.1101/2020.04.08.20057794v1)." medRxiv (2020).
- [Summary table of the modified Relative Risks (RR) coming from these studies, which are used by our statistical model estimates](https://docs.google.com/spreadsheets/d/1Crsz7hfgBx4_-SsZI7u0e6IrHlQa-qVPbr3N87fUuqg/edit#gid=1637953801) 

## Limitations
- This model does not account for differences in contact patterns within and across key groups, such as workplaces, schools, and communities; or of group-specific social distancing scenarios.
- This model does not account for the role of interventions beyond social distancing, such as contact tracing and surveillance testing, which are critical to identifying and limiting the spread of the virus.
- This model focuses only on the direct effects of stay-at-home orders on COVID-19 infection transmission and hospitalization. It does not account for the non-COVID-19 related public health impact of stay-at-home orders.
- This model does not account for unanticipated behavioral responses to the effects of interventions or mitigation strategies
- New information about the epidemiological characteristics of COVID-19 is continuously arising, and incorporating the latest information into our models is possible and will be key to maintaining its relevance for decision insights. 

# Coming soon

- Projections by SPA
- Projections by race/ethnicity

# Team

[Abigail Horn](www.abigail-horn.com)

[Lai Jiang](https://scholar.google.com/citations?user=GhsMHqYAAAAJ&hl=en)

[Emil Hvirfeldt](https://www.hvitfeldt.me/)

[Wendy Cozen](https://keck.usc.edu/faculty-search/wendy-cozen/)

[David Conti](https://keck.usc.edu/faculty-search/david-v-conti/)

# Acknowledgements
- We would like to acknowledge Claire Jacquillat and Adam Taylor for their contributions related to data wrangling, cleaning, interpretation, and visualization.

# Appendix

Specification of stochastic model

## Specification of stochastic model

```{r stochastic-model}
lang_output <- function(x, lang) {
  cat(c(sprintf("```%s", lang), x, "```"), sep = "\n")
}
r_output <- function(x) lang_output(x, "r")
r_output(readLines(path_seihqdr_model))
```


