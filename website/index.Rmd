---
title: "Predictive Epidemic Model for LA County"
author: "Abigail Horn, Lai Jiang, Wendy Cozen, David Conti, Department of Preventive Medicine, USC"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      out.width = "100%",
                      fig.asp = 0.619, fig.width = 10,
                      dpi = 300)
```

```{r}
library(tidyverse)
library(patchwork)
library(here)
library(glue)
library(odin)
library(fitR)
```

# parameter Estimates

- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are observed
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness
- $\kappa$, the probability of ICU care necessary given hospitalization
- $p_v$, the probability of ventilation given ICU care
- $\delta$, the probability of death given ICU care

```{r}
ABC_out <- read_rds(here("website_results", "ABC_out.rds"))
risk.probs.SPAs <- read_rds(here("website_results", "risk.probs.SPAs.rds"))

Alpha.prior.mean <- risk.probs.SPAs[9, 1]
Kappa.prior.mean <- risk.probs.SPAs[9, 2]

abc_posteriors <- as.data.frame(ABC_out$param) %>%
  set_names(c("R0", "r", "st", "R0redux", "Delta", "Alpha", "Kappa", "p_V")) %>%
  pivot_longer(everything())

abc_priors <- tribble(
  ~param,    ~fun, ~var1, ~var2, ~range1, ~range2,
  "R0",      dnorm, 2.7, 0.3, 1, 4,
  "r",       dunif, .05, 0.3, 0, 0.5,
  "R0redux", dunif, .3, .55, .15,.7,
  "Alpha",   dunif, Alpha.prior.mean - (Alpha.prior.mean / 6), Alpha.prior.mean + (Alpha.prior.mean / 2), .05, .5,
  "Kappa",   dunif, Kappa.prior.mean - (Kappa.prior.mean / 6), Kappa.prior.mean + (Kappa.prior.mean / 2), .15, .7,
  "Delta",   dunif, .2, .8, .15, .9,
  "p_V",     dunif, 0.6, 0.9, .4, .95
) %>%
  pmap_dfr(function(param, fun, var1, var2, range1, range2) {
    x <- seq(range1, range2, length = 512)
    tibble(x,
           y = fun(x, var1, var2),
           param = param)
        })
```

```{r}
parameter_estimates_chart <- function(param0) {
  prior_data <- abc_priors %>%
    filter(param == param0)
  
  p_prior <- prior_data %>%
    ggplot(aes(x, y)) +
    geom_line() + 
    labs(title = glue("{param0} Assumed Prior Distribution"),
         x = glue("{param0} Prior"),
         y = "density") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 1))
  
  p_posterior <- abc_posteriors %>%
    filter(name == param0) %>%
    ggplot(aes(value)) + 
    geom_density() + 
    xlim(range(prior_data$x)) +
    labs(title = glue("{param0} Model Estimated Posterior Distribution"),
         x = glue("{param0} Posterior Distribution"),
         y = NULL) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 1)) 

  p_prior + p_posterior + plot_layout(widths = c(1, 1))
}
```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#paramtab1"><b>$R0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab2"><b>$r$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab3"><b>$Frac_{R0}$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab4"><b>$\alpha$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab5"><b>$\kappa$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab6"><b>$p_v$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#paramtab7"><b>$\delta$</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="paramtab1" class="tab-pane active">
```{r}
parameter_estimates_chart("R0")
```
</div>

<div id="paramtab2" class="tab-pane">
```{r}
parameter_estimates_chart("r")
```
</div>

<div id="paramtab3" class="tab-pane">
```{r}
parameter_estimates_chart("R0redux")
```
</div>

<div id="paramtab4" class="tab-pane">
```{r}
parameter_estimates_chart("Alpha")
```
</div>

<div id="paramtab5" class="tab-pane">
```{r}
parameter_estimates_chart("Kappa")
```
</div>

<div id="paramtab6" class="tab-pane">
```{r}
parameter_estimates_chart("p_V")
```
</div>

<div id="paramtab7" class="tab-pane">
```{r}
parameter_estimates_chart("Delta")
```
</div>

</div>
</div>

# Demonstrating Model Fit Against Data

- Detected illnesses, cumulative = Idetectcum
- Hospitalizations, cumulative = Htotcum
- Deaths, cumulative = D
- Ventilation, cumulative = V
- Hospitalization, daily new incidence = H_new
- Deaths, daily new incidence = D_new

```{r, include=FALSE}
###################################################################################################
## INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

obs_cum_new_counts = t(read.csv(here("data", "cum_counts_040920.csv"), sep=",",stringsAsFactors = FALSE)) 
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.character)
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.numeric)
no_obs <- dim(obs_cum_new_counts)[1]

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
path_seihqdr_model <- here("code", "stochastic_SEIHQDR_A.R")

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

##############################################
## MODEL PROJECTIONS WITH ESTIMATED PARAMETERS
##############################################
ABC.par.out <- as.data.frame(ABC_out$param)

###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## COMPILE
x <- seihqdr_generator(Beta_t = Beta_t, Beta_y = Beta_y, S_ini = 1e7, 
                       E_ini = 10, r = r, Delta = Delta, Alpha = Alpha, 
                       Kappa = Kappa, p_QV = p_V)

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st + no_obs - 1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## SIMULATE AND PLOT ZOOMED
TEST <- as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
```

```{r}
single_plot_traj <- function(var) {
  temp <- utils::capture.output(
  res <- plotTraj(traj = TEST, 
         data = select(obs.shift, c("step", var)),
         state.names = var, 
         time.column ="step",
         summary = TRUE, 
         init.date = initDatePlot)
  )
}
```

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fittab1"><b>Idetectcum</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab2"><b>Htotcum</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab3"><b>D</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab4"><b>Vcum</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab5"><b>H_new</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fittab6"><b>D_new</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fittab1" class="tab-pane active">
```{r}
single_plot_traj("Idetectcum")
```
</div>

<div id="fittab2" class="tab-pane">
```{r}
single_plot_traj("Htotcum")
```
</div>

<div id="fittab3" class="tab-pane">
```{r}
single_plot_traj("D")
```
</div>

<div id="fittab4" class="tab-pane">
```{r}
single_plot_traj("Vcum")
```
</div>

<div id="fittab5" class="tab-pane">
```{r}
single_plot_traj("H_new")
```
</div>

<div id="fittab6" class="tab-pane">
```{r}
single_plot_traj("D_new")
```
</div>

</div>
</div>

## Peak hospitalization, ICU, ventilation vs. capacity

```{r, include=FALSE}
## SIMULATE AND PLOT AGAINST CAPACITY
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)

capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,
                                      capacity_H_vec,
                                      capacity_Q_vec,
                                      capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
CapacityPlot <- plotTraj(traj = TEST, data= capacity_H_Q_V, 
                         state.names = c("H","Q","V"), time.column ="step",
                         summary=TRUE, init.date = initDatePlot)
```

```{r}
CapacityPlot
```

# Sensitivity of model projections to parameter estimates

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#sensT0"><b>$T0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensR0"><b>$R0$</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#sensFracR0"><b>$Frac_{R0}$</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="sensT0" class="tab-pane active">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#T0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#T0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="T0mean" class="tab-pane active">
```{r sensitivity-T0-code, include=FALSE}
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
st_mean <- ABC.par.stats[1,3]
st_sd <- ABC.par.stats[2,3]
st_upper <- st_mean + 1.96*st_sd
st_lower <- st_mean - 1.96*st_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(st){
  
start_time <- st  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(st_mean)
TEST.upper <- get.param.CI(st_upper)
TEST.lower <- get.param.CI(st_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

  ## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r}
CapacityPlot.Mean
```
</div>

<div id="T0upper" class="tab-pane">
```{r}
CapacityPlot.Upper
```
</div>

<div id="T0lower" class="tab-pane">
```{r}
CapacityPlot.Lower
```
</div>

<div id="T0combined" class="tab-pane">
```{r}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#R0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#R0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="R0mean" class="tab-pane active">
```{r sensitivity-R0-code, include=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_mean <- ABC.par.stats[1,1]
R0_sd <- ABC.par.stats[2,1]
R0_upper <- R0_mean + 1.96*R0_sd
R0_lower <- R0_mean - 1.96*R0_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_mean)
TEST.upper <- get.param.CI(R0_upper)
TEST.lower <- get.param.CI(R0_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r}
CapacityPlot.Mean
```
</div>

<div id="R0upper" class="tab-pane">
```{r}
CapacityPlot.Upper
```
</div>

<div id="R0lower" class="tab-pane">
```{r}
CapacityPlot.Lower
```
</div>

<div id="R0combined" class="tab-pane">
```{r}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

<div id="sensFracR0" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#fracR0mean"><b>Mean</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0upper"><b>upper 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0lower"><b>lower 95% CI</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#fracR0combined"><b>Combined</b></a>
</li>

</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="fracR0mean" class="tab-pane active">
```{r sensitivity-R0redux-code, include=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_redux_mean <- ABC.par.stats[1,4]
R0_redux_sd <- ABC.par.stats[2,4]
R0_redux_upper <- R0_redux_mean + 1.96*R0_redux_sd
R0_redux_lower <- R0_redux_mean - 1.96*R0_redux_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0_redux){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_redux_mean)
TEST.upper <- get.param.CI(R0_redux_upper)
TEST.lower <- get.param.CI(R0_redux_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

CapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

CapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r}
CapacityPlot.Mean
```
</div>

<div id="fracR0upper" class="tab-pane">
```{r}
CapacityPlot.Upper
```
</div>

<div id="fracR0lower" class="tab-pane">
```{r}
CapacityPlot.Lower
```
</div>

<div id="fracR0combined" class="tab-pane">
```{r}
CapacityPlot.Combined
```
</div>

</div>
</div>
</div>

</div>
</div>

# Model as a tool for future intervention scenario planning

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov1tab1"><b>0%</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov1tab2"><b>25%</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov1tab1" class="tab-pane active">

<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab1"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab2"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab1" class="tab-pane active">
```{r code-return-to-normal-May-100, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 200, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)


## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r}
R0_redux_100_May1_plot
```
</div>

<div id="scenariov2tab2" class="tab-pane">
```{r code-return-to-normal-June-100, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON JUNE 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 225, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r}
R0_redux_100_June1_plot
```
</div>

</div>
</div>

</div>

<div id="scenariov1tab2" class="tab-pane">
<div>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">

<li class="nav-item active">
<a class="nav-link active" data-toggle="tab" href="#scenariov2tab3"><b>May</b></a>
</li>

<li class="nav-item">
<a class="nav-link" data-toggle="tab" href="#scenariov2tab4"><b>June</b></a>
</li>


</ul>

<!-- Tab panes -->
<div class="tab-content">
<div id="scenariov2tab3" class="tab-pane active">
```{r code-return-to-normal-May-75, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)
```

```{r}
R0_redux_75_May1_plot
```
</div>

<div id="scenariov2tab4" class="tab-pane">
```{r code-return-to-normal-June-75, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r}
R0_redux_75_June1_plot
```
</div>

</div>
</div>
</div>

</div>
</div>

