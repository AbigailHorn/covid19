---
title: "Predictive Epidemic Model for LA County"
author: "Abigail Horn, Lai Jiang, Wendy Cozen, David Conti, \n Department of Preventive Medicine, \n USC"
date: "4/10/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Note: Please use the tabs to navigate through output files

```{r setup, include=FALSE}
### Install necessary packages and get started

library(reshape2)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggrepel)
library(bindata)
library(odin)
library(fitR)
library(knitr)
library(EasyABC)
library(dplyr)
library(gridExtra)
library(odin)
library(lubridate)
library(EasyABC)
library(dplyr)
library(gridExtra)
library(kableExtra)
library(here)
library(fs)
library(dde)

lang_output <- function(x, lang) {
  cat(c(sprintf("```%s", lang), x, "```"), sep = "\n")
}
r_output <- function(x) lang_output(x, "r")
knitr::opts_chunk$set(
  fig.width = 9,
  fig.height = 7)
```

# (1) Aims of our modeling:
- To estimate the number of individuals hospitalized, in the ICU, on ventilators (to be added), and deaths over time in Los Angeles County as a whole and by service area (SPA)
- To develop a modeling framework for scenario planning around different interventions in LA County

# (2) Methods summary

## (2.1) Model contributions

### The incorporation of risk factors (age, sex, and other comorbidities) in the estimation of model parameter inputs 
- This includes in the estimation of the conditional effects for each risk factor and in the weighting of these risks by the population prevalence of combinations of these risk factors within LA County, and by SPA

### Dynamic $R0$ / infectivity rate
- Looking back: Enables us to estimate the effect of social distancing interventions on spreading rate, based on observed data
- Looking forward: Enables scenario planning 

### Direct incorporation of parameter $r$: fraction of cases reported
- Allows us to estimate this fraction directly from the model

### Stochastic model: 
- Deterministic model: for given values of parameters, dynamics across compartments will be fixed. 
- Stochastic model: Appropriate probability distributions are used model the transfer of individuals across
compartments.

What a stochastic model allows:

- Looking back: Provides a better framework for parameter estimation, based on observed data 
- Looking forward: Enables forecasts with confidence bounds that account for variability in parameters

### Approximate Bayesian Computation (ABC) for parameter estimation: 
- Allows us to incorporate the uncertainty in all the parameters in fitting the model to data and estimating parameters
- Allows us to include all prior information and/or assumptions about the distribution (the range of values) for each parameter
- Allows us to prioritize data input that is more reliable in fitting the model to data (e.g., not including more unreliable early illness count data)

## (2.2) Model overview

### Flow diagram

### System of Equations
$$
\begin{align*}
    dS/dt &= -\beta S(I+A)\\
    dE/dt &= \beta S(I+A) - \tfrac{1}{d_{EI}}E\\
    dA/dt &= \tfrac{1-r}{d_{EI}}E - \tfrac{1}{d_{IR}}A\\
    dI/dt &= \tfrac{r}{d_{EI}}E - (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I\\
    dH/dt &= \alpha (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I - (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H \\
    dQ/dt &= \kappa (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H - (\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q \\
    dV/dt &= p_V Q\\
    dD/dt &= \delta (\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q\\
    dR/dt &= (1-\alpha) (\tfrac{\alpha}{d_{IH}}\tfrac{1-\alpha}{d_{IR}})I + (1-\kappa) (\tfrac{\kappa}{d_{HQ}}\tfrac{1-\kappa}{d_{HR}})H + (1-\delta)(\tfrac{\delta}{d_{QD}}\tfrac{1-\delta}{d_{QR}})Q + \tfrac{1}{d_{IR}}A   \
\end{align*}
$$

$$
R0 = \beta ({\frac{r}{\tfrac{\alpha}{d_{IH}}+\tfrac{1-\alpha}{d_{IR}}}+ (1-r){d_{IR}}})
\\
N=S+E+A+I+H+Q+D+R
$$


### Model parameters

| Parameter | Description                                                       | Value                                     |
|-----------|-------------------------------------------------------------------|-------------------------------------------|
| $R0$      | Basic reproductive number                                         | Estimated                                 |
| $\beta$   | transmission rate                                                 | Analytically derived from model and R0    |
| $d_{EI}$  |  days between exposure and infectivity   (incubation period)      | 5 days                                    |
| $d_{IH}$  | days between symptom onset and  hospitalization (if required)     | 10 days                                   |
| $d_{IR}$  | days between symptom onset and  recovery (if not hospitalized)    | 7 days                                    |
| $d_{HQ}$  | days between hospitalization and  ICU (if required)               | 1 days                                    |
| $d_{QR}$  | days between hospitalization and  recovery (if ICU not required)  | 12 days                                   |
| $d_{QD}$  | days between ICU and fatality                                     | 8 days                                    |
| $d_{QR}$  | days between ICU and recovery                                     | 7 days                                    |
| $\alpha$  | probability infected (I) requires  hospitalization (vs. recovers) | Estimated                                 |
| $\kappa$  | probability hospitalized (H)  requires ICU (vs. recovers)         | Estimated                                 |
| $\delta$  | probability ICU (Q) patient dies                                  | Estimated                                 |
| $p_V$     |  probability ventilation (V) required  given ICU                  | Estimated                                 |
| $N$       | Total population size                                             |                                           |
| $S$       | Susceptible population                                            |                                           |
| $E$       | Exposed not yet infectious                                        |                                           |
| $A$       | Infected, unobserved                                              |                                           |
| $I$       | Infected, observed                                                |                                           |
| $H$       | In Hospital                                                       |                                           |
| $Q$       | In ICU                                                            |                                           |
| $V$       | On ventilator                                                     |                                           |
| $D$       | Dead                                                              |                                           |
| $R$       | Recovered/removed                                                 |                                           |


### Model parameters - fixed, taken from literature:
- Transition times between compartments
- Sources provided at [this link](https://docs.google.com/spreadsheets/d/1PQttOS0VllpDGZswngMBIX5GMV2cMAxyseD3L-aNw-U/edit#gid=1798107562)

### Model Parameters â€” estimated through ABC (results in following section)
- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are observed
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness
- $\kappa$, the probability of ICU care necessary given hospitalization
- $p_v$, the probability of ventilation given ICU care
- $\delta$, the probability of death given ICU care

### Illness case data

- We use current numbers of infected, hospitalized, ICU, ventilated, and fatal cases from Faith Washburn's nightly reports
- The data used in this version of the report (April 10th, 2020) includes counts up through **April 7th, 2020**





# (3) Results

## (3.1) Results - parameter estimates {.tabset}
In this section we focus on parameter estimates for key epidemic and model quantities: 

- $R0$, the reproductive number or average number of new infections generated by an infected person in a completely susceptible population
- $r$, the proportion of illnesses that are observed
- $Frac_{R0}$, the reduction in the initial R0 due to social distancing
- $\alpha$, the probability of hospitalization given illness
- $\kappa$, the probability of ICU care necessary given hospitalization
- $p_v$, the probability of ventilation given ICU care
- $\delta$, the probability of death given ICU care


```{r calc-risk-probs, include=FALSE}

source(here("code/calc_risk_probs_update.R"))


Alpha.prior.mean <- risk.probs.SPAs[9,1]
Kappa.prior.mean <- risk.probs.SPAs[9,2]
Delta.prior.mean <- risk.probs.SPAs[9,3]

```

```{r read-in-model-and-data, include=FALSE}

###################################################################################################
## READ IN EPIDEMIC MODEL CODE
code.dir=here("/code/")
path_seihqdr_model <- path(code.dir, "stochastic_SEIHQDR_A.R")
r_output(readLines(path_seihqdr_model))

## Compile the model
seihqdr_generator <- odin::odin(path_seihqdr_model)

###################################################################################################
## INPUT DATA
# obs_cum_new_counts: cumulative counts for "Htotcum","D","Vcum","Idetectcum","H_new","D_new"
# no_obs: number of observation days
## Read and process the data

obs_cum_new_counts = t(read.csv(here("data", "cum_counts_040920.csv"), sep=",",stringsAsFactors = FALSE)) 
colnames<-c("Htotcum","D","Vcum","Idetectcum","H_new","D_new","H_capacity","Q_capacity")
colnames(obs_cum_new_counts) <- colnames
obs_cum_new_counts <- as.data.frame(obs_cum_new_counts)
obs_cum_new_counts <- obs_cum_new_counts[-1,]
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.character)
obs_cum_new_counts[1:8] <- sapply(obs_cum_new_counts[1:8],as.numeric)
no_obs <- dim(obs_cum_new_counts)[1]
#capacity_H_Q <- obs_cum_new_counts[,c(7:8)]
#obs_cum_new_counts <- obs_cum_new_counts[,c(1:6)]

step <- c(1:no_obs)
obs.shift <- cbind(step,obs_cum_new_counts)
data = obs.shift

```


```{r ABC-parameter-estimation, include=FALSE}

###################################################################################################
## "SUMMARY STATISTICS": 
## The cumulative number of cases at all (trusted) time points

sum.stats <- function(data){
  
  no_obs <- dim(data)[1]
  
  # Which values of variables to consider
  I.trust.n <- c(10:no_obs)  # The first 9 days of illness cases are unreliable/unavailable
  H.trust.n <- c(17:no_obs)  # The first 16 days of hospitalizations are unreliable/unavailable
  V.trust.n <- c(19:no_obs)  # The first 18 days of ventilation are unreliable/unavailable
  D.trust.n <- c(18:no_obs)  # The first 17 days of mortality are unreliable/unavailable
  Hnew.trust.n <- c(19:no_obs) # The first 18 days of new hospitalizations are unreliable/unavailable
  Dnew.trust.n <- c(28:no_obs) # The first 28 days of new deaths are unreliable/unavailable
  
  ss.I <- data$Idetectcum[I.trust.n]
  ss.H <- data$Htotcum[H.trust.n]
  ss.V <- data$Vcum[V.trust.n]
  ss.D <- data$D[D.trust.n]
  ss.Hnew <- data$H_new[Hnew.trust.n]
  ss.Dnew <- data$D_new[Dnew.trust.n]
  
  # Which variables to consider
  summarystats = c(ss.I, ss.H, ss.V, ss.D, ss.Hnew, ss.Dnew)   
  
  return(summarystats)
}

## SUMMARY STATISTICS COMPUTED ON DATA
summarydata <- sum.stats(data)
summarydata

###################################################################################################
## SIMULATION MODEL FUNCTION TO COMPUTE
## A function implementing the model to be simulated
## It must take as arguments a vector of model parameter values par
## and it must return a vector of summary statistics

model.1sim.stats <- function(par){
  
  R0 <- par[1]
  r <- par[2]
  start_time <- par[3]
  R0_redux <- par[4]
  Delta <- par[5]
  Alpha <- par[6]
  Kappa <- par[7]
  p_V <- par[8]
  
  ### EPIDEMIC MODEL INPUTS
  d_IH <- 10   #days between illness onset and hospitalization
  d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
  Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )
  
  ### GENERATE SIMULATION
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7, E_ini=10, r=r, Delta=Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  st <- start_time
  one_sim <- as.data.frame(x$run(0:(st+no_obs))[(st+1):(st+no_obs),])    
  
  ### SUMMARY STATISTICS COMPUTED ON MODEL OUTPUT:
  summarymodel <- sum.stats(one_sim)
  
  return(summarymodel)
}


###################################################################################################
## PRIOR DISTRIBUTIONS
## A list joining the prior for each parameter
prior.R0 <- c("normal",2.7,0.3) #prior.R0 <- c("unif",2,3)
prior.r <- c("unif",0.05,0.3)
prior.st <- c("unif",30,100)
prior.R0.redux <- c("unif",0.3,0.55)
prior.Delta <- c("unif",0.2,0.8)
prior.Alpha <- c("unif",Alpha.prior.mean - (Alpha.prior.mean/6), Alpha.prior.mean + (Alpha.prior.mean/2))
prior.Kappa <- c("unif",Kappa.prior.mean - (Kappa.prior.mean/6), Kappa.prior.mean + (Kappa.prior.mean/2))
prior.p_V <- c("unif",0.6,0.9)
prior.par <- list(prior.R0, prior.r,prior.st,prior.R0.redux,prior.Delta,prior.Alpha,prior.Kappa,prior.p_V)

## OTHER INPUTS
tolerance=c(15,4) # defining the sequence of tolerance levels 

###################################################################################################
## RUN ABC ALGORITHM
ABC_Wegmann<-ABC_mcmc(method="Wegmann",model=model.1sim.stats,prior=prior.par,
                      summary_stat_target=summarydata, n_calibration=2000,
                      tolerance_quantile=0.1,verbose=TRUE,progress=TRUE)

# ABC_Marjoram<-ABC_mcmc(method="Marjoram",model=model.1sim.stats,prior=prior.par,
#                       summary_stat_target=summarydata, n_calibration=1000,
#                       tolerance_quantile=0.1,verbose=TRUE,progress=TRUE) # running ABC_mcmc


#ABC_out <- ABC_Marjoram
ABC_out <- ABC_Wegmann

ABC.par.out <- as.data.frame(ABC_out$param)

###################################################################################################
## STATS ON POSTERIOR PARAMETER DISTRIBUTIONS
ABC.mean <- ABC.par.out %>% summarise_if(is.numeric, mean)
ABC.sd <- ABC.par.out %>% summarise_if(is.numeric, sd)
ABC.par.stats <- as.data.frame(rbind(ABC.mean,ABC.sd))
colnames(ABC.par.stats)<-c("R0","Prop. cases observed","Start time", "R0 reduction","Pr(Death)","Pr(Hospital)","Pr(ICU)","Pr(Ventilation)")
rownames(ABC.par.stats)<-c("mean","sd")
ABC.par.stats
#ABC.par.stats %>% round(ABC.par.stats,4)

## Plot with ggplot
out_R0<- as.data.frame(cbind(ABC_out$param[,1],ABC_out$weights))
out_r<- as.data.frame(cbind(ABC_out$param[,2],ABC_out$weights))
out_st<- as.data.frame(cbind(ABC_out$param[,3],ABC_out$weights))
out_R0redux<- as.data.frame(cbind(ABC_out$param[,4],ABC_out$weights))
out_Delta<- as.data.frame(cbind(ABC_out$param[,5],ABC_out$weights))
out_Alpha<- as.data.frame(cbind(ABC_out$param[,6],ABC_out$weights))
out_Kappa<- as.data.frame(cbind(ABC_out$param[,7],ABC_out$weights))
out_p_V<- as.data.frame(cbind(ABC_out$param[,8],ABC_out$weights))

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

# p1=ggplot(out_R0, aes(V1)) + geom_density() + xlab("R0")  #(aes(weight=V2)) #+ geom_density(aes(weight=V1))
# p2=ggplot(out_r, aes(V1)) + geom_density() + xlab("proportion of cases observed")
# p3=ggplot(out_st, aes(V1)) + geom_density() + xlab("start time")
# p4=ggplot(out_R0redux, aes(V1)) + geom_density() + xlab("R0 fraction reduction")
# p5=ggplot(out_Delta, aes(V1)) + geom_density() + xlab("Pr(Death)")
# p6=ggplot(out_Alpha, aes(V1)) + geom_density() + xlab("Pr(Hospitalization)")
# p7=ggplot(out_Kappa, aes(V1)) + geom_density() + xlab("Pr(ICU)")
# p8=ggplot(out_p_V, aes(V1)) + geom_density() + xlab("Pr(Ventilator)")

```

### Summary of estimated parameters
```{r estimated-par, echo=FALSE}

kable(ABC.par.stats) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

### $R0$ Reproductive number 

* Mean = `r round(ABC.par.stats$R0[1],3)`
* Standard deviation = `r round(ABC.par.stats$R0[2],3)`

```{r posterior-R0, echo=FALSE}

x1 <- seq(1.0,4,length=50)
y1 <- dnorm(x1, mean=2.7, sd=0.3)
d1 <- data.frame(x1,y1)
p1 <- ggplot(d1, aes(x=x1, y=y1)) +
  geom_line()+ylab("density")+xlab("R0 Prior")+ggtitle("R0 Assumed Prior Distribution") 

p=ggplot(out_R0, aes(V1)) + geom_density() + xlab("R0 Posterior Distribution") +xlim(1,4) + ggtitle("R0 Model Estimated Posterior Distribution") 

grid.arrange(p1,p,ncol=2,nrow=1)

```


### $r$ proportion of observed illnesses 

* Mean = `r round(ABC.par.stats[1,2],3)`
* Standard deviation = `r round(ABC.par.stats[2,2],3)`

```{r posterior-r, echo=FALSE}

x2 <- seq(0,0.5,length=50)
y2 <- dunif(x2, .05, 0.3)
d2 <- data.frame(x2,y2)
p2 <- ggplot(d2, aes(x=x2, y=y2)) +
  geom_line()+ylab("density")+xlab("Proportion Unreported Prior")+ggtitle("Proportion Reported Cases: Assumed Prior Distribution")


p=ggplot(out_r, aes(V1)) + geom_density() + xlab("Proportion Reported Posterior") +xlim(0,.5) + ggtitle("Proportion Reported Cases: Model Estimated Posterior Distribution") 

grid.arrange(p2,p,ncol=2,nrow=1)

```


### $Frac_{R0}$, the reduction in the initial R0 due to social distancing

* Mean = `r round(ABC.par.stats[1,4],3)`
* Standard deviation = `r round(ABC.par.stats[2,4],3)`


**Information informing this parameter's prior distribution:**
- Reduction in mobility observed in LA County:

**Source**: [Assessing changes in commuting and individual mobility
in major metropolitan areas in the United States during
the COVID-19 outbreak](https://www.mobs-lab.org/uploads/6/7/8/7/6787877/assessing_mobility_changes_in_the_united_states_during_the_covid_19_outbreak.pdf)

- Our modeled reduction in R0 timeline:
```{r posterior-R0-timeline, echo=FALSE}

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
p <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01"))) # date_labels = "%b %d %Y")+ggtitle("Reduction in R0 over time, following observed data)
p
```

```{r posterior-R0-redux, echo=FALSE}
x4 <- seq(.15,.7,length=50)
y4 <- dunif(x4, .3, .55)
d4 <- data.frame(x4,y4)
p4 <- ggplot(d4, aes(x=x4, y=y4)) +
  geom_line()+ylab("density")+xlab("R0 Fraction Reduction Prior")+ggtitle("R0 Fraction Reduction: Assumed Prior")

p=ggplot(out_R0redux, aes(V1)) + geom_density() + xlab("R0 Fraction Reduction Posterior") +xlim(.2,.7) + ggtitle("R0 Fraction Reduction: Posterior") 

grid.arrange(p4,p,ncol=2,nrow=1)

```

### $\alpha$, the probability of hospitalization given illness

* Mean = `r round(ABC.par.stats[1,6],3)`
* Standard deviation = `r round(ABC.par.stats[2,6],3)`

```{r posterior-alpha, echo=FALSE}

x6 <- seq(.05,.5,length=50)
y6 <- dunif(x6, Alpha.prior.mean - (Alpha.prior.mean/6), Alpha.prior.mean + (Alpha.prior.mean/2))
d6 <- data.frame(x6,y6)
p6 <- ggplot(d6, aes(x=x6, y=y6)) +
  geom_line()+ylab("density")+xlab("Pr(Hospitalization) Prior")+ggtitle("Pr(Hospitalization): Assumed Prior Distribution")

p=ggplot(out_Alpha, aes(V1)) + geom_density() + xlab("Pr(Hospitalization) Posterior") +xlim(.05,.5) + ggtitle("Pr(Hospitalization) Posterior Distribution") 

grid.arrange(p6,p,ncol=2,nrow=1)

```
     
### $\kappa$, the probability of ICU care necessary given hospitalization        

* Mean = `r round(ABC.par.stats[1,7],3)`
* Standard deviation = `r round(ABC.par.stats[2,7],3)`

```{r posterior-kappa, echo=FALSE}

x7 <- seq(.15,.7,length=50)
y7 <- dunif(x7, Kappa.prior.mean - (Kappa.prior.mean/6), Kappa.prior.mean + (Kappa.prior.mean/2))
d7 <- data.frame(x7,y7)
p7 <- ggplot(d7, aes(x=x7, y=y7)) +
  geom_line()+ylab("density")+xlab("Pr(ICU) Prior")+ggtitle("Pr(ICU): Assumed Prior Distribution")

p=ggplot(out_Kappa, aes(V1)) + geom_density() + xlab("Pr(ICU) Posterior") +xlim(.15,.7) + ggtitle("Pr(ICU) Posterior Distribution") 

grid.arrange(p7,p,ncol=2,nrow=1)

```

### $\delta$, the probability of death given ICU care

* Mean = `r round(ABC.par.stats[1,5],3)`
* Standard deviation = `r round(ABC.par.stats[2,5],3)`

```{r posterior-delta, echo=FALSE}

x5 <- seq(.15,.9,length=50)
y5 <- dunif(x5, .2, .8)
d5 <- data.frame(x5,y5)
p5 <- ggplot(d5, aes(x=x5, y=y5)) +
  geom_line()+ylab("density")+xlab("Pr(Death) Prior")+ggtitle("Pr(Death): Assumed Prior Distribution")

p=ggplot(out_Delta, aes(V1)) + geom_density() + xlab("Pr(Death) Posterior") +xlim(.15,.9) + ggtitle("Pr(Death) Posterior Distribution") 

grid.arrange(p5,p,ncol=2,nrow=1)

```


### $p_v$, the probability of ventilation given ICU care {.tabset}

* Mean = `r round(ABC.par.stats[1,8],3)`
* Standard deviation = `r round(ABC.par.stats[2,8],3)`

```{r posterior-p_V, echo=FALSE}

x8 <- seq(.4,.95,length=50)
y8 <- dunif(x8, 0.6,0.9)
d8 <- data.frame(x8,y8)
p8 <- ggplot(d8, aes(x=x8, y=y8)) +
  geom_line()+ylab("density")+xlab("Pr(Ventilation) Prior")+ggtitle("Pr(Ventilation): Assumed Prior Distribution")

p=ggplot(out_p_V, aes(V1)) + geom_density() + xlab("Pr(Ventilation) Posterior") +xlim(.4,.95) + ggtitle("Pr(Ventilation) Posterior Distribution") 

grid.arrange(p8,p,ncol=2,nrow=1)

```

## {-}

## (3.2) Results - Model forecasts {.tabset}
All forecasts based on stochastic model with mean value of estimated parameter distributions as input

### Demonstrating model fit against data: available data

**Demonstrating model fit against data, for availble variables:**

- Detected illnesses, cumulative = Idetectcum
- Hospitalizations, cumulative = Htotcum
- Deaths, cumulative = D
- Ventilation, cumulative = V
- Hospitalization, daily new incidence = H_new
- Deaths, daily new incidence = D_new

```{r model-forecasts, include=FALSE}
##############################################
## MODEL PROJECTIONS WITH ESTIMATED PARAMETERS
##############################################

### ABC PARAMETER ESTIMATES
R0 <- ABC.par.stats[1,1]
r <- ABC.par.stats[1,2]
start_time <- ABC.par.stats[1,3]
R0_redux <- ABC.par.stats[1,4]
Delta <- ABC.par.stats[1,5]
Alpha <- ABC.par.stats[1,6]
Kappa <- ABC.par.stats[1,7]
p_V <- ABC.par.stats[1,8]

## MODEL INPUTS REQUIRED HERE
d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
#Beta_t<- c(0, 79, 80, 260, 270, 500)
#Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )  #c(rep(Br,6))
Beta_t<- c(0, (start_time+11), (start_time+25), 180, 260, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux )


## COMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

## SIMULATE AND PLOT ZOOMED
TEST<-as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
testDataOnly<-plotTraj(traj = TEST, data= obs.shift[,1:7], state.names = c("Idetectcum","Htotcum","D","Vcum","H_new","D_new"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r PLOT-model-fit-data-only, echo=FALSE}

testDataOnly

```

### Demonstrating model fit across all variables

```{r model-fit-all, include=FALSE}

TEST<-as.data.frame(plyr::rdply(500, x$run(0:200)[(st):(st+no_obs-1),]))
testAllVariablesShort<-plotTraj(traj = TEST[,c(2:ncol(TEST))], data= obs.shift[,1:7], time.column ="step",summary=TRUE, init.date = initDatePlot)

## SIMULATE AND PLOT LONGER TIME SERIES
TEST<-as.data.frame(plyr::rdply(500, x$run(0:300)))
testAllVariablesLong <- plotTraj(traj = TEST[,c(2:ncol(TEST))], data= obs.shift[,1:7], time.column ="step",summary=TRUE, init.date = initDatePlot)

```

**Plotting model fit against data across all variables, only across available data time window**
```{r PLOT-model-fit-all-variables-short, echo=FALSE}
testAllVariablesShort
```

**Plotting model fit against data across all variables, across full epidemic time course**
```{r PLOT-model-fit-all-variables-long, echo=FALSE}
testAllVariablesLong
```

### Peak hospitalization, ICU, ventilation vs. capacity
```{r model-vs-capacity, include=FALSE}

## SIMULATE AND PLOT AGAINST CAPACITY
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)

capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
testCapacityPlot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)


```

**Plotting total number at any point in time in Hospital, ICU, Ventilation**

If everything continues as is, model projections forecast that:

- The peak of the epidemic will be around the beginning of July
- LA County will not come close to exceeding hospital capacity
- ICU capacity may be exceeded around the peak of the epidemic

The black lines in this plot indicates capacity
```{r PLOT-capacity, echo=FALSE}
testCapacityPlot
```

## {-}

## (3.3) Results - Sensitivity of model projections to parameter estimates {.tabset}
In this section we demonstrate projections for Hospitalization (H), ICU (Q), and Ventilation (V) needs given the mean and 95% upper and lower confidence bounds around each parameter estimate

### Sensitivity analysis: Mean, 95% Upper and Lower CI for $T0$ start time

```{r sensitivity-T0-code,include=FALSE}

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
st_mean <- ABC.par.stats[1,3]
st_sd <- ABC.par.stats[2,3]
st_upper <- st_mean + 1.96*st_sd
st_lower <- st_mean - 1.96*st_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(st){
  
start_time <- st  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(st_mean)
TEST.upper <- get.param.CI(st_upper)
TEST.lower <- get.param.CI(st_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

  ## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

testCapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

**Start time = mean (`r st_mean`)**
```{r sensitivity-T0-plot1, echo=FALSE}
testCapacityPlot.Mean
```

**Start time = upper 95% CI (`r st_upper`)**
```{r sensitivity-T0-plot2, echo=FALSE}
testCapacityPlot.Upper
```

**Start time = lower 95% CI (`r st_lower`)**
```{r sensitivity-T0-plot3, echo=FALSE}
testCapacityPlot.Lower
```

**Start time = combined mean, upper, and lower 95% CI**
```{r sensitivity-T0-plot4, echo=FALSE}
testCapacityPlot.Combined
```



### Sensitivity analysis: Mean, 95% Upper and Lower CI for $R0$ Reproductive number 

```{r sensitivity-R0-code, include=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_mean <- ABC.par.stats[1,1]
R0_sd <- ABC.par.stats[2,1]
R0_upper <- R0_mean + 1.96*R0_sd
R0_lower <- R0_mean - 1.96*R0_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_mean)
TEST.upper <- get.param.CI(R0_upper)
TEST.lower <- get.param.CI(R0_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

testCapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

**R0 = mean (`r R0_mean`)**
```{r sensitivity-R0-plot1, echo=FALSE}
testCapacityPlot.Mean
```

**R0 = upper 95% CI (`r R0_upper`)**
```{r sensitivity-R0-plot2, echo=FALSE}
testCapacityPlot.Upper
```

**R0 = lower 95% CI (`r R0_lower`)**
```{r sensitivity-R0-plot3, echo=FALSE}
testCapacityPlot.Lower
```

**R0 = combined mean, upper, and lower 95% CI**
```{r sensitivity-R0-plot4, echo=FALSE}
testCapacityPlot.Combined
```


### Sensitivity analysis: Mean, 95% Upper and Lower CI for $Frac_{R0}$, the reduction in the initial R0 due to social distancing

```{r sensitivity-R0redux-code, include=FALSE}


## OFFSET OBSERVED DATA BY START DATE
st <- start_time
step <- c(st:(st+no_obs-1))
obs.shift <- cbind(step,obs_cum_new_counts)
startObservedData <- as.Date(lubridate::ydm("2020-01-03"))
initDatePlot <- startObservedData-start_time

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)

## R0 95% CI
R0_redux_mean <- ABC.par.stats[1,4]
R0_redux_sd <- ABC.par.stats[2,4]
R0_redux_upper <- R0_redux_mean + 1.96*R0_redux_sd
R0_redux_lower <- R0_redux_mean - 1.96*R0_redux_sd

## RECOMPILE with R0_mean/upper/lower

get.param.CI <- function(R0_redux){
  
  Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
  Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+50), (start_time+100), 125, 500) #c(0, 79, 80, 260, 270, 500)
  Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux, Br*R0_redux)
  
  x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)
  length.runs <- 500
  TEST.out<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
  
  return(TEST.out)
}

TEST.mean <- get.param.CI(R0_redux_mean)
TEST.upper <- get.param.CI(R0_redux_upper)
TEST.lower <- get.param.CI(R0_redux_lower)
TEST.combined <- rbind(TEST.lower,TEST.upper,TEST.mean)

capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")

testCapacityPlot.Combined <- 
  plotTraj(traj = TEST.combined, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Upper <- 
  plotTraj(traj = TEST.upper, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Lower <- 
  plotTraj(traj = TEST.lower, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

testCapacityPlot.Mean <- 
  plotTraj(traj = TEST.mean, data= capacity_H_Q_V, state.names = c("H","Q","V"), 
           time.column ="step",summary=TRUE, init.date = initDatePlot)

```

**R0 reduction = mean (`r R0_redux_mean`)**
```{r sensitivity-R0rdx-plot1, echo=FALSE}
testCapacityPlot.Mean
```

**R0 reduction = upper 95% CI (`r R0_redux_upper`)**
```{r sensitivity-R0rdx-plot2, echo=FALSE}
testCapacityPlot.Upper
```

**R0 reduction = lower 95% CI (`r R0_redux_lower`)**
```{r sensitivity-R0rdx-plot3, echo=FALSE}
testCapacityPlot.Lower
```

**R0 = combined mean, upper, and lower 95% CI**
```{r sensitivity-R0rdx-plot4, echo=FALSE}
testCapacityPlot.Combined
```

## {-}

# (4) Illustration: Model as a tool for future intervention scenario planning
- Model projections forecast that, if everything continutes as is, LA is not going to see a sharp peak in illnesses in the near future, and rather will see a long, shallow, *manageable* epidemic curve over the next number of months.
- What can we do to maintain this manageable epidemic curve while sustaining a functioning society?
- This model can be used to evaluate the effect of scenarios relating to social distancing on the ultimate epidemic trajectory 

## Example scenarios: Relax social distancing to 25% / 0% reduction at beginning of May / June {.tabset}

### Scenario: Relax social distancing to a 25% reduction from the norm on May 1st

```{r code-return-to-normal-May-75, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
R0_redux_75_May1 <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01")))+
  ggtitle("R0(t) - increasing to 25% reduction by May 1st")

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r plot-return-to-normal-May-75, echo=FALSE}

R0_redux_75_May1
R0_redux_75_May1_plot

```

### Scenario: Relax social distancing to 25% reduction from the norm on June 1st

```{r code-return-to-normal-June-75, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO ONLY A 25% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 170, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br*.75, Br*.75, Br*.75)

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
R0_redux_75_June1 <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01")))+
  ggtitle("R0(t) - increasing to 25% reduction by June 1st")

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_75_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r plot-return-to-normal-June-75, echo=FALSE}

R0_redux_75_June1
R0_redux_75_June1_plot

```


### Scenario: Relax social distancing to 0% reduction on May 1st

```{r code-return-to-normal-May-100, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON MAY 1ST
intervention_date <- as.Date("2020-05-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 200, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
R0_redux_100_May1 <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01")))+
  ggtitle("R0(t) - increasing to 0% reduction by May 1st")

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_May1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r plot-return-to-normal-May-100, echo=FALSE}

R0_redux_100_May1
R0_redux_100_May1_plot

```

### Scenario: Relax social distancing to 0% reduction on June 1st

```{r code-return-to-normal-June-100, include=FALSE}

########################################################################
## SCENARIO: INCREASE R0 TO A 0% REDUCTION ON JUNE 1ST
intervention_date <- as.Date("2020-06-01")
intervention_date_numeric <- as.numeric(intervention_date) - as.numeric(startObservedData)

d_IH <- 10   #days between illness onset and hospitalization
d_IR <- 7    #days between illness onset and recovery (hospitalization not required)       
Alpha <- 0.14   #probability infected (I) requires hospitalization (vs. recovers)
Br <- R0 * ( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) 
Beta_t<- c(0, (start_time+11), (start_time+25), (start_time+intervention_date_numeric-1), (start_time+intervention_date_numeric+5), 175, 225, 500) #c(0, 79, 80, 260, 270, 500)
Beta_y<- c(Br, Br, Br*R0_redux, Br*R0_redux, Br, Br, Br, Br)

## Plot of R0(t)
R0_t_plot <- data.frame(
  day = as.Date(initDatePlot) + Beta_t,
  R0_t = round( Beta_y/(( 1 / ( (r/ ((Alpha/d_IH) + ((1-Alpha)/d_IR)))  + (1-r)*d_IR )) ), 3)
)
R0_redux_100_June1 <- ggplot(R0_t_plot, aes(x=day, y=R0_t)) +
  geom_line() + 
  xlab("Date") + ylab("R0(t)") + 
  scale_x_date(date_breaks = "1 month",limit=c(as.Date("2019-12-15"),as.Date("2020-08-01")))+
  ggtitle("R0(t) - increasing to 0% reduction by June 1st")

## RECOMPILE
x <- seihqdr_generator(Beta_t=Beta_t, Beta_y=Beta_y, S_ini=1e7,E_ini=10,r=r,Delta = Delta, Alpha=Alpha, Kappa=Kappa, p_QV=p_V)

## Test against capacity
length.runs <- 400
TEST<-as.data.frame(plyr::rdply(500, x$run(0:length.runs)))
capacity_H<-obs.shift[1,8]
capacity_Q<-obs.shift[1,9]
times.col<-c(0:length.runs)
capacity_H_vec <- rep(capacity_H,length.runs)
capacity_Q_vec <- c(12500, rep(capacity_Q,(length.runs-1)))
capacity_V_vec <- c(9000, rep(1000,(length.runs-1)))
capacity_H_Q_V <- as.data.frame(cbind(times.col,capacity_H_vec,capacity_Q_vec,capacity_V_vec))
colnames(capacity_H_Q_V)=c("step","H","Q","V")
R0_redux_100_June1_plot <- plotTraj(traj = TEST, data= capacity_H_Q_V, state.names = c("H","Q","V"), time.column ="step",summary=TRUE, init.date = initDatePlot)

```

```{r plot-return-to-normal-June-100, echo=FALSE}

R0_redux_100_June1
R0_redux_100_June1_plot

```

## {-}

# (5) Next steps
- Integrating high-resolution near-real-time data on mobility for Los Angeles to infer contact rates
- Interactive web tool
- Estimating affected populations
- What do you want to see here?


# Acknowledgements
- We would like to acknowledge Claire Jacquillat, data scientist, for her contributions related to data wrangling, cleaning, interpretation, and visualization.

# Appendix

A1. Calculating Pr(H), Pr(Q), Pr(H), based on age, gender, and population prevalences of risk factors
A2. Specification of stochastic model

## (A1) Calculating Pr(H), Pr(Q), Pr(H), based on age, gender, and population prevalences of risk factors

### Key risk profiles
```{r risk-prof-table, echo=FALSE}

Pr.D.FULL = read.table(here("data", "Ordinal.Age.DummyRiskProfile.Death.txt"), sep=" ", header=TRUE )

risk_profiles_FULL <- Pr.D.FULL[,-1]

#risk_profiles <- Pr.D[,-1]
kable(risk_profiles_FULL) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

### Population risk factor prevalences for LA County 
Data coming from [Los Angeles County Health Survey](http://www.publichealth.lacounty.gov/ha/hasurveyintro.htm) 

```{r readin2, echo=FALSE}

### Display table
kable(Pop.prevalence.format) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)


```

### Pr(H)
```{r prob-H, echo=FALSE}
### Probability of hospitalization by profile

Pr.H.print <- Pr.H %>% mutate(Pr = round(Pr,3)) 

kable(Pr.H.print) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Pr(Q)
```{r prob-Q, echo=FALSE}
### Probability of ICU, given hospitalization, by profile
Pr.Q.print <- Pr.Q %>% mutate(Pr = round(Pr,3)) 

kable(Pr.Q.print) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Pr(D)
```{r prob-D, echo=FALSE}
### Probability of death, given ICU, by profile

Pr.D.print <- Pr.D %>% mutate(Pr = round(Pr,3)) 

kable(Pr.D.print) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

### Frequency of each profile across the SPAs
```{r Pr_HQD_allSPAs, echo=FALSE}
kable(profile.cnt.SPAs) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

### Calculated risk probabilities 
- Probability of hospitalization = Pr(H)
- Probability of ICU, given hospitalization = Pr(Q)
- Probability of death, given ICU = Pr(D)
```{r calculated-risk-probabilities, echo=FALSE}
kable(risk.probs.SPAs) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```


## (A2) Specification of stochastic model
```{r stochastic-model}

r_output(readLines(path_seihqdr_model))


```

